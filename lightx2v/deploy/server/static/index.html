<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SekoTalk数字人服务</title>
    <link rel="icon" type="image/png" href="/icon/logoblack.png">
    <link rel="shortcut icon" type="image/png" href="/icon/logoblack.png">
    <link rel="apple-touch-icon" href="/icon/logoblack.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 主要图标库 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- 备用图标库 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <!-- 本地备用图标（如果CDN都失败） -->
    <link rel="stylesheet" href="/static/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#9a72ff', // 主紫色
                        secondary: '#1b1240', // 深紫色背景
                        accent: '#b78bff', // 亮紫色强调
                        dark: '#0b0a20', // 深色背景
                        'dark-light': '#0f0e22', // 稍亮的深色
                        'laser-purple': '#9a72ff', // 激光紫色
                        'neon-purple': '#b78bff', // 霓虹紫色
                        'electric-purple': '#7c6aff', // 电光紫色
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(154, 114, 255, 0.5), 0 0 20px rgba(154, 114, 255, 0.3)',
                        'neon-lg': '0 0 15px rgba(154, 114, 255, 0.7), 0 0 30px rgba(154, 114, 255, 0.5)',
                        'laser': '0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2)',
                        'laser-intense': '0 0 25px rgba(154, 114, 255, 0.9), 0 0 50px rgba(154, 114, 255, 0.7), 0 0 75px rgba(154, 114, 255, 0.5), 0 0 100px rgba(154, 114, 255, 0.3), 0 0 125px rgba(154, 114, 255, 0.1)',
                        'electric': '0 0 15px rgba(124, 106, 255, 0.8), 0 0 30px rgba(124, 106, 255, 0.6), 0 0 45px rgba(124, 106, 255, 0.4)'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">

        [v-cloak] { display: none; }
        
        /* 预检查登录状态，减少闪烁
        .login-container {
            display: var(--initial-login-state, block);
        } */
        /* 确保html和body能够正确填充 */
        html {
            height: 100%;
        }

        /* 确保body和app容器能够正确填充 */
        body {
            margin: 0;
            padding: 0;
            width: 125vw;
            height: 125vh;
            overflow-x: hidden;
            overflow-y: auto;
            /* 整体缩放80% */
            transform: scale(0.8);
            transform-origin: top left;
        }


        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            /* 新增渐变图标颜色类 */
            .text-gradient-icon {
                background: linear-gradient(135deg, #d2c1ff, #a88bff, #8e88ff);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 4px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: rgba(210, 193, 255, 0.6);
                border-radius: 2px;
            }

            /* 历史任务区域滚动条样式 - 与主内容区域保持一致 */
            .history-tasks-scroll::-webkit-scrollbar {
                width: 8px !important;
            }

            .history-tasks-scroll::-webkit-scrollbar-track {
                background: rgba(27, 18, 64, 0.3) !important;
                border-radius: 4px;
            }

            .history-tasks-scroll::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, rgba(210, 193, 255, 0.8), rgba(168, 139, 255, 0.8)) !important;
                border-radius: 4px;
                border: 1px solid rgba(210, 193, 255, 0.3);
            }

            .history-tasks-scroll::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, rgba(210, 193, 255, 1), rgba(168, 139, 255, 1)) !important;
            }

            /* 确保历史任务区域可以正常滚动 */
            .history-tasks-scroll {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
                /* 移除max-height限制，让flex-1占据所有可用空间 */
            }

            /* 主内容区域滚动条样式 */
            .content-area::-webkit-scrollbar {
                width: 8px;
            }

            .content-area::-webkit-scrollbar-track {
                background: rgba(27, 18, 64, 0.3);
                border-radius: 4px;
            }

            .content-area::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, rgba(210, 193, 255, 0.8), rgba(168, 139, 255, 0.8));
                border-radius: 4px;
                border: 1px solid rgba(210, 193, 255, 0.3);
            }

            .content-area::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, rgba(210, 193, 255, 1), rgba(168, 139, 255, 1));
            }

            /* 确保内容可以正常滚动 */
            .content-area {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 0.5) infinite;
            }
            .animate-electric-pulse {
                animation: electricPulse 1.5s ease-in-out infinite;
            }
            @keyframes electricPulse {
                0%, 100% {
                    box-shadow: 0 0 15px rgba(142, 136, 255, 0.8), 0 0 30px rgba(142, 136, 255, 0.6);
                    transform: scale(1);
                }
                50% {
                    box-shadow: 0 0 25px rgba(142, 136, 255, 1), 0 0 50px rgba(142, 136, 255, 0.8), 0 0 75px rgba(142, 136, 255, 0.4);
                    transform: scale(1.02);
                }
            }
            .bg-laser-gradient {
                background: linear-gradient(135deg, #d2c1ff 0%, #a88bff 25%, #8e88ff 50%, #d2c1ff 75%, #a88bff 100%);
                background-size: 200% 200%;
                animation: gradientShift 3s ease-in-out infinite;
            }
            @keyframes gradientShift {
                0%, 100% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
            }
            .text-laser-glow {
                text-shadow: 0 0 10px rgba(154, 114, 255, 0.8), 0 0 20px rgba(154, 114, 255, 0.6), 0 0 30px rgba(154, 114, 255, 0.4);
            }
            .border-laser {
                border-color: #d2c1ff;
                box-shadow: 0 0 15px rgba(154, 114, 255, 0.6), inset 0 0 15px rgba(154, 114, 255, 0.1);
            }
            .btn-primary{
                padding: 15px 25px;
                border-radius: 14px;
                font-weight: 500;
                font-size: 14px;
                letter-spacing: 0.2px;
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #d2c1ff, #a88bff, #8e88ff);
                border: 0;
                text-decoration: none;
                box-shadow: 0 10px 30px rgba(140, 110, 255, 0.4);
                transition: transform 0.15s ease, box-shadow 0.15s ease;
            }
            .btn-primary:hover{
                transform: translateY(-1px);
                box-shadow: 0 14px 40px rgba(140, 110, 255, 0.55);
            }

            /* 修复布局问题 */
            .task-type-btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                font-weight: 500;
                transition-property: color, background-color;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }

            .task-type-btn:hover {
                background-color: rgba(154, 114, 255, 0.1);
            }

            .model-selection {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .upload-section {
                display: grid;
                grid-template-columns: repeat(1, minmax(0, 1fr));
                gap: 1.5rem;
                margin-bottom: 1.5rem;
            }

            @media (min-width: 768px) {
                .upload-section {
                    grid-template-columns: repeat(2, minmax(0, 1fr));
                }
            }

            .upload-area {
                position: relative;
                border: 2px dashed rgba(154, 114, 255, 0.4);
                border-radius: 0.75rem;
                padding: 1.5rem;
                text-align: center;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
                cursor: pointer;
                background-color: rgba(27, 18, 64, 0.1);
                min-height: 250px; /* 确保上传区域有最小高度，防止预览时高度收缩 */
            }

            .upload-area:hover {
                border-color: rgba(154, 114, 255, 0.7);
                box-shadow: 0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2);
            }

            .upload-icon {
                margin: 0 auto;
                width: 4rem;
                height: 4rem;
                background-color: rgba(154, 114, 255, 0.2);
                border-radius: 9999px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 1rem;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }

            .upload-area:hover .upload-icon {
                background-color: rgba(154, 114, 255, 0.3);
            }

            /* 图片预览占据整个上传区域 */
            .image-preview {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                z-index: 10;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }

            .image-preview img {
                height: 100%;
                width: auto;
                max-width: 100%;
                display: block;
                margin: 0 auto;
                object-fit: contain;
                transition: all 0.3s ease;
            }

            /* 音频预览占据整个上传区域 */
            .audio-preview {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border-radius: 0.75rem;
                overflow: hidden;
                z-index: 10;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgba(154, 114, 255, 0.1);
                border: 2px solid rgba(154, 114, 255, 0.3);
                cursor: pointer;
            }

            .audio-preview audio {
                width: 90%;
                height: 60px;
                max-height: 80%;
                border-radius: 0.5rem;
                background-color: rgba(27, 18, 64, 0.3);
                display: block;
            }

            /* 确保音频控件在容器中正确显示 */
            .audio-preview audio::-webkit-media-controls {
                background-color: rgba(27, 18, 64, 0.5);
                border-radius: 0.5rem;
            }

            /* 上传内容样式 */
            .upload-content {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .btn-close {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                background-color: #ef4444;
                color: white;
                border-radius: 9999px;
                width: 1.5rem;
                height: 1.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.75rem;
                cursor: pointer;
                z-index: 20;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            /* 确保flexbox布局正确 */
            #app {
                display: flex;
                width: 100%;
                height: 100%;
            }

            .bg-linear-dark {
                background-color: linear-gradient(135deg, #0b0a20 0%, #1b1240 50%, #0f0e22 100%);
            }

            aside {
                flex-shrink: 0;
                width: 280px; /* 默认展开宽度 */
                min-width: 3rem; /* 最小宽度 */
                max-width: 500px; /* 最大宽度 */
                background-color: linear-gradient(135deg, #0b0a20 0%, #1b1240 50%, #0f0e22 100%);
                border-right: 1px solid rgba(154, 114, 255, 0.4);
                display: flex;
                flex-direction: column;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 300ms;
                z-index: 10;
                position: relative;
            }

            /* 拖拽调整器 */
            .resize-handle {
                position: absolute;
                top: 0;
                right: 0;
                width: 6px;
                height: 100%;
                background: transparent;
                cursor: col-resize;
                z-index: 50;
                transition: background-color 0.2s ease;
            }

            .resize-handle:hover {
                background: rgba(154, 114, 255, 0.5);
            }

            .resize-handle:active {
                background: rgba(154, 114, 255, 0.8);
            }

            /* 确保拖拽手柄可见 */
            .resize-handle::before {
                content: '';
                position: absolute;
                top: 50%;
                right: 1px;
                width: 2px;
                height: 20px;
                background: rgba(154, 114, 255, 0.3);
                transform: translateY(-50%);
                border-radius: 1px;
            }

            /* 拖拽时的视觉反馈 */
            .resizing {
                user-select: none;
                pointer-events: none;
            }

            .resizing * {
                pointer-events: none;
            }

            main {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 0;
                width: calc(100% - 280px); /* 主内容区域占据剩余宽度，适应展开的侧边栏 */
                height: 100%;
            }

            /* 内容区域全屏显示 */
            .content-area {
                flex: 1;
                overflow-y: auto;
                background-color: #0b0a20;
                padding: 2rem;
                width: 100%;
                min-height: 0; /* 确保flex子元素可以收缩 */
            }

            /* 任务创建面板全屏 */
            #task-creator {
                max-width: none;
                width: 80%;
                padding: 0 1rem;
            }

            #inspiration-gallery {
                max-width: none;
                width: 80%;
                padding: 0 1rem;
            }

            /* 任务详情面板全屏 */
            .task-detail-panel {
                max-width: none;
                width: 80%;
                padding: 0 0rem;
            }

            /* 上传区域全屏布局 */
            .upload-section {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
                margin-bottom: 2rem;
                width: 100%;
            }

            /* 任务类型选择全屏 */
            .task-type-selection {
                width: 100%;
                margin-bottom: 2rem;
            }

            .task-type-buttons {
                display: flex;
                width: 100%;
                border-bottom: 1px solid rgba(154, 114, 255, 0.3);
            }

            .task-type-btn {
                flex: 1;
                padding: 1rem 1.5rem;
                font-size: 1rem;
                font-weight: 500;
                transition-property: color, background-color;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
                text-align: center;
            }

            /* 模型选择全屏 */
            .model-selection {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                width: 100%;
                justify-content: flex-start;
            }

            /* 提示词输入全屏 */
            .prompt-input-section {
                width: 100%;
                margin-bottom: 2rem;
            }

            .prompt-textarea {
                width: 100%;
                min-height: 150px;
                resize: vertical;
            }

            /* 历史任务区域收起样式 */
            .sidebar-collapsed .history-tasks-section {
                display: none !important;
            }

            /* 侧边栏展开样式 */
            aside {
                width: 280px !important;
            }

            .sidebar-collapsed .sidebar-content {
                display: none !important;
            }

            .sidebar-collapsed .resize-handle {
                display: none !important;
            }

            .sidebar-collapsed .user-info-section {
                display: none !important;
            }

            .sidebar-collapsed .sidebar-header {
                justify-content: center;
                padding: 1rem 0.5rem;
            }

            .sidebar-collapsed .sidebar-header h1 {
                display: none;
            }

            /* 展开状态下显示所有内容 */
            aside:not(.sidebar-collapsed) .sidebar-content {
                display: flex !important;
            }

            aside:not(.sidebar-collapsed) .resize-handle {
                display: block !important;
            }

            aside:not(.sidebar-collapsed) .sidebar-header {
                justify-content: space-between;
                padding: 1rem;
            }

            aside:not(.sidebar-collapsed) .sidebar-header h1 {
                display: flex;
            }

            aside:not(.sidebar-collapsed) .sidebar-header .toggle-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
            }

            aside:not(.sidebar-collapsed) .user-info-section {
                display: block !important;
            }

            .sidebar-collapsed .sidebar-header .toggle-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 2rem;
                height: 2rem;
                border-radius: 0.375rem;
                background-color: rgba(154, 114, 255, 0.1);
                border: 1px solid rgba(154, 114, 255, 0.3);
                margin: 0 auto;
            }

            /* 当历史任务区域折叠时，主内容区域调整 */
            .sidebar-collapsed + main {
                width: calc(100% - 256px); /* 只减去固定区域的宽度 */
            }

            /* 当历史任务区域展开时，主内容区域调整 */
            aside:not(.sidebar-collapsed) + main {
                width: calc(100% - 256px); /* 减去侧边栏的宽度 */
            }

            /* 响应式设计 */
            @media (max-width: 1200px) {
                aside:not(.sidebar-collapsed) {
                    width: 250px !important;
                }

                .sidebar-collapsed + main {
                    width: calc(100% - 250px);
                }

                aside:not(.sidebar-collapsed) + main {
                    width: calc(100% - 250px);
                }
            }

            @media (max-width: 768px) {
                aside:not(.sidebar-collapsed) {
                    width: 200px !important;
                }

                .sidebar-collapsed + main {
                    width: calc(100% - 200px);
                }

                aside:not(.sidebar-collapsed) + main {
                    width: calc(100% - 200px);
                }

                .upload-section {
                    grid-template-columns: 1fr;
                }
            }


            /* 分页组件样式 */
            .pagination-container {
                border-bottom: 1px solid rgba(154, 114, 255, 0.15);
                padding-bottom: 0.5rem;
            }

            .pagination-btn-compact {
                @apply px-1.5 py-0.5 rounded text-xs transition-all duration-200;
                background: rgba(27, 18, 64, 0.2);
                border: 1px solid rgba(154, 114, 255, 0.2);
                color: rgba(255, 255, 255, 0.6);
                min-width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
            }

            .pagination-btn-compact:hover:not(.disabled) {
                background: rgba(154, 114, 255, 0.15);
                border-color: rgba(154, 114, 255, 0.4);
                color: rgba(255, 255, 255, 0.8);
                transform: translateY(-0.5px);
            }

            .pagination-btn-compact.active {
                background: linear-gradient(135deg, rgba(154, 114, 255, 0.6), rgba(168, 139, 255, 0.6));
                border-color: rgba(154, 114, 255, 0.6);
                color: white;
                box-shadow: 0 0 6px rgba(154, 114, 255, 0.4);
            }

            .pagination-btn-compact.disabled {
                opacity: 0.3;
                cursor: not-allowed;
                background: rgba(27, 18, 64, 0.05);
                border-color: rgba(154, 114, 255, 0.05);
                color: rgba(255, 255, 255, 0.2);
            }

            .pagination-btn-compact.disabled:hover {
                transform: none;
                background: rgba(27, 18, 64, 0.05);
                border-color: rgba(154, 114, 255, 0.05);
                color: rgba(255, 255, 255, 0.2);
            }

            /* 页码输入框样式 */
            .page-input {
                @apply w-8 h-5 text-center text-xs rounded;
                background: linear-gradient(135deg, rgba(154, 114, 255, 0.3), rgba(168, 139, 255, 0.3));
                border: 1px solid rgba(154, 114, 255, 0.4);
                color: white;
                outline: none;
                transition: all 0.2s ease;
                font-weight: 500;
            }

            .page-input:focus {
                border-color: rgba(154, 114, 255, 0.8);
                background: linear-gradient(135deg, rgba(154, 114, 255, 0.5), rgba(168, 139, 255, 0.5));
                box-shadow: 0 0 6px rgba(154, 114, 255, 0.4);
            }

            .page-input::-webkit-outer-spin-button,
            .page-input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .page-input[type=number] {
                -moz-appearance: textfield;
            }

            /* 修复状态指示器 */
            .status-indicator {
                width: 0.75rem;
                height: 0.75rem;
                border-radius: 9999px;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }

            /* 修复按钮样式 */
            .btn-primary {
                padding: 12px 22px;
                border-radius: 14px;
                font-weight: 700;
                letter-spacing: 0.2px;
                color: #0c0920;
                background: linear-gradient(135deg, #d2c1ff, #a88bff, #8e88ff);
                border: 0;
                text-decoration: none;
                box-shadow: 0 10px 30px rgba(140, 110, 255, 0.4);
                transition: transform 0.15s ease, box-shadow 0.15s ease;
                cursor: pointer;
                display: inline-block;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: 0 14px 40px rgba(140, 110, 255, 0.55);
            }

            /* 修复模型按钮样式 */
            .model-btn {
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
                cursor: pointer;
                border: 1px solid;
            }

            .model-btn.active {
                background-color: rgba(154, 114, 255, 0.2);
                border-color: rgba(154, 114, 255, 0.4);
                box-shadow: 0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2);
                animation: electricPulse 1.5s ease-in-out infinite;
            }

            /* 确保内容区域正确滚动 */
            .content-scroll {
                flex: 1;
                overflow-y: auto;
            }


            /* 任务进行中面板样式 */
            .task-running-panel .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 0.5) infinite;
            }

            /* 进度条样式 */
            .progress-container {
                background: rgba(27, 18, 64, 0.3);
                border-radius: 8px;
                padding: 1rem;
                margin: 1rem 0;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: rgba(154, 114, 255, 0.2);
                border-radius: 4px;
                overflow: hidden;
                position: relative;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #9a72ff, #a88bff);
                border-radius: 4px;
                transition: width 0.3s ease;
                position: relative;
            }

            .progress-fill::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                animation: shimmer 2s infinite;
            }

            @keyframes shimmer {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }

            .subtask-item {
                background: rgba(27, 18, 64, 0.2);
                border: 1px solid rgba(154, 114, 255, 0.2);
                border-radius: 8px;
                padding: 0.75rem;
                margin: 0.5rem 0;
            }

            .subtask-header {
                display: flex;
                justify-content: between;
                align-items: center;
                margin-bottom: 0.5rem;
            }

            .subtask-status {
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 500;
            }

            .subtask-status.pending {
                background: rgba(251, 191, 36, 0.2);
                color: #fbbf24;
            }

            .subtask-status.running {
                background: rgba(59, 130, 246, 0.2);
                color: #3b82f6;
            }

            .subtask-info {
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.6);
                margin-top: 0.25rem;
            }

            /* 任务失败面板样式 */
            .task-failed-panel .bg-red-500\/10 {
                background-color: rgba(239, 68, 68, 0.1);
            }

            .error-details {
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
                border-radius: 8px;
                padding: 1rem;
                margin: 1rem 0;
                text-align: left;
            }

            .error-details pre {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 4px;
                padding: 0.75rem;
                margin: 0.5rem 0 0 0;
                font-size: 0.75rem;
                color: #fca5a5;
                overflow-x: auto;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .subtask-error {
                background: rgba(239, 68, 68, 0.05);
                border-left: 3px solid #ef4444;
                padding: 0.75rem;
                margin: 0.5rem 0;
                border-radius: 0 4px 4px 0;
            }
            
            .subtask-error pre {
                background: #1a1a1a;
                border: 1px solid #dc2626;
                border-radius: 6px;
                padding: 12px;
                margin: 8px 0;
                color: #fca5a5;
                font-size: 12px;
                line-height: 1.4;
                white-space: pre-wrap;
                word-break: break-word;
                max-height: 200px;
                overflow-y: auto;
            }
            
            .error-details {
                animation: slideDown 0.3s ease-out;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }


            .task-detail-panel video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            /* 素材预览样式 */

            /* 任务状态指示器增强 */
            .status-indicator {
                position: relative;
            }

            .status-indicator::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 0.25rem;
                height: 0.25rem;
                background-color: currentColor;
                border-radius: 50%;
                opacity: 0.8;
            }


            /* 响应式任务面板 */
            @media (max-width: 768px) {
                .task-detail-panel {
                    padding: 0 0.5rem;
                }
            }

            /* 提示消息动画 */
            .animate-slide-down {
                animation: slideDown 0.3s ease-out;
            }

            @keyframes slideDown {
                0% {
                    opacity: 0;
                    transform: translate(-50%, -100%);
                }
                100% {
                    opacity: 1;
                    transform: translate(-50%, 0);
                }
            }

            /* 提示消息样式 - 统一浅色透明背景 */
            .alert {
                backdrop-filter: blur(15px);
                background: rgba(0, 0, 0, 0.8);
                border-radius: 0.75rem;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                color: #fff;
            }
        }
 
             
             .floating-toggle-btn {
                 position: fixed;
                 top: 50%;
                 left: 256px; /* 默认位置，对应 w-64 (256px) */
                 transform: translateY(-50%);
                 width: 20px;
                 height: 40px;
                 background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4e 50%, #1e1e3e 100%);
                 border: 1px solid rgba(139, 92, 246, 0.3);
                 border-left: none;
                 border-radius: 0 8px 8px 0;
                 color: #9ca3af;
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 cursor: pointer;
                 transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
                 z-index: 20;
                 box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
             }
             
             .floating-toggle-btn:hover {
                 background: linear-gradient(135deg, #2a2a4e 0%, #3a3a5e 50%, #2e2e4e 100%);
                 color: #8b5cf6;
                 box-shadow: 2px 0 12px rgba(139, 92, 246, 0.3);
             }
             
             .floating-toggle-btn.collapsed {
                 border-radius: 0 8px 8px 0;
                 border-left: 1px solid rgba(139, 92, 246, 0.3);
                 border-right: none;
             }
             
             .resizing .floating-toggle-btn {
                 transition: none !important;
             }
             
             /* 屏幕左侧发光区域 */
             .left-glow-zone {
                 position: fixed;
                 left: 0;
                 top: 0;
                 width: 8%;
                 height: 100%;
                 /* 发光中心在左侧正中，向右大范围发散，边缘透明 */
                 background: radial-gradient(ellipse 60% 80% at 0% 50%, 
                     rgba(200, 170, 255, 0.95) 0%, 
                     rgba(168, 139, 255, 0.55) 20%, 
                     rgba(154, 114, 255, 0.18) 50%, 
                     rgba(139, 92, 246, 0) 100%);
                 pointer-events: auto;
                 opacity: 0;
                 transition: opacity 0.3s ease;
                 z-index: 5;
                 filter: blur(8px);
             }
             
             .left-glow-zone.show-glow {
                 opacity: 1;
             }
             
             .history-section {
                 max-height: calc(100% - 200px);
                 border-radius: 0 12px 12px 0;
                 border: 2px solid rgba(139, 92, 246, 0.4);
                 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                 margin: 8px 8px 8px 0;
                 transition: all 0.3s ease;
                 cursor: pointer;
                 background: rgba(139, 92, 246, 0.05);
             }
             
             .history-section:hover {
                 background: rgba(139, 92, 246, 0.05) !important;
                 border-color: rgba(139, 92, 246, 0.15) !important;
                 box-shadow: 0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2);
                 transform: translateY(-2px);
             }
             
             .history-section:hover {
                 background: rgba(139, 92, 246, 0.08) !important;
             }
             
                   /* 修复任务项样式 */
            .task-item {
                border: 1px solid rgba(139, 92, 246, 0.3);
                padding: 0.75rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 200ms;
                transition: all 0.2s ease;
            }

            .task-item:hover {
                border: 1px solid rgba(167, 132, 255, 0.2);
                background-color: rgba(167, 132, 255, 0.2);
                transform: translateX(5px);
            }

            /* 任务操作菜单样式 */
            .task-menu-container {
                position: relative;
            }

            .task-menu-dropdown {
                animation: fadeInUp 0.2s ease-out;
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .task-menu-item {
                transition: all 0.2s ease;
            }

            .task-menu-item:hover {
                transform: translateX(2px);
            }

            /* 短信登录样式 */
            .sms-login-form {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                padding: 20px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                margin-top: 10px;
                animation: slideDown 0.3s ease-out;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .sms-login-form .form-control {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                border-radius: 8px;
                transition: all 0.3s ease;
                height: 50px;
                padding: 12px 16px;
                font-size: 16px;
                margin-right: 20px;
            }

            .sms-login-form .form-control:focus {
                background: rgba(255, 255, 255, 0.15);
                border-color: #007bff;
                box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
                color: white;
            }

            .sms-login-form .form-control::placeholder {
                color: rgba(255, 255, 255, 1.0);
            }

            .sms-login-form .btn-primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .sms-login-form .btn-primary {
                color: white;
                transition: all 0.3s ease;
                height: 50px;
                padding: 12px 20px;
                font-size: 16px;
                font-weight: 500;
            }
    </style>
</head>
<body
    class="bg-dark text-gray-100 font-inter"
>

    <div id="app" v-cloak>

        <!-- 登录页面 -->
        <div v-if="!isLoggedIn" class="login-container">
            <!-- 浮动粒子背景 -->
            <div class="floating-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>

            <div class="login-card">
                            <div class="card-body text-center p-5">
                                <!-- Logo和标题 -->
                                <div class="mb-4">
                                    <div class="login-logo">
                                        <i class="fas fa-film me-3"></i>
                                        LightX2V
                                    </div>
                                    <p class="login-subtitle">一个强大的视频生成平台</p>
                                </div>

                                <!-- 登录按钮 -->
                                <div class="mb-4">
                                <button @click="loginWithGitHub" class="btn btn-github btn-lg w-100 mb-4" :disabled="loginLoading">
                                    <i class="fab fa-github me-2"></i>
                                    {{ loginLoading||initLoading ? '登录中...' : '使用GitHub登录' }}
                                </button>
                                </div>

                                <!-- 登录按钮 -->
                                <div class="mb-4">
                                <button @click="loginWithGoogle" class="btn btn-github btn-lg w-100 mb-4" :disabled="loginLoading">
                                    <i class="fab fa-google me-2"></i>
                                    {{ loginLoading||initLoading ? '登录中...' : '使用Google登录' }}
                                </button>
                                </div>

                                <!-- 短信验证码登录 -->
                                <div class="mb-4">
                                    <button @click="toggleSmsLogin" class="btn btn-github btn-lg w-100 mb-4" :disabled="loginLoading">
                                        <i class="fas fa-mobile-alt me-2"></i>
                                        {{ loginLoading ? '登录中...' : '短信验证码登录' }}
                                    </button>

                                    <!-- 短信登录表单 -->
                                    <div v-if="showSmsForm" class="sms-login-form">
                                        <div class="mb-3 d-flex gap-3">
                                            <input v-model="phoneNumber"
                                                type="tel"
                                                class="form-control form-control-lg flex-1"
                                                placeholder="请输入手机号"
                                                :disabled="loginLoading"
                                                maxlength="11"
                                            >
                                            <button
                                                @click="sendSmsCode"
                                                class="btn btn-primary btn-lg"
                                                :disabled="!phoneNumber || smsCountdown > 0 || loginLoading"
                                                style="min-width: 120px;"
                                            >
                                                {{ smsCountdown > 0 ? `${smsCountdown}s` : '发送验证码' }}
                                            </button>
                                        </div>
                                        <div class="mb-3 d-flex gap-3">
                                            <input
                                                v-model="verifyCode"
                                                type="text"
                                                class="form-control form-control-lg flex-1"
                                                placeholder="请输入验证码"
                                                :disabled="loginLoading"
                                                maxlength="6"
                                            >
                                            <button
                                                @click="loginWithSms"
                                                class="btn btn-primary btn-lg"
                                                :disabled="!phoneNumber || !verifyCode || loginLoading"
                                                style="min-width: 120px;"
                                            >
                                                {{ loginLoading ? '登录中...' : '确认登录' }}
                                            </button>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <button
                                                @click="toggleSmsLogin"
                                                class="btn btn-primary btn-lg"
                                                :disabled="loginLoading"
                                                style="min-width: 120px; margin-top: 20px;"
                                            >
                                                <i class="fas fa-times me-2"></i>
                                                取消
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 功能特性 -->
                                <div class="login-features">
                                    <div class="feature-item">
                                        <div class="feature-icon">🎭</div>
                                        <span>电影级数字人视频</span>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">⚡</div>
                                        <span>20倍生成提速</span>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">💰</div>
                                        <span>超低成本生成</span>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">🎯</div>
                                        <span>精准口型对齐</span>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">📱</div>
                                        <span>分钟级视频时长</span>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">🎨</div>
                                        <span>多场景应用</span>
                                    </div>
                                </div>
                            </div>
            </div>
        </div>

        <!-- 主应用页面 -->
        <div v-if="isLoggedIn" class="main-container">
        <!-- 浮动粒子背景 -->
        <div class="floating-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>

        <!-- 主内容区域 -->
            <div class="main-content-area flex flex-col relative h-full">
            <!-- 顶部栏 -->
            <div class="bg-dark top-bar">
                <div class="top-bar-content">
                    <!-- 左侧图标 -->
                    <div class="top-bar-left">
                        <img src="/icon/seko_logo_white.svg" alt="SekoTalk Logo" class="top-bar-logo">
                    </div>
                    
                    <!-- 右侧用户信息 -->
                    <div class="top-bar-right">
                        <div class="user-info">
                            <div class="user-avatar text-gradient-icon">
                                <img v-if="currentUser.avatar" :src="currentUser.avatar" :alt="currentUser.username" class="avatar-img">
                                <i v-else class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <span class="username">{{ currentUser.username }}</span>
                                <span class="user-email">{{ currentUser.email }}</span>
                            </div>
                            <button @click="logout" class="text-gradient-icon" title="退出登录">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

                <!-- 下方区域 -->
                <div class="flex flex-row relative flex-1 min-h-0">
                    <!-- 左侧功能区 -->
                    <div class="relative w-16 flex flex-col z-10 bg-dark border-r border-laser-purple/40 smooth-transition hover:bg-dark-light">
                        <!-- 功能导航 -->
                <div class="p-2">
                            <nav class="space-y-2">
                                <!-- 生成视频功能 -->
                                <div class="relative group">
                    <button
                                        @click="switchToCreateView"
                                        class="w-full flex items-center justify-center p-3 rounded-lg transition-all duration-200 font-medium text-sm border border-transparent"
                                        :class="currentView === 'create' 
                                            ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                            : 'text-gray-400 hover:text-white hover:bg-dark-light'"
                                        title="生成视频">
                                        <i class="fas fa-plus text-lg"></i>
                    </button>
                </div>

                                <!-- 我的项目功能 -->
                                <div class="relative group">
                                    <button
                                        @click="switchToProjectsView"
                                        class="w-full flex items-center justify-center p-3 rounded-lg transition-all duration-200 font-medium text-sm border border-transparent"
                                        :class="currentView === 'projects' 
                                            ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                            : 'text-gray-400 hover:text-white hover:bg-dark-light'"
                                        title="我的项目">
                                        <i class="fas fa-folder text-lg"></i>
                                    </button>
                    </div>

                                <!-- 灵感广场功能 -->
                                <div class="relative group">
                                    <button
                                        @click="switchToInspirationView"
                                        class="w-full flex items-center justify-center p-3 rounded-lg transition-all duration-200 font-medium text-sm border border-transparent"
                                        :class="currentView === 'inspiration' 
                                            ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                            : 'text-gray-400 hover:text-white hover:bg-dark-light'"
                                        title="灵感广场">
                                        <i class="fas fa-star text-lg"></i>
                                    </button>
                    </div>
                            </nav>
                        </div>
                            </div>
                            

                    <!-- 历史任务区域 -->
                    <div v-if="currentView === 'projects'" class="flex-1 flex flex-col min-h-0">
                        <!-- 内容区域 -->
                        <div class="flex-1 overflow-y-auto p-10 content-area">
                            <!-- 历史任务功能区 -->
                            <div class="max-w-4xl mx-auto" id="task-creator">
                                <!-- 搜索和筛选区域 -->
                                <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <!-- 搜索框 -->
                                    <div class="relative flex-1">
                                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none z-10"></i>
                            <input
                                v-model="searchQuery"
                                            class="w-full bg-dark-light border border-laser-purple/30 rounded-lg py-3 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-laser-purple/50 transition-all focus:border-laser focus:shadow-laser"
                                            placeholder="搜索历史任务..."
                                type="text"
                            />
                        </div>

                                    <!-- 分类筛选 -->
                                    <div class="flex gap-2">
                                <button
                                    @click="statusFilter = 'ALL'"
                                            :class="statusFilter === 'ALL' 
                                                ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                                : 'bg-dark-light text-gray-400 hover:text-white hover:bg-dark-light/80'"
                                            class="px-4 py-2 rounded-lg border border-transparent transition-all duration-200 text-sm font-medium"
                                >
                                    全部
                                </button>
                                <button
                                    @click="statusFilter = 'SUCCEED'"
                                            :class="statusFilter === 'SUCCEED' 
                                                ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                                : 'bg-dark-light text-gray-400 hover:text-white hover:bg-dark-light/80'"
                                            class="px-4 py-2 rounded-lg border border-transparent transition-all duration-200 text-sm font-medium"
                                >
                                    成功
                                </button>
                                <button
                                    @click="statusFilter = 'RUNNING'"
                                            :class="statusFilter === 'RUNNING' 
                                                ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                                : 'bg-dark-light text-gray-400 hover:text-white hover:bg-dark-light/80'"
                                            class="px-4 py-2 rounded-lg border border-transparent transition-all duration-200 text-sm font-medium"
                                >
                                    进行中
                                </button>
                                <button
                                    @click="statusFilter = 'FAILED'"
                                            :class="statusFilter === 'FAILED' 
                                                ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                                : 'bg-dark-light text-gray-400 hover:text-white hover:bg-dark-light/80'"
                                            class="px-4 py-2 rounded-lg border border-transparent transition-all duration-200 text-sm font-medium"
                                >
                                    失败
                                </button>
                                <button
                                    @click="() => refreshTasks(true)"
                                    class="text-gray-400 hover:text-gradient-icon transition-colors flex-shrink-0"
                                    title="刷新任务列表"
                                >
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                        </div>
                    </div>
                            
                            <!-- 分页组件 -->
                            <div v-cloak>
                                            <div v-if="paginationInfo" :key="paginationKey" class="pagination-container mb-3">
                                    <div class="flex items-center justify-between text-xs text-gray-400">
                                        <div class="flex items-center space-x-1 text-gray-500">
                                            <span>共{{ paginationInfo.total }}条</span>
                        </div>
                                        <div v-if="paginationInfo.total_pages > 1" class="flex items-center space-x-2">
                                            <!-- 上一页按钮 -->
                                            <button
                                                @click="goToPage(currentPage - 1)"
                                                :disabled="currentPage <= 1"
                                                class="pagination-btn-compact"
                                                :class="{ 'disabled': currentPage <= 1 }"
                                                title="上一页"
                                            >
                                                <i class="fas fa-chevron-left text-xs"></i>
                                            </button>
                                            
                                            <!-- 页码输入框 -->
                                            <div class="flex items-center space-x-1">
                                                <input
                                                    v-model.number="pageInput"
                                                    @keyup.enter="jumpToPage"
                                                    @blur="jumpToPage"
                                                    type="number"
                                                    :min="1"
                                                    :max="paginationInfo.total_pages"
                                                    class="page-input"
                                                    title="输入页码跳转"
                                                />
                                                <span class="text-gray-500">/</span>
                                                <span class="text-gray-500">{{ paginationInfo.total_pages }}</span>
                            </div>
                                            
                                            <!-- 下一页按钮 -->
                                            <button
                                                @click="goToPage(currentPage + 1)"
                                                :disabled="currentPage >= paginationInfo.total_pages"
                                                class="pagination-btn-compact"
                                                :class="{ 'disabled': currentPage >= paginationInfo.total_pages }"
                                                title="下一页"
                                            >
                                                <i class="fas fa-chevron-right text-xs"></i>
                                            </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                            
                        
                        <!-- 可滚动的任务列表区域 -->
                                <div class="flex-1 overflow-y-auto history-tasks-scroll min-h-0 p-4" style="overflow-x: visible;">
                            <div v-cloak>
                                <div v-if="filteredTasks.length === 0" class="flex-col items-center justify-center py-12 text-center">
                                    <p class="text-gray-400 text-sm">暂无历史任务</p>
                                    <p class="text-gray-500 text-xs mt-1">开始创建你的第一个AI视频吧</p>
                                </div>
                                        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                                <!-- 任务卡片 -->
                            <div
                                v-for="task in filteredTasks"
                                :key="task.task_id"
                                                    class="group relative bg-dark-light rounded-xl overflow-hidden border border-gray-700/50 hover:border-laser-purple/40 transition-all duration-300 hover:shadow-laser/20"
                                                    @click="openTaskDetailModal(task)"
                                                >
                                                    <!-- 缩略图区域 -->
                                                    <div class="relative mb-3">
                                                        <div class="w-full h-44 bg-dark-light rounded-lg overflow-hidden">
                                                            <!-- 成功任务：显示视频动图 -->
                                                            <video 
                                                                v-if="task.status === 'SUCCEED'"
                                                                :src="getVideoUrl(task.task_id, 'output_video')"
                                                                :poster="getTaskInputImage(task)"
                                                                class="w-full h-44 object-cover group-hover:scale-105 transition-transform duration-300"
                                                                muted
                                                                loop
                                                                preload="metadata"
                                                                playsinline
                                                                webkit-playsinline
                                                                @mouseenter="playVideo($event)"
                                                                @mouseleave="pauseVideo($event)"
                                                                @loadeddata="onVideoLoaded($event)"
                                                                @error="onVideoError($event)"
                                                            ></video>
                                                            
                                                            <!-- 失败任务：显示输入图片 -->
                                                            <img
                                                                v-else-if="task.status !== 'SUCCEED' && getTaskInputImage(task)"
                                                                :src="getTaskInputImage(task)"
                                                                alt="任务预览"
                                                                class="w-full h-44 object-cover bg-dark-light transition-transform duration-300 group-hover:scale-105"
                                                                @error="handleThumbnailError"
                                                            />
                                                            
                                                            <!-- 其他状态：显示输入图片或占位符 -->
                                                            <img
                                                                v-else-if="getTaskInputImage(task)"
                                                                :src="getTaskInputImage(task)"
                                                                alt="任务预览"
                                                                class="w-full h-44 object-cover bg-dark-light transition-transform duration-300 group-hover:scale-105"
                                                                @error="handleThumbnailError"
                                                            />
                                                            <div v-else class="w-full h-44 bg-laser-purple/20 flex items-center justify-center">
                                                                <i class="fas fa-video text-gradient-icon text-4xl"></i>
                                                            </div>
                                    </div>
                                                        
                                                        <!-- 状态指示器 -->
                                                        <div class="absolute top-2 right-2">
                                                            <span :class="getTaskStatusColor(task.status)" class="px-2 py-1 rounded-full text-xs font-medium bg-black/50 backdrop-blur-sm">
                                                                {{ getTaskStatusDisplay(task.status) }}
                                                            </span>
                                                        </div>
                                                        
                                                        <!-- 悬停时显示的操作按钮 -->                
                                                        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                                                            <div class="flex space-x-3 pointer-events-auto">
                                                <button
                                                                    v-if="['CREATED', 'PENDING', 'RUNNING','SUCCEED', 'FAILED', 'CANCEL'].includes(task.status)"
                                                                    @click.stop="reuseTask(task)"
                                                                    class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center text-white hover:bg-white/30 transition-colors"
                                                                    title="复用任务"
                                                                >
                                                            <i class="fas fa-copy text-lg"></i>
                                                </button>
                                                        <button
                                                                v-if="['CREATED', 'PENDING', 'RUNNING'].includes(task.status)"
                                                                @click.stop="cancelTask(task.task_id)"
                                                                class="w-10 h-10 rounded-full bg-laser-purple/80 backdrop-blur-sm flex items-center justify-center text-white hover:bg-laser-purple transition-colors"
                                                                title="取消任务"
                                                            >
                                                            <i class="fas fa-times text-lg"></i>
                                                        </button>
                                                        <button
                                                                    v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(task.status)"
                                                                    @click.stop="resumeTask(task.task_id)"
                                                                    class="w-10 h-10 rounded-full bg-laser-purple/80 backdrop-blur-sm flex items-center justify-center text-white hover:bg-laser-purple transition-colors"
                                                                    title="重试"
                                                                >
                                                                    <i class="fas fa-redo text-lg"></i>
                                                        </button>
                                                        <button
                                                                    v-if="task.status === 'SUCCEED'"
                                                                    @click.stop="downloadTaskOutput(task)"
                                                                    class="w-10 h-10 rounded-full bg-laser-purple/80 backdrop-blur-sm flex items-center justify-center text-white hover:bg-laser-purple transition-colors"
                                                                    title="下载"
                                                                >
                                                                    <i class="fas fa-download text-lg"></i>
                                                        </button>
                                                        <button
                                                                    v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(task.status)"
                                                                    @click.stop="deleteTask(task.task_id)"
                                                                    class="w-10 h-10 rounded-full bg-red-400/80 backdrop-blur-sm flex items-center justify-center text-white hover:bg-red-500 transition-colors"
                                                                    title="删除"
                                                                >
                                                                    <i class="fas fa-trash text-lg"></i>
                                                        </button>
                                                </div>
                                            </div>
                                        </div>
                                                    
                                                    <!-- 任务信息 -->
                                                    <div class="pl-4 pr-4 pb-4">
                                                        <h3 class="text-white font-medium text-sm mb-2 line-clamp-2">{{ task.params.prompt.length > 20 ? task.params.prompt.slice(0, 20) + '···' : task.params.prompt }}</h3>
                                                        <div class="flex items-center justify-between text-xs text-gray-500">
                                                            <span>{{ task.model_cls }}</span>
                                                            <span>{{ getRelativeTime(task.create_t) }}</span>
                                    </div>
                                                        
                                </div>
                            </div>
                            </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 生成视频区域 -->
                    <div v-if="currentView === 'create'" class="flex-1 flex flex-col min-h-0">
                    <!-- 内容区域 -->
                    <div class="flex-1 overflow-y-auto p-6 content-area">
                        <!-- 模板选择浮窗 -->
                        <div v-cloak>
                            <div v-if="showImageTemplates || showAudioTemplates"
                                class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center"
                                @click="showImageTemplates = false; showAudioTemplates = false">
                                <div class="bg-secondary rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden"
                                    @click.stop>
                                    <!-- 浮窗头部 -->
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-medium text-white">
                                            <i v-if="showImageTemplates" class="fas fa-image text-gradient-icon mr-2"></i>
                                            <i v-if="showAudioTemplates" class="fas fa-music text-gradient-icon mr-2"></i>
                                            {{ showImageTemplates ? '图片素材库' : '音频素材库' }}
                                        </h3>
                                        <button @click="showImageTemplates = false; showAudioTemplates = false"
                                                class="text-gray-400 hover:text-white transition-colors">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>

                                    <!-- 标签页切换 -->
                                    <div class="flex border-b border-gray-700 mb-6">
                                        <button @click="mediaModalTab = 'history'; showImageTemplates && getImageHistory(); showAudioTemplates && getAudioHistory()"
                                                class="px-4 py-2 text-sm font-medium transition-colors"
                                                :class="mediaModalTab === 'history' 
                                                    ? 'text-gradient-icon border-b-2 border-laser-purple' 
                                                    : 'text-gray-400 hover:text-gray-300'">
                                            <i class="fas fa-history mr-2"></i>
                                            历史记录
                                        </button>
                                        <button @click="mediaModalTab = 'templates'"
                                                class="px-4 py-2 text-sm font-medium transition-colors"
                                                :class="mediaModalTab === 'templates' 
                                                    ? 'text-gradient-icon border-b-2 border-laser-purple' 
                                                    : 'text-gray-400 hover:text-gray-300'">
                                            <i class="fas fa-layer-group mr-2"></i>
                                            素材
                                        </button>
                                    </div>

                                    <!-- 图片历史记录 -->
                                    <div v-if="showImageTemplates && mediaModalTab === 'history'" class="overflow-y-auto max-h-[50vh]">
                                        <div v-if="imageHistory.length === 0" class="flex flex-col items-center justify-center py-12 text-center">
                                            <div class="w-16 h-16 bg-laser-purple/20 rounded-full flex items-center justify-center mb-4">
                                                <i class="fas fa-history text-gradient-icon text-2xl"></i>
                                            </div>
                                            <p class="text-gray-400 text-lg mb-2">暂无历史记录</p>
                                            <p class="text-gray-500 text-sm">开始使用图片后，历史记录将自动保存</p>
                                        </div>
                                        <div v-else class="space-y-3">
                                            <div class="flex items-center justify-between mb-4">
                                                <span class="text-sm text-gray-400">共 {{ imageHistory.length }} 条记录</span>
                                                <button @click="clearImageHistory" 
                                                        class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
                                                        title="清空历史记录">
                                                    <i class="fas fa-trash"></i>
                                                    清空
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div v-for="(history, index) in imageHistory" :key="index"
                                                    @click="selectImageHistory(history)"
                                                    class="relative group cursor-pointer rounded-lg overflow-hidden border border-gray-700 hover:border-laser-purple/50 transition-all">
                                                    <img :src="history.thumbnail" :alt="history.filename"
                                                        class="w-full h-24 object-cover">
                                                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                        <i class="fas fa-check text-white text-xl"></i>
                                                    </div>
                                                    <div class="absolute bottom-0 left-0 right-0 bg-black/80 text-white text-xs p-2">
                                                        <div class="truncate">{{ history.filename }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 图片模板网格 -->
                                    <div v-if="showImageTemplates && mediaModalTab === 'templates'" class="overflow-y-auto max-h-[50vh]">
                                        <div v-if="imageTemplates.length > 0" class="grid grid-cols-4 gap-4">
                                            <div v-for="template in imageTemplates" :key="template.filename"
                                                @click="selectImageTemplate(template)"
                                                class="relative group cursor-pointer rounded-lg overflow-hidden border border-gray-700 hover:border-laser-purple/50 transition-all">
                                                <img :src="template.url" :alt="template.filename"
                                                    class="w-full h-32 object-cover">
                                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                    <i class="fas fa-check text-white text-2xl"></i>
                                                </div>
                                                <div class="absolute bottom-0 left-0 right-0 bg-black/80 text-white text-xs p-2">
                                                    <div class="truncate">{{ template.filename }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else class="flex flex-col items-center justify-center py-12 text-center">
                                            <div class="w-16 h-16 bg-laser-purple/20 rounded-full flex items-center justify-center mb-4">
                                                <i class="fas fa-image text-gradient-icon text-2xl"></i>
                                            </div>
                                            <p class="text-gray-400 text-lg mb-2">目前暂无图片模板</p>
                                        </div>
                                    </div>

                                    <!-- 音频历史记录 -->
                                    <div v-if="showAudioTemplates && mediaModalTab === 'history'" class="overflow-y-auto max-h-[50vh]">
                                        <div v-if="audioHistory.length === 0" class="flex flex-col items-center justify-center py-12 text-center">
                                            <div class="w-16 h-16 bg-laser-purple/20 rounded-full flex items-center justify-center mb-4">
                                                <i class="fas fa-history text-gradient-icon text-2xl"></i>
                                            </div>
                                            <p class="text-gray-400 text-lg mb-2">暂无历史记录</p>
                                            <p class="text-gray-500 text-sm">开始使用音频后，历史记录将自动保存</p>
                                        </div>
                                        <div v-else class="space-y-3">
                                            <div class="flex items-center justify-between mb-4">
                                                <span class="text-sm text-gray-400">共 {{ audioHistory.length }} 条记录</span>
                                                <button @click="clearAudioHistory" 
                                                        class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
                                                        title="清空历史记录">
                                                    <i class="fas fa-trash"></i>
                                                    清空
                                                </button>
                                            </div>
                                            <div class="space-y-3">
                                                <div v-for="(history, index) in audioHistory" :key="index"
                                                    @click="selectAudioHistory(history)"
                                                    class="flex items-center gap-4 p-4 rounded-lg border border-gray-700 hover:border-laser-purple/50 transition-all cursor-pointer bg-dark-light/50 group">
                                                    <div class="w-12 h-12 bg-laser-purple/20 rounded-lg flex items-center justify-center">
                                                        <i class="fas fa-music text-gradient-icon text-xl"></i>
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="text-white font-medium group-hover:text-gradient-icon transition-colors">{{ history.filename }}</div>
                                                        <div class="text-gray-400 text-sm">音频文件</div>
                                                    </div>
                                                    <button @click.stop="previewAudioHistory(history)"
                                                            class="px-3 py-2 bg-laser-purple/20 hover:bg-laser-purple/30 text-gradient-icon rounded-lg transition-all">
                                                        <i class="fas fa-play mr-2"></i>
                                                        试听
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 音频模板列表 -->
                                    <div v-if="showAudioTemplates && mediaModalTab === 'templates'" class="overflow-y-auto max-h-[50vh]">
                                        <div v-if="audioTemplates.length > 0" class="space-y-3">
                                            <div v-for="template in audioTemplates" :key="template.filename"
                                                @click="selectAudioTemplate(template)"
                                                class="flex items-center gap-4 p-4 rounded-lg border border-gray-700 hover:border-laser-purple/50 transition-all cursor-pointer bg-dark-light/50">
                                                <div class="w-12 h-12 bg-laser-purple/20 rounded-lg flex items-center justify-center">
                                                    <i class="fas fa-music text-gradient-icon text-xl"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <div class="text-white font-medium">{{ template.filename }}</div>
                                                    <div class="text-gray-400 text-sm">音频模板</div>
                                                </div>
                                                <button @click.stop="previewAudioTemplate(template)"
                                                        class="px-3 py-2 bg-laser-purple/20 hover:bg-laser-purple/30 text-gradient-icon rounded-lg transition-all">
                                                    <i class="fas fa-play mr-2"></i>
                                                    试听
                                                </button>
                                            </div>
                                        </div>
                                        <div v-else class="flex flex-col items-center justify-center py-12 text-center">
                                            <div class="w-16 h-16 bg-laser-purple/20 rounded-full flex items-center justify-center mb-4">
                                                <i class="fas fa-music text-gradient-icon text-2xl"></i>
                                            </div>
                                            <p class="text-gray-400 text-lg mb-2">目前暂无音频模板</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 任务创建面板 -->
                        <div class="max-w-4xl mx-auto" id="task-creator">
                            <!-- 任务类型选择 -->
                            <div class="mb-8 task-type-selection">
                                <div class="flex border-b border-laser-purple/30 task-type-buttons">
                                    <button
                                        v-for="taskType in availableTaskTypes"
                                        :key="taskType"
                                        @click="selectTask(taskType)"
                                        class="task-type-btn"
                                        :class="getTaskTypeBtnClass(taskType)"
                                    >
                                        <i :class="getTaskTypeIcon(taskType)" class="mr-2"></i>
                                        {{ getTaskTypeName(taskType) }}
                                    </button>
                                </div>
                            </div>

                            <!-- 模型选择 -->
                            <div v-if="selectedTaskId" class="mb-6">
                                <label class="block text-sm text-gray-400 mb-2">选择模型</label>
                                <div class="model-selection">
                                    <button
                                        v-for="model in availableModelClasses"
                                        :key="model"
                                        @click="selectModel(model)"
                                        class="model-btn px-4 py-2 rounded-lg text-sm transition-all"
                                        :class="getModelBtnClass(model)"
                                    >
                                        <i v-if="model === getCurrentForm().model_cls" class="fas fa-star text-yellow-400 mr-1"></i>
                                        {{ model }}
                                    </button>
                                </div>
                            </div>

                            <!-- 上传区域 -->
                            <div v-if="selectedTaskId === 'i2v' || selectedTaskId === 's2v'" class="upload-section">
                                <!-- 上传图片 -->
                                <div v-if="selectedTaskId === 'i2v' || selectedTaskId === 's2v'" class="upload-area" @click="triggerImageUpload">
                                    <!-- 默认上传界面 -->
                                    <div v-if="!getCurrentImagePreview()" class="upload-content">
                                    <div class="upload-icon">
                                        <i class="fas fa-image text-gradient-icon text-xl"></i>
                                    </div>
                                    <p class="text-xs text-gray-400 mb-4">支持JPG、PNG格式，大小不超过10MB</p>
                                    <div class="flex gap-2">
                                        <button class="btn-primary px-4 py-1.5 rounded-lg transition-all flex-1">上传图片</button>
                                        <button @click.stop="showImageTemplates = true; mediaModalTab = 'history'; getImageHistory()"
                                                class="px-4 py-1.5 rounded-lg bg-laser-purple/20 hover:bg-laser-purple/30 text-gradient-icon border border-laser-purple/40 rounded-lg transition-all">
                                            <i class="fas fa-images mr-1"></i>
                                            素材
                                        </button>
                                    </div>
                                    </div>

                                    <!-- 图片预览 -->
                                    <div v-if="getCurrentImagePreview()" class="image-preview group">
                                        <img :src="getCurrentImagePreview()" alt="预览图片" class="w-full h-full object-cover rounded-lg transition-all duration-300 group-hover:brightness-50">

                                        <!-- 悬停时显示的操作按钮，位置在中下方 -->
                                        <div class="absolute inset-x-0 bottom-4 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                            <div class="flex space-x-3">
                                                <button
                                                    @click.stop="triggerImageUpload"
                                                    class="w-12 h-12 flex items-center justify-center bg-white/15 text-white p-3 rounded-full transition-all duration-200 hover:scale-110 shadow-lg"
                                                    title="重新上传">
                                                    <i class="fas fa-upload text-lg"></i>
                                                </button>
                                                <button
                                                    @click.stop="removeImage"
                                                    class="w-12 h-12 flex items-center justify-center bg-white/15 text-white p-3 rounded-full transition-all duration-200 hover:scale-110 shadow-lg"
                                                    title="删除图片">
                                                    <i class="fas fa-trash text-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <input
                                        type="file"
                                        ref="imageInput"
                                        @change="handleImageUpload"
                                        accept="image/*"
                                        style="display: none;">
                                </div>

                                <!-- 上传音频 -->
                                    <div v-if="selectedTaskId === 's2v'" class="upload-area">
                                    <!-- 默认上传界面 -->
                                        <div v-if="!getCurrentAudioPreview()" class="upload-content" @click="triggerAudioUpload">
                                    <div class="upload-icon">
                                        <i class="fas fa-microphone text-gradient-icon text-xl"></i>
                                    </div>
                                        <p class="text-xs text-gray-400 mb-4">支持MP4、WAV格式，最长支持120s</p>
                                    <div class="flex gap-2">
                                        <button class="btn-primary px-4 py-1.5 rounded-lg transition-all flex-1">上传音频</button>
                                        <button @click.stop="showAudioTemplates = true; mediaModalTab = 'history'; getAudioHistory()"
                                                class="px-4 py-1.5 rounded-lg bg-laser-purple/20 hover:bg-laser-purple/30 text-gradient-icon border border-laser-purple/40 rounded-lg transition-all">
                                            <i class="fas fa-music mr-1"></i>
                                            素材
                                        </button>
                                    </div>
                                    </div>

                                    <!-- 音频预览 -->
                                        <div v-if="getCurrentAudioPreview()" class="audio-preview group">
                                        <audio controls class="w-full h-full">
                                            <source :src="getCurrentAudioPreview()" :type="getAudioMimeType()">
                                        </audio>

                                        <!-- 悬停时显示的操作按钮，位置在中下方 -->
                                        <div class="absolute inset-x-0 bottom-4 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-black/20">
                                            <div class="flex space-x-3">
                                                <button
                                                    @click.stop="triggerAudioUpload"
                                                    class="w-12 h-12 flex items-center justify-center bg-white/15 text-white p-3 rounded-full transition-all duration-200 hover:scale-110 shadow-lg"
                                                    title="重新上传">
                                                    <i class="fas fa-upload text-lg"></i>
                                                </button>
                                                <button
                                                    @click.stop="removeAudio"
                                                    class="w-12 h-12 flex items-center justify-center bg-white/15 text-white p-3 rounded-full transition-all duration-200 hover:scale-110 shadow-lg"
                                                    title="删除音频">
                                                    <i class="fas fa-trash text-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <input
                                        type="file"
                                        ref="audioInput"
                                        @change="handleAudioUpload"
                                        accept="audio/*"
                                        style="display: none;">
                                </div>
                            </div>

                            <!-- 提示词输入 -->
                            <div class="mb-6 prompt-input-section">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm text-gray-400 flex items-center">
                                        提示词
                                        <button @click="showPromptModal = true; promptModalTab = 'templates'" class="text-xs text-gray-400 hover:text-gradient-icon transition-colors pl-3" title="提示词素材库">
                                            <i class="fas fa-lightbulb"></i>
                                        </button>
                                    </label>
                                </div>


                                <div class="relative">
                                    <textarea
                                        v-model="getCurrentForm().prompt"
                                        class="w-full bg-dark-light border border-laser-purple/40 rounded-lg p-4 pr-16 text-base min-h-[120px] focus:outline-none focus:ring-2 focus:ring-laser-purple/60 transition-all resize-none scrollbar-thin focus:border-laser focus:shadow-laser prompt-textarea"
                                        :placeholder="getPromptPlaceholder()"
                                        rows="3"
                                        required
                                    ></textarea>
                                </div>

                                <div class="flex justify-between items-center pl-2">
                                    <button @click="clearPrompt" class="flex items-center text-sm rounded transition-all text-gray-400 hover:text-gradient-icon">
                                        <i class="fas fa-sync-alt text-sm mr-2"></i>
                                        清空
                                    </button>
                                    <div>
                
                                    </div>
                                </div>

                                <div class="flex justify-center mt-6">
                                    <button @click="submitTask" :disabled="submitting" class="btn-primary flex items-center justify-center px-8 py-3 rounded-lg text-lg transition-all shadow-lg">
                                        <i class="fas fa-play text-xl mr-2"></i>
                                        {{ submitting ? '提交中...' : '生成视频' }}
                                    </button>
                                </div>
                            </div>
                        </div>

                </div>
                    </div>

                <!-- 灵感广场区域 -->
                <div v-if="currentView === 'inspiration'" class="flex-1 flex flex-col min-h-0">
                    <!-- 内容区域 -->
                    <div class="flex-1 overflow-y-auto p-6 content-area">
                        <!-- 灵感广场功能区 -->
                        <div class="max-w-4xl mx-auto" id="inspiration-gallery">
                            <!-- 固定功能区 -->
                            <div class="flex-shrink-0 p-1">
                                <!-- 标题区域 -->
                                <div class="text-center mb-8">
                                    <h1 class="text-3xl font-bold text-white mb-2">灵感广场</h1>
                                    <p class="text-gray-400">发现创意，激发灵感</p>
            </div>
            
                                <!-- 搜索和筛选区域 -->
                                <div class="flex flex-col md:flex-row gap-4 mb-6">
                                    <!-- 搜索框 -->
                                    <div class="relative flex-1">
                                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none z-10"></i>
                                        <input
                                            v-model="inspirationSearchQuery"
                                            class="w-full bg-dark-light border border-laser-purple/30 rounded-lg py-3 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-laser-purple/50 transition-all focus:border-laser focus:shadow-laser"
                                            placeholder="搜索灵感内容..."
                                            type="text"
                                        />
                                    </div>
                                    
                                    <!-- 分类筛选 -->
                                    <div class="flex gap-2">
                                        <button
                                            v-for="category in inspirationCategories"
                                            :key="category.id"
                                            @click="selectInspirationCategory(category.id)"
                                            :class="selectedInspirationCategory === category.id 
                                                ? 'bg-laser-purple/20 text-white border-laser-purple/40' 
                                                : 'bg-dark-light text-gray-400 hover:text-white hover:bg-dark-light/80'"
                                            class="px-4 py-2 rounded-lg border border-transparent transition-all duration-200 text-sm font-medium"
                                        >
                                            {{ category.name }}
                                        </button>
                                    </div>
                                </div>

                                <!-- 灵感内容网格 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    <!-- 灵感卡片 -->
                                    <div 
                                        v-for="item in filteredInspirationItems" 
                                        :key="item.id"
                                        class="group relative bg-dark-light rounded-xl overflow-hidden border border-gray-700/50 hover:border-laser-purple/40 transition-all duration-300 hover:shadow-laser/20"
                                    >
                                        <!-- 视频缩略图区域 -->
                                        <div class="aspect-video bg-gray-800 relative overflow-hidden">
                                                <!-- 视频预览 -->
                                                <video 
                                                    v-if="item.videoUrl"
                                                    :src="item.videoUrl"
                                                    :poster="item.imageUrl"
                                                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                                    muted
                                                    loop
                                                    preload="metadata"
                                                    playsinline
                                                    webkit-playsinline
                                                    @mouseenter="playVideo($event)"
                                                    @mouseleave="pauseVideo($event)"
                                                    @loadeddata="onVideoLoaded($event)"
                                                    @error="onVideoError($event)"
                                                ></video>
                                            <!-- 图片缩略图 -->
                                            <img 
                                                v-else-if="item.imageUrl"
                                                :src="item.imageUrl" 
                                                :alt="item.title"
                                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                            />
                                            <!-- 占位符 -->
                                            <div v-else class="w-full h-full flex items-center justify-center">
                                                <i class="fas fa-star text-4xl text-gray-600"></i>
                                            </div>
                                            
                                            <!-- 悬浮操作按钮 -->
                                            <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                                                <div class="flex space-x-3 pointer-events-auto">
            <button
                                                        @click="previewTemplateDetail(item)"
                                                        class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center text-white hover:bg-white/30 transition-colors"
                                                        title="预览详情"
                                                    >
                                                        <i class="fas fa-eye text-sm"></i>
                                                    </button>
                                                    <button 
                                                        @click="useTemplate(item)"
                                                        class="w-10 h-10 rounded-full bg-laser-purple/80 backdrop-blur-sm flex items-center justify-center text-white hover:bg-laser-purple transition-colors"
                                                        title="使用模板"
                                                    >
                                                        <i class="fas fa-copy text-sm"></i>
            </button>
                                                </div>
                                            </div>
                                            
                                        </div>
                                        
                                        <!-- 内容信息 -->
                                        <div class="p-4">
                                            <h3 class="text-white font-medium text-sm mb-2 line-clamp-2">{{ item.title }}</h3>
                                            <!-- 标签 -->
                                            <div class="flex flex-wrap gap-1 mb-3">
                                                <span 
                                                    v-for="tag in item.tags" 
                                                    :key="tag"
                                                    class="px-2 py-1 bg-gray-700/50 text-gray-300 text-xs rounded-full"
                                                >
                                                    {{ tag }}
                                                </span>
                                            </div>
                                            
                                            <!-- 底部信息 -->
                                            <div class="flex items-center justify-between text-xs text-gray-500">
                                                <span>{{ item.category }}</span>
                                                <span>{{ formatDate(item.createdAt) }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 加载更多按钮 -->
                                <div class="text-center mt-8">
                                    <button 
                                        @click="loadMoreInspiration"
                                        class="px-6 py-3 bg-laser-purple/20 text-laser-purple border border-laser-purple/40 rounded-lg hover:bg-laser-purple/30 transition-all duration-200 font-medium"
                                    >
                                        加载更多灵感
                                                </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                </div>
            </div>
        </div>

        <!-- 增强的提示消息系统 -->
        <div v-cloak>
            <div v-if="alert.show"
                class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] max-w-xs w-full px-4"
                :class="getAlertClass(alert.type)">
                <div class="bg-gray-800/95 backdrop-blur-sm border border-gray-700/50 rounded-lg shadow-lg transition-all duration-300 ease-out">
                    <div class="flex items-center p-3">
                        <div class="flex-shrink-0 mr-3">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center"
                                :class="getAlertIconBgClass(alert.type)">
                                <i :class="getAlertIcon(alert.type)" class="text-xs"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-200">
                                {{ alert.message }}
                            </p>
                        </div>
                        <div class="flex-shrink-0 ml-2">
                            <button @click="alert.show = false"
                                    class="w-5 h-5 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-200 hover:bg-gray-700/50 transition-all duration-200">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 自定义确认对话框 -->
         <div v-cloak>
        <div v-if="confirmDialog.show" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <!-- 背景遮罩 -->
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="confirmDialog.show = false"></div>
            
            <!-- 对话框内容 -->
            <div class="relative bg-dark-light border border-laser-purple/30 rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 ease-out"
                 :class="confirmDialog.show ? 'scale-100 opacity-100' : 'scale-95 opacity-0'">
                <!-- 头部 -->
                <div class="flex items-center justify-between p-6 border-b border-gray-700">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-red-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
                                            </div>
                        <h3 class="text-lg font-semibold text-white">{{ confirmDialog.title }}</h3>
                    </div>
                    <button @click="confirmDialog.show = false" 
                            class="text-gray-400 hover:text-gray-300 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                                                </button>
                                                </div>
                
                <!-- 内容 -->
                <div class="p-6">
                    <p class="text-gray-300 leading-relaxed mb-6">{{ confirmDialog.message }}</p>
                    
                    <!-- 警告信息 -->
                    <div v-if="confirmDialog.warning" class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-red-400 mt-0.5"></i>
                            <div class="text-sm text-red-300">
                                <p class="font-medium mb-2">{{ confirmDialog.warning.title }}</p>
                                <ul class="space-y-1 text-xs">
                                    <li v-for="item in confirmDialog.warning.items" :key="item" class="flex items-center gap-2">
                                        <i class="fas fa-minus text-red-400 text-xs"></i>
                                        {{ item }}
                                    </li>
                                </ul>
                                            </div>
                                        </div>
                                    </div>
                </div>
                
                <!-- 底部按钮 -->
                <div class="flex gap-3 p-6 pt-0">
                    <button @click="confirmDialog.cancel()" 
                            class="flex-1 px-4 py-2.5 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-all duration-200 font-medium">
                        取消
                    </button>
                    <button @click="confirmDialog.confirm()" 
                            class="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all duration-200 font-medium flex items-center justify-center gap-2">
                        <i class="fas fa-trash text-sm"></i>
                        {{ confirmDialog.confirmText }}
                    </button>
                </div>
            </div>
        </div>
        </div>

        <!-- 提示词模板和历史记录弹窗 -->
        <div v-cloak>
            <div v-if="showPromptModal"
                class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center"
                @click="showPromptModal = false">
                <div class="bg-secondary rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden"
                    @click.stop>
                    <!-- 浮窗头部 -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-white">
                            <i class="fas fa-lightbulb text-gradient-icon mr-2"></i>
                            提示词素材库
                        </h3>
                        <button @click="showPromptModal = false"
                                class="text-gray-400 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <!-- 标签页切换 -->
                    <div class="flex border-b border-gray-700 mb-6">
                        <button @click="promptModalTab = 'templates'"
                                class="px-4 py-2 text-sm font-medium transition-colors"
                                :class="promptModalTab === 'templates' 
                                    ? 'text-gradient-icon border-b-2 border-laser-purple' 
                                    : 'text-gray-400 hover:text-gray-300'">
                            <i class="fas fa-layer-group mr-2"></i>
                            模板
                        </button>
                        <button @click="promptModalTab = 'history'"
                                class="px-4 py-2 text-sm font-medium transition-colors"
                                :class="promptModalTab === 'history' 
                                    ? 'text-gradient-icon border-b-2 border-laser-purple' 
                                    : 'text-gray-400 hover:text-gray-300'">
                            <i class="fas fa-history mr-2"></i>
                            历史记录
                        </button>
                    </div>

                    <!-- 模板内容 -->
                    <div v-if="promptModalTab === 'templates'" class="overflow-y-auto max-h-[50vh]">
                        <div v-if="getPromptTemplates(selectedTaskId).length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button
                                v-for="template in getPromptTemplates(selectedTaskId)"
                                :key="template.id"
                                @click="selectPromptTemplate(template)"
                                class="p-4 text-left bg-dark-light rounded-lg hover:bg-laser-purple/20 transition-all border border-transparent hover:border-laser-purple/40 group"
                            >
                                <div class="font-medium text-sm mb-2 text-white group-hover:text-gradient-icon transition-colors">
                                    {{ template.title }}
                                </div>
                                <div class="text-xs text-gray-400 line-clamp-3 leading-relaxed">
                                    {{ template.prompt }}
                                </div>
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-xs text-laser-purple/60">点击应用</span>
                                    <i class="fas fa-arrow-right text-xs text-laser-purple/60 group-hover:translate-x-1 transition-transform"></i>
                                </div>
                            </button>
                        </div>
                        <div v-else class="flex flex-col items-center justify-center py-12 text-center">
                            <div class="w-16 h-16 bg-laser-purple/20 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-layer-group text-gradient-icon text-2xl"></i>
                            </div>
                            <p class="text-gray-400 text-lg mb-2">暂无可用模板</p>
                            <p class="text-gray-500 text-sm">请先选择任务类型</p>
                        </div>
                    </div>

                    <!-- 历史记录内容 -->
                    <div v-if="promptModalTab === 'history'" class="overflow-y-auto max-h-[50vh]">
                        <div v-if="promptHistory.length === 0" class="flex flex-col items-center justify-center py-12 text-center">
                            <div class="w-16 h-16 bg-laser-purple/20 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-history text-gradient-icon text-2xl"></i>
                            </div>
                            <p class="text-gray-400 text-lg mb-2">暂无历史记录</p>
                            <p class="text-gray-500 text-sm">开始创建任务后，提示词将自动保存</p>
                        </div>
                        <div v-else class="space-y-3">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm text-gray-400">共 {{ promptHistory.length }} 条记录</span>
                                <button @click="clearPromptHistory" 
                                        class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
                                        title="清空历史记录">
                                    <i class="fas fa-trash"></i>
                                    清空
                                </button>
                            </div>
                            <button
                                v-for="(history, index) in promptHistory"
                                :key="index"
                                @click="selectPromptHistory(history)"
                                class="w-full p-4 text-left bg-dark-light rounded-lg hover:bg-laser-purple/20 transition-all border border-transparent hover:border-laser-purple/40 group"
                            >
                                <div class="text-sm text-gray-300 line-clamp-3 leading-relaxed group-hover:text-white transition-colors">
                                    {{ history }}
                                </div>
                                <div class="mt-2 flex items-center justify-between">
                                    <span class="text-xs text-laser-purple/60">点击应用</span>
                                    <i class="fas fa-arrow-right text-xs text-laser-purple/60 group-hover:translate-x-1 transition-transform"></i>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- 模板详情弹窗 -->
            <div v-cloak>
                <div v-if="showTemplateDetailModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" @click="closeTemplateDetailModal">
                    <div class="bg-secondary rounded-xl max-w-6xl w-full max-h-[90vh] overflow-hidden" @click.stop>
                        <!-- 弹窗头部 -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-700">
                            <h3 class="text-xl font-medium text-white flex items-center">
                                <i class="fas fa-star text-laser-purple mr-3"></i>
                                模板详情
                            </h3>
                            <button @click="closeTemplateDetailModal" class="text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- 弹窗内容 -->
                        <div class="flex h-[calc(90vh-120px)]">
                            <!-- 左侧视频播放区域 -->
                            <div class="flex-1 p-6">
                                <div class="w-full h-full bg-gray-900 rounded-lg overflow-hidden">
                                    <video 
                                        v-if="selectedTemplate?.videoUrl"
                                        :src="selectedTemplate.videoUrl"
                                        class="w-full h-full object-contain"
                                        controls
                                        autoplay
                                    ></video>
                                    <div v-else class="w-full h-full flex items-center justify-center text-gray-500">
                                        <i class="fas fa-video text-4xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧模板信息区域 -->
                            <div class="w-[28rem] overflow-y-auto border-l border-gray-700">
                                <div class="p-6 space-y-6">
                                    <!-- 操作按钮 -->
                                    <div class="flex flex-col space-y-3 items-center">
                                        <button 
                                            @click="useTemplate(selectedTemplate)"
                                            class="w-3/4 px-4 py-3 bg-laser-purple/20 text-laser-purple border border-laser-purple/40 rounded-xl hover:bg-laser-purple/30 transition-all duration-200 font-medium"
                                        >
                                            使用模板
                                        </button>

                                    </div>  
                                    
                                    <!-- 模板信息 -->
                                    <div>
                                        <h4 class="text-lg font-medium text-white mb-3">模板信息</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">模型:</span>
                                                <span class="text-white">{{ selectedTemplate?.templateData?.task?.model_cls }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">类型:</span>
                                                <span class="text-white">{{ selectedTemplate?.templateData?.task?.task_type }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">提示词:</span>
                                                <span class="text-white text-xs">{{ selectedTemplate?.templateData?.task?.params?.prompt }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 输入素材 -->
                                    <div>
                                        <h4 class="text-lg font-medium text-white mb-3">输入素材</h4>
                                        <div class="space-y-4">
                                            <!-- 输入图片 -->
                                            <div v-if="selectedTemplate?.imageUrl">
                                                <label class="text-sm text-gray-400 mb-2 block">输入图片</label>
                                                <div class="w-32 h-32 bg-gray-800 rounded-lg overflow-hidden">
                                                    <img 
                                                        :src="selectedTemplate.imageUrl" 
                                                        :alt="'输入图片'"
                                                        class="w-full h-full object-cover"
                                                    />
                                                </div>
                                            </div>
                                            
                                            <!-- 输入音频 -->
                                            <div v-if="selectedTemplate?.audioUrl">
                                                <label class="text-sm text-gray-400 mb-2 block">输入音频</label>
                                                <div class="bg-gray-800 rounded-lg p-3">
                                                    <audio 
                                                        :src="selectedTemplate.audioUrl" 
                                                        controls
                                                        class="w-full"
                                                    ></audio>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 任务详情弹窗 -->
            <div v-cloak>
                <div v-if="showTaskDetailModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" @click="closeTaskDetailModal">
                    <!-- 任务完成时的大弹窗 -->
                    <div v-if="modalTask?.status === 'SUCCEED'" class="bg-secondary rounded-xl max-w-7xl w-full max-h-[95vh] overflow-hidden" @click.stop>
                        <!-- 弹窗头部 -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-700">
                            <h3 class="text-xl font-medium text-white flex items-center">
                                <i class="fas fa-info-circle text-gradient-icon mr-2"></i>
                                任务详情
                            </h3>
                            <button @click="closeTaskDetailModal" class="text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- 左右布局内容 -->
                        <div class="flex h-[calc(100vh-120px)]">
                            <!-- 左侧视频播放器 -->
                            <div class="flex-1 p-6">
                                <div class="h-full bg-black rounded-xl border border-laser-purple/50 overflow-hidden">
                        <video
                            v-if="selectedTaskFiles.outputs.output_video && selectedTaskFiles.outputs.output_video.url"
                                        class="w-full h-full object-contain"
                            controls
                            preload="metadata"
                            :src="selectedTaskFiles.outputs.output_video.url">
                            您的浏览器不支持视频播放。
                        </video>
                        <div v-else-if="selectedTaskFiles.outputs.output_video && selectedTaskFiles.outputs.output_video.error"
                            class="w-full h-full flex items-center justify-center bg-red-900/20">
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                                <p class="text-red-400 text-sm">视频加载失败</p>
                            </div>
                        </div>
                        <div v-else
                            class="w-full h-full flex items-center justify-center bg-gray-700">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                                <p class="text-gray-400 text-sm">加载视频中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                            <!-- 右侧任务详情 -->
                            <div class="w-[28rem] overflow-y-auto border-l border-gray-700">
                                <!-- 任务操作按钮 -->
                                <div class="flex flex-col space-y-3 items-center">
                                    <button v-if="['CREATED', 'PENDING', 'RUNNING'].includes(modalTask?.status)"
                                            @click="cancelTask(modalTask.task_id, true); closeTaskDetailModal()"
                                            class="w-3/4 px-4 py-3 bg-gray-700/50 hover:bg-gray-600/50 text-white border border-gray-600/30 rounded-xl text-sm transition-all duration-200 hover:border-gray-500/50">
                                        <i class="fas fa-times mr-2"></i>
                                        取消任务
                                    </button>
                                    <button v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(modalTask?.status)"
                                            @click="reuseTask(modalTask); closeTaskDetailModal()"
                                            class="w-3/4 px-4 py-3 bg-laser-purple/20 hover:bg-laser-purple/30 text-white border border-laser-purple/40 rounded-xl text-sm transition-all duration-200 hover:border-laser-purple/60">
                                        <i class="fas fa-copy mr-2"></i>
                                        复用任务
                                    </button>
                                    <button v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(modalTask?.status)"
                                            @click="resumeTask(modalTask.task_id, true); closeTaskDetailModal()"
                                            class="w-3/4 px-4 py-3 bg-gray-700/50 hover:bg-gray-600/50 text-white border border-gray-600/30 rounded-xl text-sm transition-all duration-200 hover:border-gray-500/50">
                                        <i class="fas fa-redo mr-2"></i>
                                        重新生成
                                    </button>
                                    <button v-if="selectedTaskFiles.outputs.output_video && selectedTaskFiles.outputs.output_video.url"
                                            @click="downloadFile(selectedTaskFiles.outputs.output_video)"
                                            class="w-3/4 px-4 py-3 bg-gray-700/50 hover:bg-gray-600/50 text-white border border-gray-600/30 rounded-xl text-sm transition-all duration-200 hover:border-gray-500/50">
                                        <i class="fas fa-download mr-2"></i>
                                        下载视频
                                    </button>
                                    <button v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(modalTask?.status)"
                                            @click="deleteTask(modalTask.task_id, true); closeTaskDetailModal()"
                                            class="w-3/4 px-4 py-3 bg-red-900/20 hover:bg-red-900/30 text-red-400 border border-red-500/30 rounded-xl text-sm transition-all duration-200 hover:border-red-500/50">
                                        <i class="fas fa-trash mr-2"></i>
                                        删除任务
                                    </button>
            </div>
                                <div class="p-6 space-y-6">
                                    <!-- 任务状态显示 -->
                                    <div class="bg-secondary/30 rounded-xl p-4">
                                <h4 class="text-sm font-medium mb-3 flex items-center">
                                    <i class="fas fa-info-circle text-gradient-icon mr-2"></i>
                                    任务信息
                                </h4>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex justify-between">
                                        <span class="text-gray-400">任务ID</span>
                                        <span class="text-xs">{{ modalTask?.task_id }}</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span class="text-gray-400">任务类型</span>
                                        <span>{{ getTaskTypeName(modalTask) }}</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span class="text-gray-400">模型名称</span>
                                        <span class="text-gradient-icon">{{ modalTask?.model_cls }}</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span class="text-gray-400">创建时间</span>
                                        <span>{{ formatTime(modalTask?.create_t) }}</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span class="text-gray-400">更新时间</span>
                                        <span>{{ formatTime(modalTask?.update_t) }}</span>
                                    </li>
                                    <li class="flex justify-between">
                                        <span class="text-gray-400">状态</span>
                                        <span :class="getStatusTextClass(modalTask?.status)">{{ getTaskStatusDisplay(modalTask?.status) }}</span>
                                    </li>
                                </ul>
        </div>

                                    <!-- 提示词 -->
                                    <div class="bg-secondary/30 rounded-xl p-4">
                                        <h4 class="text-sm font-medium mb-3 flex items-center">
                                            <i class="fas fa-file-alt text-gradient-icon mr-2"></i>
                                            提示词
                                        </h4>
                                        <div class="bg-dark-light rounded-lg p-3 text-sm text-gray-300">
                                    <p>{{ modalTask?.params?.prompt || '无提示词' }}</p>
                                </div>
                                </div>

                                    <!-- 上传素材 -->
                                    <div v-if="modalTask?.inputs && Object.keys(modalTask.inputs).length" class="bg-secondary/30 rounded-xl p-4">
                                <h4 class="text-sm font-medium mb-3 flex items-center">
                                    <i class="fas fa-upload text-gradient-icon mr-2"></i>
                                    上传素材
                                    <span v-if="loadingTaskFiles" class="ml-2 text-xs text-gray-400">(加载中...)</span>
                                </h4>
                                <div class="space-y-3">
                                    <template v-for="(input, key) in modalTask.inputs" :key="key">
                                        <div class="flex items-center gap-3">
                                            <template v-if="key.includes('image')">
                                                <i class="fas fa-image text-gradient-icon text-lg"></i>
                                                <div class="flex items-center gap-2">
                                                    <span v-if="!selectedTaskFiles.inputs[key] || !selectedTaskFiles.inputs[key].url"
                                                        class="text-gray-400 text-sm">{{ typeof input === 'string' ? input : '图片' }}</span>
                                                    <div class="flex items-center gap-2 relative group">
                                                        <img v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                            :src="selectedTaskFiles.inputs[key].url"
                                                            :alt="input"
                                                            class="w-16 h-16 object-cover rounded bg-dark-light border border-gray-700">
                                                        <div v-else-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].error"
                                                            class="w-16 h-16 rounded bg-red-900/20 border border-red-500/30 flex items-center justify-center">
                                                            <i class="fas fa-exclamation-triangle text-red-400"></i>
                                                        </div>
                                                        <div v-else
                                                            class="w-16 h-16 rounded bg-gray-700 border border-gray-600 flex items-center justify-center">
                                                            <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                                        </div>
                                                        <button v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                                @click="downloadFile(selectedTaskFiles.inputs[key])"
                                                                class="text-xs px-2 py-1 rounded">
                                                            <i class="fas fa-download mr-1 text-white opacity-30 hover:opacity-100 transition-opacity"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                            <template v-else-if="key.includes('audio')">
                                                <i class="fas fa-microphone text-gradient-icon text-lg"></i>
                                                <div class="flex items-center gap-2">
                                                    <span v-if="!selectedTaskFiles.inputs[key] || !selectedTaskFiles.inputs[key].url"
                                                        class="text-gray-400 text-sm">{{ typeof input === 'string' ? input : '音频文件' }}</span>
                                                    <div class="flex items-center gap-2">
                                                        <audio v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                            :src="selectedTaskFiles.inputs[key].url"
                                                            controls
                                                            class="h-8 text-gradient-icon">
                                                            您的浏览器不支持音频播放
                                                        </audio>
                                                        <div v-else-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].error"
                                                            class="h-8 px-3 rounded bg-red-900/20 border border-red-500/30 flex items-center">
                                                            <i class="fas fa-exclamation-triangle text-red-400 text-xs"></i>
                                                        </div>
                                                        <div v-else
                                                            class="h-8 px-3 rounded bg-gray-700 border border-gray-600 flex items-center">
                                                            <i class="fas fa-spinner fa-spin text-gray-400 text-xs"></i>
                                                        </div>
                                                        <button v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                                @click="downloadFile(selectedTaskFiles.inputs[key])"
                                                                class="text-xs px-2 py-1 rounded">
                                                            <i class="fas fa-download mr-1 text-white opacity-30 hover:opacity-100 transition-opacity"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 其他状态的小弹窗 -->
                    <div v-else class="bg-secondary rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden" @click.stop>
                        <!-- 弹窗头部 -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-700">
                            <h3 class="text-xl font-medium text-white flex items-center">
                                <i class="fas fa-info-circle text-gradient-icon mr-2"></i>
                                任务详情
                            </h3>
                            <button @click="closeTaskDetailModal" class="text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- 弹窗内容 -->
 

                        <div class="overflow-y-auto max-h-[calc(90vh-120px)] p-6">
                                <!-- 任务进行中信息 -->
                            <div v-if="['CREATED', 'PENDING', 'RUNNING'].includes(modalTask?.status)" class="max-w-4xl mx-auto task-running-panel">
                                    <div class="text-center py-8">
                                        <div class="w-24 h-24 mx-auto bg-laser-purple/20 rounded-full flex items-center justify-center mb-6 animate-pulse-slow">
                                            <i class="fas fa-spinner fa-spin text-gradient-icon text-3xl"></i>
                                        </div>
                                        <h3 class="text-xl font-medium mb-2">视频生成中</h3>
                                        <p class="text-gray-400 mb-6">AI正在努力生成您的视频，请稍候...</p>
                                        
                                        <!-- 子任务进度显示 -->
                                    <div v-if="modalTask && modalTask.subtasks && modalTask.subtasks.length > 0" class="progress-container">
                                            <h4 class="text-sm font-medium mb-4 flex items-center">
                                            <i class="fas fa-chart-line text-gradient-icon mr-2"></i>
                                            任务进度
                                            </h4>
                                            
                                            <!-- 总体进度条 -->
                                            <div class="mb-4">
                                                <div class="flex justify-between items-center mb-2">
                                                 <span class="text-sm text-gray-300">{{ getProgressTitle(modalTask.subtasks || []) }}</span>
                                                 <span class="text-sm text-gradient-icon">{{ getProgressInfo(modalTask.subtasks || []) }}</span>
                                                </div>
                                                <div class="progress-bar">
                                                 <div class="progress-fill" :style="{ width: getOverallProgress(modalTask.subtasks || []) + '%' }"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- 子任务列表 -->
                                            <div class="space-y-2">
                                            <div v-for="(subtask, index) in (modalTask.subtasks || [])" :key="index" class="subtask-item">
                                                    <div class="subtask-header">
                                                        <span class="text-sm font-medium">子任务 {{ index + 1 }}</span>
                                                        <span class="subtask-status" :class="subtask.status.toLowerCase()">
                                                            {{ getSubtaskStatusText(subtask.status) }}
                                                        </span>
                                                    </div>
                                                    
                                                    <!-- 子任务进度条 -->
                                                    <div v-if="subtask.status === 'PENDING' || subtask.status === 'RUNNING'" class="mt-2">
                                                        <div class="flex justify-between items-center mb-1">
                                                            <span class="text-xs text-gray-400">{{ getSubtaskStatusText(subtask.status) }}</span>
                                                            <span class="text-xs text-gradient-icon">{{ formatEstimatedTime(subtask) }}</span>
                                                        </div>
                                                        <div class="progress-bar">
                                                            <div class="progress-fill" :style="{ width: getSubtaskProgress(subtask) + '%' }"></div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 子任务详细信息 -->
                                                    <div class="subtask-info">
                                                        <div v-if="subtask.estimated_pending_order !== null" class="flex items-center gap-2 mt-1">
                                                            <i class="fas fa-clock text-xs"></i>
                                                            <span>队列位置: {{ subtask.estimated_pending_order }}</span>
                                                        </div>
                                                        <div v-if="subtask.ready_worker_count !== null" class="flex items-center gap-2 mt-1">
                                                            <i class="fas fa-users text-xs"></i>
                                                            <span>可用Worker: {{ subtask.ready_worker_count }}</span>
                                                        </div>
                                                        <div v-if="subtask.fail_msg" class="flex items-center gap-2 mt-1 text-red-400">
                                                            <i class="fas fa-exclamation-triangle text-xs"></i>
                                                            <span>{{ subtask.fail_msg }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 任务失败信息 -->
                            <div v-if="modalTask?.status === 'FAILED'" class="max-w-4xl mx-auto task-failed-panel">
                                    <div class="text-center py-8">
                                        <div class="w-24 h-24 mx-auto bg-red-500/10 rounded-full flex items-center justify-center mb-6">
                                            <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                                        </div>
                                        <h3 class="text-xl font-medium mb-2">视频生成失败</h3>
                                        <p class="text-gray-400 mb-4 max-w-md mx-auto flex items-center justify-center gap-2">
                                            很抱歉，您的视频生成任务未能完成。
                                        <button v-if="getTaskFailureInfo(modalTask)" 
                                                    @click="showErrorDetails = !showErrorDetails" 
                                                    class="text-gray-400 hover:text-gray-100 transition-colors">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                        </p>
                                        
                                        <!-- 可展开的错误详情 -->
                                    <div v-if="showErrorDetails && getTaskFailureInfo(modalTask)" class="mt-4">
                                            <span class="text-xs">{{ getTaskFailureInfo(modalTask) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 任务取消信息 -->
                            <div v-if="modalTask?.status === 'CANCEL'" class="max-w-4xl mx-auto task-cancelled-panel">
                                    <div class="text-center py-8">
                                        <div class="w-24 h-24 mx-auto bg-yellow-500/10 rounded-full flex items-center justify-center mb-6">
                                            <i class="fas fa-ban text-yellow-500 text-3xl"></i>
                                        </div>
                                        <h3 class="text-xl font-medium mb-2">任务已取消</h3>
                                        <p class="text-gray-400 mb-4 max-w-md mx-auto">
                                            此任务已被取消，您可以重新生成或查看之前上传的素材。
                                        </p>
                                    </div>

                                </div>

                            <!-- 任务操作按钮 -->
                            <div class="flex justify-center space-x-3 p-4">
                            <button v-if="['CREATED', 'PENDING', 'RUNNING'].includes(modalTask?.status)"
                                    @click="cancelTask(modalTask.task_id, true); closeTaskDetailModal()"
                                            class="px-4 py-2 btn-primary rounded-lg text-sm transition-all">
                                        <i class="fas fa-times mr-2"></i>
                                        取消任务
                                    </button>
                            <button v-if="['SUCCEED', 'FAILED', 'CANCEL','CREATED', 'PENDING', 'RUNNING'].includes(modalTask?.status)"
                                    @click="reuseTask(modalTask); closeTaskDetailModal()"
                                    class="px-4 py-3 bg-laser-purple/20 hover:bg-laser-purple/30 text-white border border-laser-purple/40 rounded-xl text-sm transition-all duration-200 hover:border-laser-purple/60">
                                <i class="fas fa-copy mr-2"></i>
                                        复用任务
                                    </button>
                            <button v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(modalTask?.status)"
                                    @click="resumeTask(modalTask.task_id, true); closeTaskDetailModal()"
                                    class="px-4 py-3 bg-gray-700/50 hover:bg-gray-600/50 text-white border border-gray-600/30 rounded-xl text-sm transition-all duration-200 hover:border-gray-500/50">
                                        <i class="fas fa-redo mr-2"></i>
                                        重新生成
                                    </button>
                            <button v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(modalTask?.status)"
                                    @click="deleteTask(modalTask.task_id, true); closeTaskDetailModal()"
                                    class="px-4 py-3 bg-red-900/20 hover:bg-red-900/30 text-red-400 border border-red-500/30 rounded-xl text-sm transition-all duration-200 hover:border-red-500/50">
                                        <i class="fas fa-trash mr-2"></i>
                                        删除任务
                                    </button>
                                </div>
                            
                                <!-- 任务状态显示 -->
                                <div class="bg-secondary/30 rounded-xl p-6 mb-6">
                                    <h4 class="text-sm font-medium mb-3 flex items-center">
                                        <i class="fas fa-info-circle text-gradient-icon mr-2"></i>
                                        任务信息
                                    </h4>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex justify-between">
                                            <span class="text-gray-400">任务ID</span>
                                        <span>{{ modalTask?.task_id }}</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="text-gray-400">任务类型</span>
                                        <span>{{ getTaskTypeName(modalTask) }}</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="text-gray-400">模型名称</span>
                                        <span class="text-gradient-icon">{{ modalTask?.model_cls }}</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="text-gray-400">创建时间</span>
                                        <span>{{ formatTime(modalTask?.create_t) }}</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="text-gray-400">更新时间</span>
                                        <span>{{ formatTime(modalTask?.update_t) }}</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="text-gray-400">状态</span>
                                        <div class="flex items-center gap-2">
                                            <span :class="getStatusTextClass(modalTask?.status)">{{ getTaskStatusDisplay(modalTask?.status) }}</span>
                                            <button v-if="modalTask?.status === 'FAILED' && getTaskFailureInfo(modalTask)"
                                                    @click="showFailureDetails = !showFailureDetails"
                                                    class="text-red-400 hover:text-red-300 transition-colors"
                                                    title="查看失败原因">
                                                <i class="fas fa-exclamation-triangle text-xs"></i>
                                            </button>
                                        </div>
                                        </li>
                                    </ul>
                                
                                <!-- 失败原因详情 -->
                                <div v-if="showFailureDetails && modalTask?.status === 'FAILED' && getTaskFailureInfo(modalTask)" 
                                     class="mt-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
                                    <div class="flex items-start gap-2">
                                        <i class="fas fa-exclamation-triangle text-red-400 text-sm mt-0.5"></i>
                                        <div class="flex-1">
                                            <p class="text-xs text-red-300 font-medium mb-1">失败原因：</p>
                                            <p class="text-xs text-red-200 whitespace-pre-wrap">{{ getTaskFailureInfo(modalTask) }}</p>
                                        </div>
                                    </div>
                                </div>
                                </div>

                                <!-- 提示词 -->
                                <div class="bg-secondary/30 rounded-xl p-4 mb-6">
                                    <h4 class="text-sm font-medium mb-3 flex items-center">
                                        <i class="fas fa-file-alt text-gradient-icon mr-2"></i>
                                        提示词
                                    </h4>
                                    <div class="bg-dark-light rounded-lg p-4 text-sm text-gray-300">
                                    <p>{{ modalTask?.params?.prompt || '无提示词' }}</p>
                                    </div>
                                </div>

                            <!-- 上传素材 -->
                            <div v-if="modalTask?.inputs && Object.keys(modalTask.inputs).length" class="bg-secondary/30 rounded-xl p-4 mb-6">
                                    <h4 class="text-sm font-medium mb-3 flex items-center">
                                        <i class="fas fa-upload text-gradient-icon mr-2"></i>
                                        上传素材
                                        <span v-if="loadingTaskFiles" class="ml-2 text-xs text-gray-400">(加载中...)</span>
                                    </h4>
                                    <div class="space-y-3">
                                    <template v-for="(input, key) in modalTask.inputs" :key="key">
                                            <div class="flex items-center gap-3">
                                                <template v-if="key.includes('image')">
                                                    <i class="fas fa-image text-gradient-icon text-xl"></i>
                                                    <div class="flex items-center gap-2">
                                                        <span v-if="!selectedTaskFiles.inputs[key] || !selectedTaskFiles.inputs[key].url"
                                                            class="text-gray-400 text-sm">{{ typeof input === 'string' ? input : '图片' }}</span>
                                                        <div class="flex items-center gap-2 relative group">
                                                            <img v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                                :src="selectedTaskFiles.inputs[key].url"
                                                                :alt="input"
                                                                class="w-20 h-20 object-cover rounded bg-dark-light border border-gray-700">
                                                            <div v-else-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].error"
                                                                class="w-20 h-20 rounded bg-red-900/20 border border-red-500/30 flex items-center justify-center">
                                                                <i class="fas fa-exclamation-triangle text-red-400"></i>
                                                            </div>
                                                            <div v-else
                                                                class="w-20 h-20 rounded bg-gray-700 border border-gray-600 flex items-center justify-center">
                                                                <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                                            </div>
                                                            <button v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                                    @click="downloadFile(selectedTaskFiles.inputs[key])"
                                                                    class="text-xs px-2 py-1 rounded">
                                                                <i class="fas fa-download mr-1 text-white opacity-30 hover:opacity-100 transition-opacity"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                                <template v-else-if="key.includes('audio')">
                                                    <i class="fas fa-microphone text-gradient-icon text-xl"></i>
                                                    <div class="flex items-center gap-2">
                                                        <span v-if="!selectedTaskFiles.inputs[key] || !selectedTaskFiles.inputs[key].url"
                                                            class="text-gray-400 text-sm">{{ typeof input === 'string' ? input : '音频文件' }}</span>
                                                        <div class="flex items-center gap-2">
                                                            <audio v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                                :src="selectedTaskFiles.inputs[key].url"
                                                                controls
                                                                class="h-8 text-gradient-icon">
                                                                您的浏览器不支持音频播放
                                                            </audio>
                                                            <div v-else-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].error"
                                                                class="h-8 px-3 rounded bg-red-900/20 border border-red-500/30 flex items-center">
                                                                <i class="fas fa-exclamation-triangle text-red-400 text-xs"></i>
                                                            </div>
                                                            <div v-else
                                                                class="h-8 px-3 rounded bg-gray-700 border border-gray-600 flex items-center">
                                                                <i class="fas fa-spinner fa-spin text-gray-400 text-xs"></i>
                                                            </div>
                                                            <button v-if="selectedTaskFiles.inputs[key] && selectedTaskFiles.inputs[key].url"
                                                                    @click="downloadFile(selectedTaskFiles.inputs[key])"
                                                                    class="text-xs px-2 py-1 rounded">
                                                                <i class="fas fa-download mr-1 text-white opacity-30 hover:opacity-100 transition-opacity"></i>
                                                            </button>
                                                    </div>
                                </div>
                                                </template>
                                    </div>
                                        </template>
                                    </div>
                                </div>

                </div>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        // 检测Font Awesome图标是否加载成功
        function checkFontAwesome() {
            const testIcon = document.createElement('i');
            testIcon.className = 'fas fa-check';
            testIcon.style.position = 'absolute';
            testIcon.style.left = '-9999px';
            document.body.appendChild(testIcon);

            const computedStyle = window.getComputedStyle(testIcon, ':before');
            const content = computedStyle.getPropertyValue('content');

            document.body.removeChild(testIcon);

            // 如果图标没有正确显示，使用备用方案
            if (!content || content === 'none' || content === 'normal') {
                console.warn('Font Awesome 图标加载失败，使用备用方案');
                replaceIconsWithFallback();
            }
        }

        // 使用备用图标替换失败的图标
        function replaceIconsWithFallback() {
            const iconMap = {
                'fas fa-video': '🎥',
                'fas fa-plus': '➕',
                'fas fa-search': '🔍',
                'fas fa-clock': '⏰',
                'fas fa-bars': '☰',
                'fas fa-sign-out-alt': '🚪',
                'fas fa-star': '⭐',
                'fas fa-cloud-upload-alt': '☁️',
                'fas fa-microphone': '🎤',
                'fas fa-magic': '✨',
                'fas fa-history': '📚',
                'fas fa-times': '✖️',
                'fas fa-trash': '🗑️',
                'fas fa-sync-alt': '🔄',
                'fas fa-play': '▶️',
                'fas fa-share-alt': '📤',
                'fas fa-download': '⬇️',
                'fas fa-info-circle': 'ℹ️',
                'fas fa-file-alt': '📄',
                'fas fa-file-video': '🎬',
                'fas fa-eye': '👁️',
                'fas fa-exclamation-triangle': '⚠️',
                'fas fa-lightbulb': '💡',
                'fas fa-check': '✅',
                'fas fa-user': '👤',
                'fas fa-image': '🖼️',
                'fas fa-font': '🔤',
                'fas fa-spinner': '🌀',
                'fas fa-check-circle': '✅',
                'fas fa-hourglass-half': '⏳',
                'fas fa-ban': '🚫',
                'fas fa-question-circle': '❓',
                'fas fa-times-circle': '❌',
                'fas fa-music': '🎵',
                'fas fa-tags': '🏷️',
                'fas fa-chart-bar': '📊',
                'fas fa-redo': '🔄',
                'fas fa-pause': '⏸️'
            };

            // 替换所有图标
            Object.keys(iconMap).forEach(iconClass => {
                const icons = document.querySelectorAll(`.${iconClass.replace(/\s+/g, '.')}`);
                icons.forEach(icon => {
                    icon.innerHTML = iconMap[iconClass];
                    icon.className = icon.className.replace(/fas fa-[a-z-]+/g, '');
                });
            });
        }

        // 页面加载完成后检查图标
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkFontAwesome, 1000); // 延迟1秒检查，确保CDN加载完成
        });
    </script>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // 响应式数据
                const loading = ref(false);
                const loginLoading = ref(false);
                const initLoading = ref(false);
                const downloadLoading = ref(false);
                const alert = ref({ show: false, message: '', type: 'info' });

                // 短信登录相关数据
                const phoneNumber = ref('');
                const verifyCode = ref('');
                const smsCountdown = ref(0);
                const showSmsForm = ref(false);
                const showErrorDetails = ref(false);
                const showFailureDetails = ref(false);
                
                // 任务状态轮询相关
                const pollingInterval = ref(null);
                const pollingTasks = ref(new Set()); // 正在轮询的任务ID集合
                const confirmDialog = ref({
                    show: false,
                    title: '',
                    message: '',
                    confirmText: '确认',
                    warning: null,
                    confirm: () => {}
                });
                const submitting = ref(false);
                const searchQuery = ref('');
                const sidebarCollapsed = ref(false);
                const showExpandHint = ref(false);
                const showGlow = ref(false);

                // 新增：视图切换相关状态
                const currentView = ref('create'); // 'create'、'projects' 或 'inspiration'
                const showTaskDetailModal = ref(false);
                const modalTask = ref(null);

                // 灵感广场相关数据
                const inspirationSearchQuery = ref('');
                const selectedInspirationCategory = ref('all');
                const inspirationItems = ref([]);
                const inspirationCategories = ref([
                    { id: 'all', name: '全部' },
                    { id: 'person', name: '人物' },
                    { id: 'cartoon', name: '卡通' },
                    { id: 'anime', name: '动漫' },
                    { id: 'animal', name: '动物' }
                ]);

                // 模板详情弹窗相关数据
                const showTemplateDetailModal = ref(false);
                const selectedTemplate = ref(null);

                // 任务文件缓存系统
                const taskFileCache = ref(new Map());
                const taskFileCacheLoaded = ref(false);

                // localStorage缓存相关常量
                const TASK_FILE_CACHE_KEY = 'lightx2v_task_files';
                const TASK_FILE_CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24小时过期
                const MODELS_CACHE_KEY = 'lightx2v_models';
                const MODELS_CACHE_EXPIRY = 60 * 60 * 1000; // 1小时过期
                const TEMPLATES_CACHE_KEY = 'lightx2v_templates';
                const TEMPLATES_CACHE_EXPIRY = 30 * 60 * 1000; // 30分钟过期
                const TASKS_CACHE_KEY = 'lightx2v_tasks';
                const TASKS_CACHE_EXPIRY = 5 * 60 * 1000; // 5分钟过期

                const imageTemplates = ref([]);
                const audioTemplates = ref([]);
                const showImageTemplates = ref(false);
                const showAudioTemplates = ref(false);
                const mediaModalTab = ref('history');
                const imageHistory = ref([]);
                const audioHistory = ref([]);
                
                // 模板文件缓存，避免重复下载
                const templateFileCache = ref(new Map());
                const currentUser = ref({});
                const models = ref([]);
                const tasks = ref([]);
                const isLoggedIn = ref(false);

                const selectedTaskId = ref(null);
                const selectedTask = ref(null);
                const selectedTaskFiles = ref({ inputs: {}, outputs: {} }); // 存储任务的输入输出文件
                const loadingTaskFiles = ref(false); // 加载任务文件的状态
                const statusFilter = ref('ALL');
                const pagination = ref(null);
                const currentPage = ref(1);
                const pageSize = ref(10);
                const pageInput = ref(1);
                const paginationKey = ref(0); // 用于强制刷新分页组件
                const taskMenuVisible = ref({}); // 管理每个任务的菜单显示状态
                const nameMap = {
                    't2v': '文生视频',
                    'i2v': '图生视频',
                    's2v': '数字人'
                };

                // 为三个任务类型分别创建独立的表单
                const t2vForm = ref({
                    task: 't2v',
                    model_cls: '',
                    stage: 'single_stage',
                    prompt: '',
                    seed: 42
                });

                const i2vForm = ref({
                    task: 'i2v',
                    model_cls: '',
                    stage: 'multi_stage',
                    imageFile: null,
                    prompt: '',
                    seed: 42
                });

                const s2vForm = ref({
                    task: 's2v',
                    model_cls: '',
                    stage: 'single_stage',
                    imageFile: null,
                    audioFile: null,
                    prompt: '',
                    seed: 42
                });

                // 根据当前选择的任务类型获取对应的表单
                const getCurrentForm = () => {
                    switch (selectedTaskId.value) {
                        case 't2v':
                            return t2vForm.value;
                        case 'i2v':
                            return i2vForm.value;
                        case 's2v':
                            return s2vForm.value;
                        default:
                            return t2vForm.value;
                    }
                };

                // 为每个任务类型创建独立的预览变量
                const i2vImagePreview = ref(null);
                const s2vImagePreview = ref(null);
                const s2vAudioPreview = ref(null);

                // 根据当前任务类型获取对应的预览变量
                const getCurrentImagePreview = () => {
                    switch (selectedTaskId.value) {
                        case 't2v':
                            return null;
                        case 'i2v':
                            return i2vImagePreview.value;
                        case 's2v':
                            return s2vImagePreview.value;
                        default:
                            return null;
                    }
                };

                const getCurrentAudioPreview = () => {
                    switch (selectedTaskId.value) {
                        case 't2v':
                            return null
                        case 'i2v':
                            return null
                        case 's2v':
                            return s2vAudioPreview.value;
                        default:
                            return null;
                    }
                };

                const setCurrentImagePreview = (value) => {
                    switch (selectedTaskId.value) {
                        case 't2v':
                            break;
                        case 'i2v':
                            i2vImagePreview.value = value;
                            break;
                        case 's2v':
                            s2vImagePreview.value = value;
                            break;
                    }
                };

                const setCurrentAudioPreview = (value) => {
                    switch (selectedTaskId.value) {
                        case 't2v':
                            break;
                        case 'i2v':
                            break;
                        case 's2v':
                            s2vAudioPreview.value = value;
                            break;
                    }
                };

                // 提示词模板相关
                const showTemplates = ref(false);
                const showHistory = ref(false);
                const showPromptModal = ref(false);
                const promptModalTab = ref('templates');

                // 计算属性
                const availableTaskTypes = computed(() => {
                    const types = [...new Set(models.value.map(m => m.task))];
                    // 重新排序，确保数字人在最左边
                    const orderedTypes = [];

                    // 检查是否有s2v模型，如果有则添加s2v类型
                    const hasS2vModels = models.value.some(m =>
                        m.task === 's2v'
                    );

                    // 优先添加数字人（如果存在相关模型）
                    if (hasS2vModels) {
                        orderedTypes.push('s2v');
                    }

                    // 然后添加其他类型
                    types.forEach(type => {
                        if (type !== 's2v') {
                            orderedTypes.push(type);
                        }
                    });

                    return orderedTypes;
                });

                const availableModelClasses = computed(() => {
                    if (!selectedTaskId.value) return [];

                    // 其他任务类型正常处理
                    return [...new Set(models.value
                        .filter(m => m.task === selectedTaskId.value)
                        .map(m => m.model_cls))];
                });

                const filteredTasks = computed(() => {
                    let filtered = tasks.value;

                    // 状态过滤
                    if (statusFilter.value !== 'ALL') {
                        filtered = filtered.filter(task => task.status === statusFilter.value);
                    }

                    // 搜索过滤
                    if (searchQuery.value) {
                        filtered = filtered.filter(task =>
                        task.params.prompt?.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                        task.task_id.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                        nameMap[task.task_type].toLowerCase().includes(searchQuery.value.toLowerCase())
                    );
                    }

                    // 按时间排序，最新的任务在前面
                    filtered = filtered.sort((a, b) => {
                        const timeA = parseInt(a.create_t) || 0;
                        const timeB = parseInt(b.create_t) || 0;
                        return timeB - timeA; // 降序排列，最新的在前
                    });

                    return filtered;
                });

                // 监听状态筛选变化，重置分页到第一页
                watch(statusFilter, (newStatus, oldStatus) => {
                    if (newStatus !== oldStatus) {
                        currentPage.value = 1;
                        pageInput.value = 1;
                        refreshTasks(true); // 强制刷新
                    }
                });

                // 监听搜索查询变化，重置分页到第一页
                watch(searchQuery, (newQuery, oldQuery) => {
                    if (newQuery !== oldQuery) {
                        currentPage.value = 1;
                        pageInput.value = 1;
                        refreshTasks(true); // 强制刷新
                    }
                });

                // 分页信息计算属性，确保响应式更新
                const paginationInfo = computed(() => {
                    if (!pagination.value) return null;
                    
                    return {
                        total: pagination.value.total || 0,
                        total_pages: pagination.value.total_pages || 0,
                        current_page: pagination.value.current_page || currentPage.value,
                        page_size: pagination.value.page_size || pageSize.value
                    };
                });

                // 方法
                const showAlert = (message, type = 'info') => {
                    alert.value = { show: true, message, type };
                    setTimeout(() => {
                        alert.value.show = false;
                    }, 5000);
                };

                // 显示确认对话框
                const showConfirmDialog = (options) => {
                    return new Promise((resolve) => {
                        confirmDialog.value = {
                            show: true,
                            title: options.title || '确认操作',
                            message: options.message || '确定要执行此操作吗？',
                            confirmText: options.confirmText || '确认',
                            warning: options.warning || null,
                            confirm: () => {
                                confirmDialog.value.show = false;
                                resolve(true);
                            },
                            cancel: () => {
                                confirmDialog.value.show = false;
                                resolve(false);
                            }
                        };
                    });
                };

                const setLoading = (value) => {
                    loading.value = value;
                };

                const apiCall = async (endpoint, options = {}) => {
                    const url = `${endpoint}`;
                    const headers = {
                        'Content-Type': 'application/json',
                        ...options.headers
                    };

                    if (localStorage.getItem('accessToken')) {
                        headers['Authorization'] = `Bearer ${localStorage.getItem('accessToken')}`;
                    }

                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (response.status === 401) {
                        logout();
                        throw new Error('认证失败，请重新登录'); }
                    if (response.status === 400) {
                        const error = await response.json();
                        showAlert(error.message, 'danger');
                        throw new Error(error.message);
                    }

                    // 添加50ms延迟，防止触发服务端频率限制
                    await new Promise(resolve => setTimeout(resolve, 50));

                    return response;
                };

                const loginWithGitHub = async () => {
                    try {
                        console.log('starting login')
                        loginLoading.value = true;
                        const response = await fetch('./auth/login/github');
                        const data = await response.json();
                        localStorage.setItem('loginSource', 'github');
                        window.location.href = data.auth_url;
                    } catch (error) {
                        showAlert('获取GitHub认证URL失败', 'danger');
                    }
                };

                const loginWithGoogle = async () => {
                    try {
                        const response = await fetch('./auth/login/google');
                        const data = await response.json();
                        localStorage.setItem('loginSource', 'google');
                        window.location.href = data.auth_url;
                    } catch (error) {
                        showAlert('获取Google认证URL失败', 'danger');
                    }
                };

                // 发送短信验证码
                const sendSmsCode = async () => {
                    if (!phoneNumber.value) {
                        showAlert('请输入手机号', 'warning');
                        return;
                    }

                    // 简单的手机号格式验证
                    const phoneRegex = /^1[3-9]\d{9}$/;
                    if (!phoneRegex.test(phoneNumber.value)) {
                        showAlert('请输入正确的手机号格式', 'warning');
                        return;
                    }

                    try {
                        loginLoading.value = true;
                        const response = await fetch(`./auth/login/sms?phone_number=${phoneNumber.value}`);
                        const data = await response.json();

                        if (response.ok) {
                            showAlert('验证码已发送，请查收短信', 'success');
                            // 开始倒计时
                            startSmsCountdown();
                        } else {
                            showAlert(data.message || '发送验证码失败', 'danger');
                        }
                    } catch (error) {
                        showAlert('发送验证码失败，请重试', 'danger');
                    } finally {
                        loginLoading.value = false;
                    }
                };

                // 短信验证码登录
                const loginWithSms = async () => {
                    if (!phoneNumber.value || !verifyCode.value) {
                        showAlert('请输入手机号和验证码', 'warning');
                        return;
                    }

                    try {
                        loginLoading.value = true;
                        const response = await fetch(`./auth/callback/sms?phone_number=${phoneNumber.value}&verify_code=${verifyCode.value}`);
                        const data = await response.json();

                        if (response.ok) {
                            localStorage.setItem('accessToken', data.access_token);
                            localStorage.setItem('currentUser', JSON.stringify(data.user_info));
                            currentUser.value = data.user_info;
                            isLoggedIn.value = true;

                            // 登录成功后初始化数据
                            await init();

                            showAlert('登录成功', 'success');
                        } else {
                            showAlert(data.message || '验证码错误或已过期', 'danger');
                        }
                    } catch (error) {
                        showAlert('登录失败，请重试', 'danger');
                    } finally {
                        loginLoading.value = false;
                    }
                };

                // 短信验证码倒计时
                const startSmsCountdown = () => {
                    smsCountdown.value = 60;
                    const timer = setInterval(() => {
                        smsCountdown.value--;
                        if (smsCountdown.value <= 0) {
                            clearInterval(timer);
                        }
                    }, 1000);
                };

                // 切换短信登录表单显示
                const toggleSmsLogin = () => {
                    showSmsForm.value = !showSmsForm.value;
                    if (!showSmsForm.value) {
                        // 重置表单数据
                        phoneNumber.value = '';
                        verifyCode.value = '';
                        smsCountdown.value = 0;
                    }
                };

                const handleLoginCallback = async (code, source) => {
                    try {
                        const response = await fetch(`./auth/callback/${source}?code=${code}`);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(data);
                            localStorage.setItem('accessToken', data.access_token);
                            localStorage.setItem('currentUser', JSON.stringify(data.user_info));
                            currentUser.value = data.user_info;
                            isLoggedIn.value = true;
                            
                            // 登录成功后初始化数据
                            await init();
                            
                            // 清除URL中的code参数
                            window.history.replaceState({}, document.title, window.location.pathname);
                        } else {
                            const error = await response.json();
                            showAlert(`登录失败: ${error.detail}`, 'danger');
                        }
                    } catch (error) {
                        showAlert('登录过程中发生错误', 'danger');
                        console.error(error);
                    }
                };

                const logout = () => {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('currentUser');
                    clearAllCache();

                    currentUser.value = {};
                    isLoggedIn.value = false;
                    models.value = [];
                    tasks.value = [];
                    showAlert('已退出登录', 'info');
                };

                const loadModels = async () => {
                    try {
                        // 先尝试从缓存加载
                        const cachedModels = loadFromCache(MODELS_CACHE_KEY, MODELS_CACHE_EXPIRY);
                        if (cachedModels) {
                            console.log('从缓存加载模型列表');
                            models.value = cachedModels;
                            return;
                        }

                        console.log('开始加载模型列表...');
                        const response = await apiRequest('./api/v1/model/list');
                        if (response && response.ok) {
                            const data = await response.json();
                            console.log('模型列表数据:', data);
                            const modelsData = data.models || [];
                            models.value = modelsData;
                            
                            // 保存到缓存
                            saveToCache(MODELS_CACHE_KEY, modelsData);
                            console.log('模型列表已缓存');
                        } else if (response) {
                            console.error('模型列表API响应失败:', response);
                            showAlert('加载模型列表失败', 'danger');
                        }
                        // 如果response为null，说明是认证错误，apiRequest已经处理了
                    } catch (error) {
                        console.error('加载模型失败:', error);
                        showAlert(`加载模型失败: ${error.message}`, 'danger');
                    }
                };

                // 加载模板文件
                const loadTemplates = async (forceRefresh = false) => {
                    try {
                        // 如果不是强制刷新，先尝试从缓存加载
                        if (!forceRefresh) {
                        const cachedTemplates = loadFromCache(TEMPLATES_CACHE_KEY, TEMPLATES_CACHE_EXPIRY);
                        if (cachedTemplates) {
                            console.log('从缓存加载模板列表');
                            imageTemplates.value = cachedTemplates.images || [];
                            audioTemplates.value = cachedTemplates.audios || [];
                                
                                // 后台检查更新
                                checkTemplateUpdates();
                            return;
                            }
                        }

                        const response = await apiCall('./api/v1/template/list');
                        if (response.ok) {
                            const data = await response.json();
                            const templatesData = {
                                images: data.templates.images || [],
                                audios: data.templates.audios || []
                            };
                            
                            // 检查是否有更新
                            const hasUpdates = checkTemplateChanges(templatesData);
                            
                            imageTemplates.value = templatesData.images;
                            audioTemplates.value = templatesData.audios;
                            
                            // 保存到缓存
                            saveToCache(TEMPLATES_CACHE_KEY, templatesData);
                            console.log('素材库已缓存', hasUpdates ? '(有更新)' : '');
                            
                            if (hasUpdates) {
                                showAlert('素材库有更新', 'info');
                            }
                        } else {
                            console.warn('加载素材库失败');
                        }
                    } catch (error) {
                        console.warn('加载素材库失败:', error);
                    }
                };

                // 检查素材库更新
                const checkTemplateUpdates = async () => {
                    try {
                        const response = await apiCall('./api/v1/template/list');
                        if (response.ok) {
                            const data = await response.json();
                            const newTemplatesData = {
                                images: data.templates.images || [],
                                audios: data.templates.audios || []
                            };
                            
                            const hasUpdates = checkTemplateChanges(newTemplatesData);
                            if (hasUpdates) {
                                // 更新素材数据
                                imageTemplates.value = newTemplatesData.images;
                                audioTemplates.value = newTemplatesData.audios;
                                
                                // 更新缓存
                                saveToCache(TEMPLATES_CACHE_KEY, newTemplatesData);
                                showAlert('素材库已更新', 'info');
                            }
                        }
                    } catch (error) {
                        console.warn('检查素材库更新失败:', error);
                    }
                };

                // 检查模板变化
                const checkTemplateChanges = (newTemplates) => {
                    const currentImages = imageTemplates.value || [];
                    const currentAudios = audioTemplates.value || [];
                    const newImages = newTemplates.images || [];
                    const newAudios = newTemplates.audios || [];
                    
                    // 比较数量
                    if (currentImages.length !== newImages.length || currentAudios.length !== newAudios.length) {
                        return true;
                    }
                    
                    // 比较图片模板ID
                    const currentImageIds = currentImages.map(t => t.id).sort();
                    const newImageIds = newImages.map(t => t.id).sort();
                    if (JSON.stringify(currentImageIds) !== JSON.stringify(newImageIds)) {
                        return true;
                    }
                    
                    // 比较音频模板ID
                    const currentAudioIds = currentAudios.map(t => t.id).sort();
                    const newAudioIds = newAudios.map(t => t.id).sort();
                    if (JSON.stringify(currentAudioIds) !== JSON.stringify(newAudioIds)) {
                        return true;
                    }
                    
                    return false;
                };

                // 获取素材文件的通用函数（带缓存）
                const getTemplateFile = async (template) => {
                    const cacheKey = template.url;
                    
                    // 先检查内存缓存
                    if (templateFileCache.value.has(cacheKey)) {
                        console.log('从内存缓存获取素材文件:', template.filename);
                        return templateFileCache.value.get(cacheKey);
                    }
                    
                    // 如果缓存中没有，则下载并缓存
                    console.log('下载素材文件:', template.filename);
                    const response = await fetch(template.url, {
                        cache: 'force-cache' // 强制使用浏览器缓存
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const file = new File([blob], template.filename, { type: blob.type });
                        
                        // 缓存文件对象
                        templateFileCache.value.set(cacheKey, file);
                        return file;
                    } else {
                        throw new Error('下载素材文件失败');
                    }
                };

                // 选择图片素材
                const selectImageTemplate = async (template) => {
                    try {
                        const file = await getTemplateFile(template);

                        if (selectedTaskId.value === 'i2v') {
                            i2vForm.value.imageFile = file;
                        } else if (selectedTaskId.value === 's2v') {
                            s2vForm.value.imageFile = file;
                        }

                        // 创建预览
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            setCurrentImagePreview(e.target.result);
                        };
                        reader.readAsDataURL(file);

                        showImageTemplates.value = false;
                        showAlert('图片素材已选择', 'success');
                    } catch (error) {
                        showAlert(`加载图片素材失败: ${error.message}`, 'danger');
                    }
                };

                // 选择音频素材
                const selectAudioTemplate = async (template) => {
                    try {
                        const file = await getTemplateFile(template);

                        s2vForm.value.audioFile = file;

                        // 创建预览
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            setCurrentAudioPreview(e.target.result);
                        };
                        reader.readAsDataURL(file);

                        showAudioTemplates.value = false;
                        showAlert('音频素材已选择', 'success');
                    } catch (error) {
                        showAlert(`加载音频素材失败: ${error.message}`, 'danger');
                    }
                };

                // 预览音频素材
                const previewAudioTemplate = (template) => {
                    const audio = new Audio(template.url);
                    audio.play().catch(error => {
                        console.error('音频播放失败:', error);
                        showAlert('音频播放失败', 'danger');
                    });
                };

                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        if (selectedTaskId.value === 'i2v') {
                            i2vForm.value.imageFile = file;
                        } else if (selectedTaskId.value === 's2v') {
                            s2vForm.value.imageFile = file;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            setCurrentImagePreview(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // 用户取消了选择，保持原有图片不变
                        // 不做任何操作
                    }
                };

                const selectTask = (taskType) => {
                    selectedTaskId.value = taskType;

                    // 根据任务类型恢复对应的预览
                    if (taskType === 'i2v' && i2vForm.value.imageFile) {
                        // 恢复图片预览
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            setCurrentImagePreview(e.target.result);
                        };
                        reader.readAsDataURL(i2vForm.value.imageFile);
                    } else if (taskType === 's2v') {
                        // 恢复数字人任务的图片和音频预览
                        if (s2vForm.value.imageFile) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                setCurrentImagePreview(e.target.result);
                            };
                            reader.readAsDataURL(s2vForm.value.imageFile);
                        }
                        if (s2vForm.value.audioFile) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                setCurrentAudioPreview(e.target.result);
                            };
                            reader.readAsDataURL(s2vForm.value.audioFile);
                        }
                    }

                    // 如果当前表单没有选择模型，自动选择第一个可用的模型
                    const currentForm = getCurrentForm();
                    if (!currentForm.model_cls) {
                    const availableModels = models.value.filter(m => m.task === taskType);
                    if (availableModels.length > 0) {
                        const firstModel = availableModels[0];
                            currentForm.model_cls = firstModel.model_cls;
                            currentForm.stage = firstModel.stage;
                        }
                    }
                };

                const selectModel = (model) => {
                    getCurrentForm().model_cls = model;
                };

                const triggerImageUpload = () => {
                    document.querySelector('input[type="file"][accept="image/*"]').click();
                };

                const triggerAudioUpload = () => {
                    document.querySelector('input[type="file"][accept="audio/*"]').click();
                };

                const removeImage = () => {
                    setCurrentImagePreview(null);
                    if (selectedTaskId.value === 'i2v') {
                        i2vForm.value.imageFile = null;
                    } else if (selectedTaskId.value === 's2v') {
                        s2vForm.value.imageFile = null;
                    }
                    // 重置文件输入框，确保可以重新选择相同文件
                    const imageInput = document.querySelector('input[type="file"][accept="image/*"]');
                    if (imageInput) {
                        imageInput.value = '';
                    }
                };

                const removeAudio = () => {
                    setCurrentAudioPreview(null);
                    s2vForm.value.audioFile = null;
                    console.log('音频已移除');
                    // 重置音频文件输入框，确保可以重新选择相同文件
                    const audioInput = document.querySelector('input[type="file"][accept="audio/*"]');
                    if (audioInput) {
                        audioInput.value = '';
                    }
                };

                const getAudioMimeType = () => {
                    if (s2vForm.value.audioFile) {
                        return s2vForm.value.audioFile.type;
                    }
                    return 'audio/mpeg'; // 默认类型
                };

                const handleAudioUpload = (event) => {
                    const file = event.target.files[0];

                    if (file) {
                        s2vForm.value.audioFile = file;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            setCurrentAudioPreview(e.target.result);
                            console.log('音频预览已设置:', e.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        setCurrentAudioPreview(null);
                    }
                };

                const submitTask = async () => {
                    try {
                        const currentForm = getCurrentForm();

                        // 表单验证
                        if (!selectedTaskId.value) {
                            showAlert('请选择任务类型', 'warning');
                            return;
                        }

                        if (!currentForm.model_cls) {
                            showAlert('请选择模型', 'warning');
                            return;
                        }

                        if (!currentForm.prompt || currentForm.prompt.trim().length === 0) {
                            showAlert('请输入提示词', 'warning');
                            return;
                        }

                        if (currentForm.prompt.length > 500) {
                            showAlert('提示词长度不能超过500个字符', 'warning');
                            return;
                        }

                        if (selectedTaskId.value === 'i2v' && !currentForm.imageFile) {
                            showAlert('图生视频任务需要上传参考图片', 'warning');
                            return;
                        }

                        if (selectedTaskId.value === 's2v' && !currentForm.imageFile) {
                            showAlert('数字人任务需要上传参考图片', 'warning');
                            return;
                        }

                        if (selectedTaskId.value === 's2v' && !currentForm.audioFile) {
                            showAlert('数字人任务需要上传音频文件', 'warning');
                            return;
                        }
                        submitting.value = true;

                        // 确定实际提交的任务类型
                        let actualTaskType = selectedTaskId.value;

                        var formData = {
                            task: actualTaskType,
                            model_cls: currentForm.model_cls,
                            stage: currentForm.stage,
                            prompt: currentForm.prompt.trim(),
                            seed: currentForm.seed || Math.floor(Math.random() * 1000000)
                        };

                        if (currentForm.model_cls.startsWith('wan2.1')) {
                            formData.negative_prompt = "镜头晃动，色调艳丽，过曝，静态，细节模糊不清，字幕，风格，作品，画作，画面，静止，整体发灰，最差质量，低质量，JPEG压缩残留，丑陋的，残缺的，多余的手指，画得不好的手部，画得不好的脸部，畸形的，毁容的，形态畸形的肢体，手指融合，静止不动的画面，杂乱的背景，三条腿，背景人很多，倒着走"
                        }

                        if (selectedTaskId.value === 'i2v' && currentForm.imageFile) {
                            const base64 = await fileToBase64(currentForm.imageFile);
                            formData.input_image = {
                                type: 'base64',
                                data: base64
                            };
                        }

                        if (selectedTaskId.value === 's2v') {
                            if (currentForm.imageFile) {
                                const base64 = await fileToBase64(currentForm.imageFile);
                                formData.input_image = {
                                    type: 'base64',
                                    data: base64
                                };
                            }
                            if (currentForm.audioFile) {
                                const base64 = await fileToBase64(currentForm.audioFile);
                                formData.input_audio = {
                                    type: 'base64',
                                    data: base64
                                };
                                formData.negative_prompt = "色调艳丽，过曝，静态，细节模糊不清，字幕，风格，作品，画作，画面，静止，整体发灰，最差质量，低质量，JPEG压缩残留，丑陋的，残缺的，多余的手指，画得不好的手部，画得不好的脸部，畸形的，毁容的，形态畸形的肢体，手指融合，静止不动的画面，杂乱的背景，三条腿，背景人很多，倒着走"
                            }
                        }

                        const response = await apiRequest('./api/v1/task/submit', {
                            method: 'POST',
                            body: JSON.stringify(formData)
                        });

                        if (response && response.ok) {
                            const result = await response.json();
                            showAlert(`任务提交成功！`, 'success');

                            // 保存完整的任务历史（包括提示词、图片和音频）
                            addTaskToHistory(selectedTaskId.value, currentForm);

                            refreshTasks(true); // 强制刷新
                            
                            // 开始轮询新提交的任务状态
                            startPollingTask(result.task_id);
                            
                            await resetForm(selectedTaskId.value);
                            // 重置当前任务类型的表单（保留模型选择，清空图片、音频和提示词）
                            selectedTaskId.value=selectedTaskId.value;
                            selectModel(currentForm.model_cls);
                            switchToProjectsView();

                        } else {
                            const error = await response.json();
                            showAlert(`任务提交失败: ${error.message},${error.detail}`, 'danger');
                        }
                    } catch (error) {
                        showAlert(`提交任务失败: ${error.message}`, 'danger');
                    } finally {
                        submitting.value = false;
                    }
                };

                const fileToBase64 = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = error => reject(error);
                    });
                };

                const formatTime = (timestamp) => {
                    if (!timestamp) return '';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString('zh-CN');
                };


                // 通用缓存管理函数
                const loadFromCache = (cacheKey, expiryKey) => {
                    try {
                        const cached = localStorage.getItem(cacheKey);
                        if (cached) {
                            const data = JSON.parse(cached);
                            if (Date.now() - data.timestamp < expiryKey) {
                                return data.data;
                            } else {
                                // 缓存过期，清除
                                localStorage.removeItem(cacheKey);
                            }
                        }
                    } catch (error) {
                        console.warn(`加载缓存失败 ${cacheKey}:`, error);
                        localStorage.removeItem(cacheKey);
                    }
                    return null;
                };

                const saveToCache = (cacheKey, data) => {
                    try {
                        const cacheData = {
                            data: data,
                            timestamp: Date.now()
                        };
                        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                    } catch (error) {
                        console.warn(`保存缓存失败 ${cacheKey}:`, error);
                    }
                };

                // 清除所有应用缓存
                const clearAllCache = () => {
                    try {
                        const cacheKeys = [
                            TASK_FILE_CACHE_KEY,
                            MODELS_CACHE_KEY,
                            TEMPLATES_CACHE_KEY
                        ];
                        
                        // 清除所有任务缓存（使用通配符匹配）
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(TASKS_CACHE_KEY)) {
                                localStorage.removeItem(key);
                            }
                        }
                        
                        // 清除其他缓存
                        cacheKeys.forEach(key => {
                            localStorage.removeItem(key);
                        });
                        
                        // 清除内存中的任务文件缓存
                        taskFileCache.value.clear();
                        taskFileCacheLoaded.value = false;
                        
                        console.log('所有缓存已清除');
                    } catch (error) {
                        console.warn('清除缓存失败:', error);
                    }
                };

                // 任务文件缓存管理函数
                const loadTaskFilesFromCache = () => {
                    try {
                        const cached = localStorage.getItem(TASK_FILE_CACHE_KEY);
                        if (cached) {
                            const data = JSON.parse(cached);
                            // 检查是否过期
                            if (Date.now() - data.timestamp < TASK_FILE_CACHE_EXPIRY) {
                                // 将缓存数据加载到内存缓存中
                                for (const [cacheKey, fileData] of Object.entries(data.files)) {
                                    taskFileCache.value.set(cacheKey, fileData);
                                }
                                return true;
                            } else {
                                // 缓存过期，清除
                                localStorage.removeItem(TASK_FILE_CACHE_KEY);
                            }
                        }
                    } catch (error) {
                        console.warn('加载任务文件缓存失败:', error);
                        localStorage.removeItem(TASK_FILE_CACHE_KEY);
                    }
                    return false;
                };

                const saveTaskFilesToCache = () => {
                    try {
                        const files = {};
                        for (const [cacheKey, fileData] of taskFileCache.value.entries()) {
                            files[cacheKey] = fileData;
                        }
                        const data = {
                            files,
                            timestamp: Date.now()
                        };
                        localStorage.setItem(TASK_FILE_CACHE_KEY, JSON.stringify(data));
                    } catch (error) {
                        console.warn('保存任务文件缓存失败:', error);
                    }
                };

                // 生成缓存键
                const getTaskFileCacheKey = (taskId, fileKey) => {
                    return `${taskId}_${fileKey}`;
                };

                // 从缓存获取任务文件
                const getTaskFileFromCache = (taskId, fileKey) => {
                    const cacheKey = getTaskFileCacheKey(taskId, fileKey);
                    return taskFileCache.value.get(cacheKey) || null;
                };

                // 设置任务文件到缓存
                const setTaskFileToCache = (taskId, fileKey, fileData) => {
                    const cacheKey = getTaskFileCacheKey(taskId, fileKey);
                    taskFileCache.value.set(cacheKey, fileData);
                    // 异步保存到localStorage
                    setTimeout(() => {
                        saveTaskFilesToCache();
                    }, 100);
                };

                const getTaskFileUrlFromApi = async (taskId, fileKey) => {
                    let apiUrl = `./api/v1/task/input_url?task_id=${taskId}&name=${fileKey}`;
                    if (fileKey.includes('output')) {
                        apiUrl = `./api/v1/task/result_url?task_id=${taskId}&name=${fileKey}`;
                    }
                    const response = await apiRequest(apiUrl);
                    if (response && response.ok) {
                        const data = await response.json();
                        let assertUrl = data.url;
                        if (assertUrl.startsWith('./assets/')) {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                assertUrl = `${assertUrl}&token=${encodeURIComponent(token)}`;
                            }
                        }
                        setTaskFileToCache(taskId, fileKey, {
                            url: assertUrl,
                            timestamp: Date.now()
                        });
                        return assertUrl;
                    }
                    return null;
                };

                // 获取任务文件URL（优先从缓存，缓存没有则调用后端）
                const getTaskFileUrl = async (taskId, fileKey) => {
                    // 先从缓存获取
                    const cachedFile = getTaskFileFromCache(taskId, fileKey);
                    if (cachedFile) {
                        return cachedFile.url;
                    }
                    return await getTaskFileUrlFromApi(taskId, fileKey);
                };

                // 获取任务的第一个图片键
                const getFirstImageKey = (task) => {
                    if (!task || !task.inputs) return null;
                    
                    const imageInputs = Object.keys(task.inputs).filter(key =>
                        key.includes('image') ||
                        task.inputs[key].toString().toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)
                    );
                    
                    return imageInputs.length > 0 ? imageInputs[0] : null;
                };

                // 同步获取任务文件URL（仅从缓存获取，用于模板显示）
                const getTaskFileUrlSync = (taskId, fileKey) => {
                    const cachedFile = getTaskFileFromCache(taskId, fileKey);
                    if (cachedFile) {
                        console.log('getTaskFileUrlSync: 从缓存获取', { taskId, fileKey, url: cachedFile.url, type: typeof cachedFile.url });
                        return cachedFile.url;
                    }
                    console.log('getTaskFileUrlSync: 缓存中没有找到', { taskId, fileKey });
                    return null;
                };

                // 预加载任务文件
                const preloadTaskFiles = async (tasks) => {
                    if (!tasks || tasks.length === 0) return;

                    // 先尝试从localStorage加载缓存
                    if (taskFileCache.value.size === 0) {
                        loadTaskFilesFromCache();
                    }

                    console.log(`开始预加载 ${tasks.length} 个任务的文件`);

                    // 分批预加载，避免过多并发请求
                    const batchSize = 5;
                    for (let i = 0; i < tasks.length; i += batchSize) {
                        const batch = tasks.slice(i, i + batchSize);
                        
                        const promises = batch.map(async (task) => {
                            if (!task.task_id) return;

                            // 预加载输入图片
                            if (task.inputs) {
                                const imageInputs = Object.keys(task.inputs).filter(key =>
                                    key.includes('image') ||
                                    task.inputs[key].toString().toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)
                                );
                                
                                for (const imageKey of imageInputs) {
                                    await getTaskFileUrl(task.task_id, imageKey);
                                }
                            }

                            // 预加载输出视频
                            if (task.outputs && task.outputs.output_video && task.status === 'SUCCEED') {
                                await getTaskFileUrl(task.task_id, 'output_video');
                            }
                        });

                        await Promise.all(promises);
                        
                        // 批次间添加延迟
                        if (i + batchSize < tasks.length) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }

                    console.log('任务文件预加载完成');
                };





                const refreshTasks = async (forceRefresh = false) => {
                    try {
                        console.log('开始刷新任务列表, forceRefresh:', forceRefresh, 'currentPage:', currentPage.value);
                        
                        // 构建缓存键，包含分页和过滤条件
                        const cacheKey = `${TASKS_CACHE_KEY}_${currentPage.value}_${pageSize.value}_${statusFilter.value}`;
                        
                        // 如果不是强制刷新，先尝试从缓存加载
                        if (!forceRefresh) {
                            const cachedTasks = loadFromCache(cacheKey, TASKS_CACHE_EXPIRY);
                            if (cachedTasks) {
                                console.log('从缓存加载任务列表');
                                tasks.value = cachedTasks.tasks || [];
                                pagination.value = cachedTasks.pagination || null;
                                // 强制触发响应式更新
                                await nextTick();
                                // 强制刷新分页组件
                                paginationKey.value++;
                                // 使用新的任务文件预加载逻辑
                                await preloadTaskFiles(tasks.value);
                                return;
                            }
                        }

                        const params = new URLSearchParams({
                            page: currentPage.value.toString(),
                            page_size: pageSize.value.toString()
                        });

                        if (statusFilter.value !== 'ALL') {
                            params.append('status', statusFilter.value);
                        }

                        console.log('请求任务列表API:', `./api/v1/task/list?${params.toString()}`);
                        const response = await apiRequest(`./api/v1/task/list?${params.toString()}`);
                        if (response && response.ok) {
                            const data = await response.json();
                            console.log('任务列表API响应:', data);
                            
                            // 强制清空并重新赋值，确保Vue检测到变化
                            tasks.value = [];
                            pagination.value = null;
                            await nextTick();
                            
                            tasks.value = data.tasks || [];
                            pagination.value = data.pagination || null;
                            
                            console.log('更新后的tasks.value:', tasks.value);
                            console.log('更新后的pagination.value:', pagination.value);

                            // 保存到缓存
                            saveToCache(cacheKey, {
                                tasks: data.tasks || [],
                                pagination: data.pagination || null
                            });
                            console.log('任务列表已缓存');

                            // 强制触发响应式更新
                            await nextTick();
                            
                            // 强制刷新分页组件
                            paginationKey.value++;
                            
                            // 使用新的任务文件预加载逻辑
                            await preloadTaskFiles(tasks.value);
                        } else if (response) {
                            showAlert('刷新任务列表失败', 'danger');
                        }
                        // 如果response为null，说明是认证错误，apiRequest已经处理了
                    } catch (error) {
                        console.error('刷新任务列表失败:', error);
                        showAlert(`刷新任务列表失败: ${error.message}`, 'danger');
                    }
                };

                // 分页相关函数
                const goToPage = async (page) => {
                    if (page < 1 || page > pagination.value?.total_pages || page === currentPage.value) {
                        return;
                    }
                    currentPage.value = page;
                    pageInput.value = page; // 同步更新输入框
                    refreshTasks();
                };

                const jumpToPage = async () => {
                    const page = parseInt(pageInput.value);
                    if (page && page >= 1 && page <= pagination.value?.total_pages && page !== currentPage.value) {
                        await goToPage(page);
                    } else {
                        // 如果输入无效，恢复到当前页
                        pageInput.value = currentPage.value;
                    }
                };

                const getVisiblePages = () => {
                    if (!pagination.value) return [];
                    
                    const totalPages = pagination.value.total_pages;
                    const current = currentPage.value;
                    const pages = [];
                    
                    // 总是显示第一页
                    pages.push(1);
                    
                    if (totalPages <= 5) {
                        // 如果总页数少于等于7页，显示所有页码
                        for (let i = 2; i <= totalPages - 1; i++) {
                            pages.push(i);
                        }
                    } else {
                        // 如果总页数大于7页，使用省略号
                        if (current <= 3) {
                            // 当前页在前4页
                            for (let i = 2; i <= 3; i++) {
                                pages.push(i);
                            }
                            pages.push('...');
                        } else if (current >= totalPages - 2) {
                            // 当前页在后4页
                            pages.push('...');
                            for (let i = totalPages - 2; i <= totalPages - 1; i++) {
                                pages.push(i);
                            }
                        } else {
                            // 当前页在中间
                            pages.push('...');
                            for (let i = current - 1; i <= current + 1; i++) {
                                pages.push(i);
                            }
                            pages.push('...');
                        }
                    }
                    
                    // 总是显示最后一页（如果不是第一页）
                    if (totalPages > 1) {
                        pages.push(totalPages);
                    }
                    
                    return pages;
                };

                const getStatusBadgeClass = (status) => {
                    const statusMap = {
                        'SUCCEED': 'bg-success',
                        'FAILED': 'bg-danger',
                        'RUNNING': 'bg-warning',
                        'PENDING': 'bg-secondary',
                        'CREATED': 'bg-secondary'
                    };
                    return statusMap[status] || 'bg-secondary';
                };

                const downloadSingleResult = async (taskId, key, outputPath) => {
                    try {
                        downloadLoading.value = true;

                        const url = await getTaskFileUrl(taskId, key);
                        if (url) {
                            const response = await fetch(url);
                            if (response.ok) {
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                // 使用原始文件名，如果没有则使用outputPath
                                const filename = key || outputPath || `result_${taskId}`;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                window.URL.revokeObjectURL(url);
                                showAlert('文件下载成功', 'success');
                            } else {
                                showAlert('获取结果失败', 'danger');
                            }
                        } else {
                            showAlert('获取结果失败', 'danger');
                        }
                    } catch (error) {
                        showAlert(`下载结果失败: ${error.message}`, 'danger');
                    } finally {
                        downloadLoading.value = false;
                    }
                };

                const viewSingleResult = async (taskId, key) => {
                    try {
                        downloadLoading.value = true;
                        const url = await getTaskFileUrl(taskId, key);
                        if (url) {
                            const response = await fetch(url);
                            if (response.ok) {
                                const blob = await response.blob();
                                const videoBlob = new Blob([blob], { type: 'video/mp4' });
                                const url = window.URL.createObjectURL(videoBlob);
                                window.open(url, '_blank');
                            } else {
                                showAlert('获取结果失败', 'danger');
                            }
                        } else {
                            showAlert('获取结果失败', 'danger');
                        }
                    } catch (error) {
                        showAlert(`查看结果失败: ${error.message}`, 'danger');
                    } finally {
                        downloadLoading.value = false;
                    }
                };

                const getVideoUrl = (taskId, key) => {
                    // 优先从缓存获取
                    const cachedUrl = getTaskFileUrlSync(taskId, key);
                    if (cachedUrl) {
                        console.log('getVideoUrl: 从缓存获取', { taskId, key, url: cachedUrl });
                        return cachedUrl;
                    }
                    // 缓存没有则生成URL并缓存
                    const token = localStorage.getItem('accessToken');
                    const url = token 
                        ? `./assets/task/result?task_id=${taskId}&name=${key}&token=${encodeURIComponent(token)}`
                        : `./assets/task/result?task_id=${taskId}&name=${key}`;
                    
                    // 缓存API URL
                    setTaskFileToCache(taskId, key, {
                        url: url,
                        timestamp: Date.now()
                    });
                    
                    console.log('getVideoUrl: 生成并缓存视频URL', { taskId, key, url });
                    return url;
                };

                const cancelTask = async (taskId, fromDetailPage = false) => {
                    try {
                        // 显示确认对话框
                        const confirmed = await showConfirmDialog({
                            title: '取消任务？',
                            message: '取消任务后任务将停止执行，已生成的部分结果可能丢失，可以稍后重新生成。',
                            confirmText: '取消',
                        });
                        
                        if (!confirmed) {
                            return;
                        }

                        const response = await apiRequest(`./api/v1/task/cancel?task_id=${taskId}`);
                        if (response && response.ok) {
                            showAlert('任务取消成功', 'success');
                            
                            // 如果当前在任务详情界面，先刷新任务列表，然后重新获取任务信息
                            if (fromDetailPage) {
                                refreshTasks(true); // 强制刷新
                                const updatedTask = tasks.value.find(t => t.task_id === taskId);
                                if (updatedTask) {
                                    selectedTask.value = updatedTask;
                                }
                                await nextTick();
                            } else {
                                refreshTasks(true); // 强制刷新
                            }
                                
                        } else if (response) {
                            const error = await response.json();
                            showAlert(`取消任务失败: ${error.message}`, 'danger');
                        }
                        // 如果response为null，说明是认证错误，apiRequest已经处理了
                    } catch (error) {
                        showAlert(`取消任务失败: ${error.message}`, 'danger');
                    }
                };

                const resumeTask = async (taskId, fromDetailPage = false) => {
                    try {
                        const response = await apiRequest(`./api/v1/task/resume?task_id=${taskId}`);
                        if (response && response.ok) {
                            showAlert('任务重试成功', 'success');
                            
                            // 如果当前在任务详情界面，先刷新任务列表，然后重新获取任务信息
                            if (fromDetailPage) {
                                refreshTasks(true); // 强制刷新
                                const updatedTask = tasks.value.find(t => t.task_id === taskId);
                                if (updatedTask) {
                                    selectedTask.value = updatedTask;
                                }
                                startPollingTask(taskId);
                                await nextTick();
                            } else {
                                refreshTasks(true); // 强制刷新
                                
                                // 开始轮询新提交的任务状态
                                startPollingTask(taskId);
                            }
                        } else if (response) {
                            const error = await response.json();
                            showAlert(`重试任务失败: ${error.message}`, 'danger');
                        }
                        // 如果response为null，说明是认证错误，apiRequest已经处理了
                    } catch (error) {
                        showAlert(`重试任务失败: ${error.message}`, 'danger');
                    }
                };

                // 切换任务菜单显示状态
                const toggleTaskMenu = (taskId) => {
                    // 先关闭所有其他菜单
                    closeAllTaskMenus();
                    // 然后打开当前菜单
                    taskMenuVisible.value[taskId] = true;
                };

                // 关闭所有任务菜单
                const closeAllTaskMenus = () => {
                    taskMenuVisible.value = {};
                };

                // 点击外部关闭菜单
                const handleClickOutside = (event) => {
                    if (!event.target.closest('.task-menu-container')) {
                        closeAllTaskMenus();
                    }
                };

                const deleteTask = async (taskId, fromDetailPage = false) => {
                    try {
                        // 显示确认对话框
                        const confirmed = await showConfirmDialog({
                            title: '删除任务？',
                            message: '删除后无法恢复，包括任务记录、生成的文件、相关数据。此操作不可撤销！',
                            confirmText: '删除'
                        });
                        
                        if (!confirmed) {
                            return;
                        }

                        // 显示删除中的提示
                        showAlert('正在删除任务...', 'info');

                        const response = await apiRequest(`./api/v1/task/delete?task_id=${taskId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response && response.ok) {
                            showAlert('任务删除成功', 'success');
                            refreshTasks(true); // 强制刷新
                            
                            // 如果是从任务详情页删除，则跳转回主页
                            if (fromDetailPage) {
                                if (!selectedTaskId.value) {
                                    if (availableTaskTypes.value.includes('s2v')) {
                                        selectTask('s2v');
                                    }
                                }
                            }
                        } else if (response) {
                            const error = await response.json();
                            showAlert(`删除任务失败: ${error.message}`, 'danger');
                        }
                        // 如果response为null，说明是认证错误，apiRequest已经处理了
                    } catch (error) {
                        showAlert(`删除任务失败: ${error.message}`, 'danger');
                    }
                };



                const loadTaskFiles = async (taskId) => {
                    try {
                        loadingTaskFiles.value = true;

                        // 通过API获取任务详情
                        const response = await apiRequest(`./api/v1/task/query?task_id=${taskId}`);
                        if (!response || !response.ok) {
                            showAlert('获取任务详情失败', 'danger');
                            return;
                        }

                        const task = await response.json();
                        if (!task) {
                            showAlert('任务不存在', 'danger');
                            return;
                        }

                        const files = { inputs: {}, outputs: {} };

                        // 获取输入文件（所有状态的任务都需要）
                        if (task.inputs) {
                            for (const [key, inputPath] of Object.entries(task.inputs)) {
                                try {
                                    const url = await getTaskFileUrl(taskId, key);
                                    if (url) {
                                        const response = await fetch(url);
                                        if (response && response.ok) {
                                            const blob = await response.blob()
                                            files.inputs[key] = {
                                                name: inputPath, // 使用原始文件名而不是key
                                                path: inputPath,
                                                blob: blob,
                                                url: URL.createObjectURL(blob)
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error(`Failed to load input ${key}:`, error);
                                    files.inputs[key] = {
                                        name: inputPath, // 使用原始文件名而不是key
                                        path: inputPath,
                                        error: true
                                    };
                                }
                            }
                        }

                        // 只对成功完成的任务获取输出文件
                        if (task.status === 'SUCCEED' && task.outputs) {
                            for (const [key, outputPath] of Object.entries(task.outputs)) {
                                try {
                                    const url = await getTaskFileUrl(taskId, key);
                                    if (url) {
                                        const response = await fetch(url);
                                        if (response && response.ok) {
                                            const blob = await response.blob()
                                            files.outputs[key] = {
                                                name: outputPath, // 使用原始文件名而不是key
                                                path: outputPath,
                                                blob: blob,
                                                url: URL.createObjectURL(blob)
                                            }
                                        };
                                    }
                                } catch (error) {
                                    console.error(`Failed to load output ${key}:`, error);
                                    files.outputs[key] = {
                                        name: outputPath, // 使用原始文件名而不是key
                                        path: outputPath,
                                        error: true
                                    };
                                }
                            }
                        }

                        selectedTaskFiles.value = files;

                    } catch (error) {
                        console.error('Failed to load task files:', error);
                        showAlert('加载任务文件失败', 'danger');
                    } finally {
                        loadingTaskFiles.value = false;
                    }
                };

                const viewTaskDetail = async (task) => {
                    selectedTask.value = task;
                    selectedTaskId.value = task.task_type;

                    try {
                    const response = await apiRequest(`./api/v1/task/query?task_id=${task.task_id}`);
                        if (response && response.ok) {
                            const updatedTask = await response.json();
                            selectedTask.value = updatedTask;
                            console.log('updated task data:', updatedTask);
                            await nextTick();
                        }
                    } catch (error) {
                        console.warn('Failed to fetch updated task data:', error);
                    }
                    // 如果任务还在进行中，开始轮询状态
                    if (['CREATED', 'PENDING', 'RUNNING'].includes(task.status)) {

                        startPollingTask(task.task_id);
                    }

                    // 一次性加载所有任务文件
                    await loadTaskFiles(task.task_id);
                };

                const reuseTask = async (task) => {
                    try {
                        // 跳转到任务创建界面
                        switchToCreateView();
                        
                        // 设置任务类型
                        selectedTaskId.value = task.task_type;
                        console.log('selectedTaskId.value', selectedTaskId.value);
                        
                        // 获取当前表单
                        const currentForm = getCurrentForm();
                        
                        // 设置模型
                        if (task.params && task.params.model_cls) {
                            currentForm.model_cls = task.params.model_cls;
                        }
                        
                        // 设置prompt
                        if (task.params && task.params.prompt) {
                            currentForm.prompt = task.params.prompt;
                        }
                        
                        // 尝试从localStorage获取任务历史数据
                        const taskHistory = JSON.parse(localStorage.getItem('taskHistory') || '[]');
                        const historyItem = taskHistory.find(item => item.task_id === task.task_id);
                        
                        if (historyItem) {
                            // 从localStorage恢复图片和音频
                            if (historyItem.imageFile && historyItem.imageFile.blob) {
                                // 重新创建File对象
                                const imageFile = new File([historyItem.imageFile.blob], historyItem.imageFile.name, { type: historyItem.imageFile.type });
                                currentForm.imageFile = imageFile;
                                setCurrentImagePreview(URL.createObjectURL(imageFile));
                            }
                            
                            if (historyItem.audioFile && historyItem.audioFile.blob) {
                                // 重新创建File对象
                                let mimeType = historyItem.audioFile.type;
                                if (!mimeType || mimeType === 'application/octet-stream') {
                                    const filename = historyItem.audioFile.name || 'audio.wav';
                                    const ext = filename.toLowerCase().split('.').pop();
                                    const mimeTypes = {
                                        'mp3': 'audio/mpeg',
                                        'wav': 'audio/wav',
                                        'mp4': 'audio/mp4',
                                        'aac': 'audio/aac',
                                        'ogg': 'audio/ogg',
                                        'm4a': 'audio/mp4'
                                    };
                                    mimeType = mimeTypes[ext] || 'audio/mpeg';
                                }
                                const audioFile = new File([historyItem.audioFile.blob], historyItem.audioFile.name, { type: mimeType });
                                currentForm.audioFile = audioFile;
                                console.log('复用任务 - 从localStorage恢复音频文件:', {
                                    name: audioFile.name,
                                    type: audioFile.type,
                                    size: audioFile.size
                                });
                                // 使用FileReader生成data URL，与正常上传保持一致
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    setCurrentAudioPreview(e.target.result);
                                    console.log('复用任务 - 音频预览已设置:', e.target.result.substring(0, 50) + '...');
                                };
                                reader.readAsDataURL(audioFile);
                            }
                        } else {
                            // 如果localStorage中没有，尝试从后端获取任务文件
                            try {
                                // 使用现有的函数获取图片和音频URL
                                const imageUrl = getTaskInputImage(task);
                                const audioUrl = getTaskInputAudio(task);
                                
                                // 加载图片文件
                                if (imageUrl) {
                                    try {
                                        const imageResponse = await fetch(imageUrl);
                                        if (imageResponse && imageResponse.ok) {
                                            const blob = await imageResponse.blob();
                                            const filename = task.inputs[Object.keys(task.inputs).find(key => 
                                                key.includes('image') || 
                                                task.inputs[key].toString().toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)
                                            )] || 'image.jpg';
                                            const file = new File([blob], filename, { type: blob.type });
                                            currentForm.imageFile = file;
                                            setCurrentImagePreview(URL.createObjectURL(file));
                                        }
                                    } catch (error) {
                                        console.warn('Failed to load image file:', error);
                                    }
                                }
                                
                                // 加载音频文件
                                if (audioUrl) {
                                    try {
                                        const audioResponse = await fetch(audioUrl);
                                        if (audioResponse && audioResponse.ok) {
                                            const blob = await audioResponse.blob();
                                            const filename = task.inputs[Object.keys(task.inputs).find(key => 
                                                key.includes('audio') || 
                                                task.inputs[key].toString().toLowerCase().match(/\.(mp3|wav|mp4|aac|ogg|m4a)$/)
                                            )] || 'audio.wav';
                                            
                                            // 根据文件扩展名确定正确的MIME类型
                                            let mimeType = blob.type;
                                            if (!mimeType || mimeType === 'application/octet-stream') {
                                                const ext = filename.toLowerCase().split('.').pop();
                                                const mimeTypes = {
                                                    'mp3': 'audio/mpeg',
                                                    'wav': 'audio/wav',
                                                    'mp4': 'audio/mp4',
                                                    'aac': 'audio/aac',
                                                    'ogg': 'audio/ogg',
                                                    'm4a': 'audio/mp4'
                                                };
                                                mimeType = mimeTypes[ext] || 'audio/mpeg';
                                            }
                                            
                                            const file = new File([blob], filename, { type: mimeType });
                                            currentForm.audioFile = file;
                                            console.log('复用任务 - 从后端加载音频文件:', {
                                                name: file.name,
                                                type: file.type,
                                                size: file.size,
                                                originalBlobType: blob.type
                                            });
                                            // 使用FileReader生成data URL，与正常上传保持一致
                                            const reader = new FileReader();
                                            reader.onload = (e) => {
                                                setCurrentAudioPreview(e.target.result);
                                                console.log('复用任务 - 音频预览已设置:', e.target.result.substring(0, 50) + '...');
                                            };
                                            reader.readAsDataURL(file);
                                        }
                                    } catch (error) {
                                        console.warn('Failed to load audio file:', error);
                                    }
                                }
                            } catch (error) {
                                console.warn('Failed to load task data from backend:', error);
                            }
                        }
                        
                        showAlert('任务素材复用成功', 'success');
                        
                    } catch (error) {
                        console.error('Failed to reuse task:', error);
                        showAlert('加载任务数据失败', 'danger');
                    }
                };

                const downloadFile = (fileInfo) => {
                    if (!fileInfo || !fileInfo.blob) {
                        showAlert('文件不可用', 'danger');
                        return;
                    }

                    try {
                        const url = URL.createObjectURL(fileInfo.blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileInfo.name || 'download';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('Download failed:', error);
                        showAlert('下载失败', 'danger');
                    }
                };

                const viewFile = (fileInfo) => {
                    if (!fileInfo || !fileInfo.url) {
                        showAlert('文件不可用', 'danger');
                        return;
                    }

                    // 在新窗口中打开文件
                    window.open(fileInfo.url, '_blank');
                };

                const clearTaskFiles = () => {
                    // 清理 URL 对象，释放内存
                    Object.values(selectedTaskFiles.value.inputs).forEach(file => {
                        if (file.url) {
                            URL.revokeObjectURL(file.url);
                        }
                    });
                    Object.values(selectedTaskFiles.value.outputs).forEach(file => {
                        if (file.url) {
                            URL.revokeObjectURL(file.url);
                        }
                    });
                    selectedTaskFiles.value = { inputs: {}, outputs: {} };
                };

                const showTaskCreator = () => {
                    selectedTask.value = null;
                    // clearTaskFiles(); // 清空文件缓存
                    selectedTaskId.value = 's2v'; // 默认选择数字人任务
                    
                    // 停止所有任务状态轮询
                    pollingTasks.value.clear();
                    if (pollingInterval.value) {
                        clearInterval(pollingInterval.value);
                        pollingInterval.value = null;
                    }
                };

                const toggleSidebar = () => {
                    sidebarCollapsed.value = !sidebarCollapsed.value;
                    
                    if (sidebarCollapsed.value) {
                        // 收起时，将历史任务栏隐藏到屏幕左侧
                        if (sidebar.value) {
                            sidebar.value.style.transform = 'translateX(-100%)';
                        }
                    } else {
                        // 展开时，恢复历史任务栏位置
                        if (sidebar.value) {
                            sidebar.value.style.transform = 'translateX(0)';
                        }
                    }
                    
                    // 更新悬浮按钮位置
                    updateFloatingButtonPosition(sidebarWidth.value);
                };

                const clearPrompt = () => {
                    getCurrentForm().prompt = '';
                };

                const getTaskItemClass = (status) => {
                    if (status === 'SUCCEED') return 'bg-laser-purple/15 border border-laser-purple/30';
                    if (status === 'RUNNING') return 'bg-laser-purple/15 border border-laser-purple/30';
                    if (status === 'FAILED') return 'bg-red-500/15 border border-red-500/30';
                    return 'bg-dark-light border border-gray-700';
                };

                const getStatusIndicatorClass = (status) => {
                const base = 'inline-block w-2 aspect-square rounded-full shrink-0 align-middle';
                    if (status === 'SUCCEED')
                        return `${base} bg-gradient-to-r from-emerald-200 to-green-300 shadow-md shadow-emerald-300/30`;
                    if (status === 'RUNNING')
                        return `${base} bg-gradient-to-r from-amber-200 to-yellow-300 shadow-md shadow-amber-300/30 animate-pulse`;
                    if (status === 'FAILED')
                        return `${base} bg-gradient-to-r from-red-200 to-pink-300 shadow-md shadow-red-300/30`;
                    return `${base} bg-gradient-to-r from-gray-200 to-gray-300 shadow-md shadow-gray-300/30`;
                    };


                const getTaskTypeBtnClass = (taskType) => {
                    if (selectedTaskId.value === taskType) {
                        return 'text-gradient-icon border-b-2 border-laser-purple';
                    }
                    return 'text-gray-400 hover:text-gradient-icon';
                };

                const getModelBtnClass = (model) => {
                    if (getCurrentForm().model_cls === model) {
                        return 'bg-laser-purple/20 border border-laser-purple/40 active shadow-laser animate-electric-pulse';
                    }
                    return 'bg-dark-light border border-gray-700 hover:bg-laser-purple/15 hover:border-laser-purple/40 transition-all hover:shadow-laser';
                };

                const getTaskTypeIcon = (taskType) => {
                    const iconMap = {
                        't2v': 'fas fa-font',
                        'i2v': 'fas fa-image',
                        's2v': 'fas fa-user'
                    };
                    return iconMap[taskType] || 'fas fa-video';
                };

                const getTaskTypeName = (task) => {
                    // 如果传入的是字符串，直接返回映射
                    if (typeof task === 'string') {
                        return nameMap[task] || task;
                    }

                    // 如果传入的是任务对象，根据模型类型判断
                    if (task && task.model_cls) {
                        const modelCls = task.model_cls.toLowerCase();

                        return nameMap[task.task_type] || task.task_type;
                    }

                    // 默认返回task_type
                    return task.task_type || '未知';
                };

                const getPromptPlaceholder = () => {
                    if (selectedTaskId.value === 't2v') {
                        return '请输入视频生成提示词，描述视频内容、风格、场景等...';
                    } else if (selectedTaskId.value === 'i2v') {
                        return '请输入视频生成提示词，描述基于图片的视频内容、动作要求等...';
                    } else if (selectedTaskId.value === 's2v') {
                        return '请输入视频生成提示词，描述数字人形象、背景风格、动作要求等...';
                    }
                    return '请输入视频生成提示词...';
                };

                const getStatusTextClass = (status) => {
                    if (status === 'SUCCEED') return 'text-emerald-400';
                    if (status === 'CREATED') return 'text-blue-400';
                    if (status === 'PENDING') return 'text-yellow-400';
                    if (status === 'RUNNING') return 'text-amber-400';
                    if (status === 'FAILED') return 'text-red-400';
                    if (status === 'CANCEL') return 'text-gray-400';
                    return 'text-gray-400';
                };



                const getImagePreview = (base64Data) => {
                    if (!base64Data) return '';
                    return `data:image/jpeg;base64,${base64Data}`;
                };

                const getTaskInputUrl = (taskId, key) => {
                    // 优先从缓存获取
                    const cachedUrl = getTaskFileUrlSync(taskId, key);
                    if (cachedUrl) {
                        console.log('getTaskInputUrl: 从缓存获取', { taskId, key, url: cachedUrl });
                        return cachedUrl;
                    }
                    
                    // 缓存没有则生成URL并缓存
                    const token = localStorage.getItem('accessToken');
                    const url = token 
                        ? `./assets/task/input?task_id=${taskId}&name=${key}&token=${encodeURIComponent(token)}`
                        : `./assets/task/input?task_id=${taskId}&name=${key}`;
                    
                    // 缓存API URL
                    setTaskFileToCache(taskId, key, {
                        url: url,
                        timestamp: Date.now()
                    });
                    
                    console.log('getTaskInputUrl: 生成并缓存输入URL', { taskId, key, url });
                    return url;
                };

                const getTaskInputImage = (task) => {
                    
                    if (!task || !task.inputs) {
                        console.log('getTaskInputImage: 任务或输入为空', { task: task?.task_id, inputs: task?.inputs });
                        return null;
                    }
                    
                    const imageInputs = Object.keys(task.inputs).filter(key =>
                        key.includes('image') ||
                        task.inputs[key].toString().toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)
                    );


                    if (imageInputs.length > 0) {
                        const firstImageKey = imageInputs[0];
                        // 优先从缓存获取
                        const cachedUrl = getTaskFileUrlSync(task.task_id, firstImageKey);
                        if (cachedUrl) {
                            console.log('getTaskInputImage: 从缓存获取', { taskId: task.task_id, key: firstImageKey, url: cachedUrl });
                            return cachedUrl;
                        }
                        // 缓存没有则生成URL
                        const url = getTaskInputUrl(task.task_id, firstImageKey);
                        console.log('getTaskInputImage: 生成URL', { taskId: task.task_id, key: firstImageKey, url });
                        return url;
                    }

                    console.log('getTaskInputImage: 没有找到图片输入');
                    return null;
                };

                const getTaskInputAudio = (task) => {
                    if (!task || !task.inputs) return null;
                    const audioInputs = Object.keys(task.inputs).filter(key =>
                        key.includes('audio') ||
                        task.inputs[key].toString().toLowerCase().match(/\.(mp3|wav|mp4|aac|ogg|m4a)$/)
                    );

                    if (audioInputs.length > 0) {
                        const firstAudioKey = audioInputs[0];
                        return getTaskInputUrl(task.task_id, firstAudioKey);
                    }

                    return null;
                };


                const handleThumbnailError = (event) => {
                    // 当输入图片加载失败时，显示默认图标
                    const img = event.target;
                    const parent = img.parentElement;
                    parent.innerHTML = '<div class="w-full h-full bg-laser-purple/20 flex items-center justify-center"><i class="fas fa-video text-gradient-icon text-xl"></i></div>';
                };

                const handleImageError = (event) => {
                    // 当图片加载失败时，隐藏图片，显示文件名
                    const img = event.target;
                    img.style.display = 'none';
                    // 文件名已经显示，不需要额外处理
                };

                const handleImageLoad = (event) => {
                    // 当图片加载成功时，显示图片和下载按钮，隐藏文件名
                    const img = event.target;
                    img.style.display = 'block';
                    // 显示下载按钮
                    const downloadBtn = img.parentElement.querySelector('button');
                    if (downloadBtn) {
                        downloadBtn.style.display = 'block';
                    }
                    // 隐藏文件名span
                    const span = img.parentElement.parentElement.querySelector('span');
                    if (span) {
                        span.style.display = 'none';
                    }
                };

                const handleAudioError = (event) => {
                    // 当音频加载失败时，隐藏音频控件和下载按钮，显示文件名
                    const audio = event.target;
                    audio.style.display = 'none';
                    // 隐藏下载按钮
                    const downloadBtn = audio.parentElement.querySelector('button');
                    if (downloadBtn) {
                        downloadBtn.style.display = 'none';
                    }
                    // 文件名已经显示，不需要额外处理
                };

                const handleAudioLoad = (event) => {
                    // 当音频加载成功时，显示音频控件和下载按钮，隐藏文件名
                    const audio = event.target;
                    audio.style.display = 'block';
                    // 显示下载按钮
                    const downloadBtn = audio.parentElement.querySelector('button');
                    if (downloadBtn) {
                        downloadBtn.style.display = 'block';
                    }
                    // 隐藏文件名span
                    const span = audio.parentElement.parentElement.querySelector('span');
                    if (span) {
                        span.style.display = 'none';
                    }
                };


                const downloadTaskInput = async (taskId, inputName, fileName) => {
                    try {
                        const url = getTaskInputUrl(taskId, inputName);
                        const response = await fetch(url);

                        if (!response || !response.ok) {
                            throw new Error(`下载失败: ${response ? response.status : '认证失败'}`);
                        }

                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);

                        // 创建下载链接
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        // 使用原始文件名，如果没有则使用inputName
                        const filename = inputName || fileName || `input_${taskId}`;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();

                        // 清理
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(downloadUrl);

                        showAlert('文件下载成功', 'success');
                    } catch (error) {
                        console.error('下载失败:', error);
                        showAlert(`下载失败: ${error.message}`, 'danger');
                    }
                };

                // 监听currentPage变化，同步更新pageInput
                watch(currentPage, (newPage) => {
                    pageInput.value = newPage;
                });

                // 监听pagination变化，确保分页组件更新
                watch(pagination, (newPagination) => {
                    console.log('pagination变化:', newPagination);
                    if (newPagination && newPagination.total_pages) {
                        // 确保当前页不超过总页数
                        if (currentPage.value > newPagination.total_pages) {
                            currentPage.value = newPagination.total_pages;
                        }
                    }
                }, { deep: true });

                // 统一的初始化函数
                const init = async () => {
                    try {
                        // 1. 加载模型和任务数据
                        await loadModels();
                        
                        // 3. 选择任务类型（优先选择数字人任务）
                        let selectedTaskType = null;
                        if (availableTaskTypes.value.includes('s2v')) {
                            selectedTaskType = 's2v';
                        } else if (availableTaskTypes.value.length > 0) {
                            selectedTaskType = availableTaskTypes.value[0];
                        }
                        
                        if (selectedTaskType) {
                            selectTask(selectedTaskType);
                            
                            // 4. 为选中的任务类型选择第一个模型
                            const currentForm = getCurrentForm();
                            if (!currentForm.model_cls && availableModelClasses.value.length > 0) {
                                selectModel(availableModelClasses.value[0]);
                            }
                        }

                        refreshTasks();
                        
                        // 2. 加载模板和历史记录
                        await loadTemplates();
                        await getPromptHistory();
                        loadTaskFilesFromCache();
                        
                        console.log('初始化完成:', {
                            currentUser: currentUser.value,
                            availableModels: models.value,
                            tasks: tasks.value,
                            selectedTaskType: selectedTaskType,
                            selectedModel: getCurrentForm().model_cls
                        });
                        
                    } catch (error) {
                        console.error('初始化失败:', error);
                        showAlert('初始化失败，请刷新页面重试', 'danger');
                    }
                };

                // 重置表单函数（保留模型选择，清空图片、音频和提示词）
                const resetForm = async (taskType) => {
                    const currentForm = getCurrentForm();
                    const currentModel = currentForm.model_cls;
                    const currentStage = currentForm.stage;
                    
                    // 重置表单但保留模型和阶段
                    switch (taskType) {
                        case 't2v':
                            t2vForm.value = {
                                task: 't2v',
                                model_cls: currentModel || '',
                                stage: currentStage || 'single_stage',
                                prompt: '',
                                seed: Math.floor(Math.random() * 1000000)
                            };
                            break;
                        case 'i2v':
                            i2vForm.value = {
                                task: 'i2v',
                                model_cls: currentModel || '',
                                stage: currentStage || 'multi_stage',
                                imageFile: null,
                                prompt: '',
                                seed: Math.floor(Math.random() * 1000000)
                            };
                            // 直接清空i2v图片预览
                            i2vImagePreview.value = null;
                            // 清理图片文件输入框
                            const imageInput = document.querySelector('input[type="file"][accept="image/*"]');
                            if (imageInput) {
                                imageInput.value = '';
                            }
                            break;
                        case 's2v':
                            s2vForm.value = {
                                task: 's2v',
                                model_cls: currentModel || '',
                                stage: currentStage || 'single_stage',
                                imageFile: null,
                                audioFile: null,
                                prompt: '',
                                seed: Math.floor(Math.random() * 1000000)
                            };
                            break;
                    }
                    
                    // 强制触发Vue响应式更新
                    setCurrentImagePreview(null);
                    setCurrentAudioPreview(null);
                    await nextTick();
                };

                // 开始轮询任务状态
                const startPollingTask = (taskId) => {
                    if (!pollingTasks.value.has(taskId)) {
                        pollingTasks.value.add(taskId);
                        console.log(`开始轮询任务状态: ${taskId}`);
                        
                        // 如果还没有轮询定时器，启动一个
                        if (!pollingInterval.value) {
                            pollingInterval.value = setInterval(async () => {
                                await pollTaskStatuses();
                            }, 1000); // 每1秒轮询一次
                        }
                    }
                };

                // 停止轮询任务状态
                const stopPollingTask = (taskId) => {
                    pollingTasks.value.delete(taskId);
                    console.log(`停止轮询任务状态: ${taskId}`);
                    
                    // 如果没有任务需要轮询了，清除定时器
                    if (pollingTasks.value.size === 0 && pollingInterval.value) {
                        clearInterval(pollingInterval.value);
                        pollingInterval.value = null;
                        console.log('停止所有任务状态轮询');
                    }
                };

                const refreshTaskFiles = (task) => {
                    for (const [key, inputPath] of Object.entries(task.inputs)) {
                        getTaskFileUrlFromApi(task.task_id, key).then(url => {
                            console.log('refreshTaskFiles: input', task.task_id, key, url);
                        });
                    }
                    for (const [key, outputPath] of Object.entries(task.outputs)) {
                        getTaskFileUrlFromApi(task.task_id, key).then(url => {
                            console.log('refreshTaskFiles: output', task.task_id, key, url);
                        });
                    }
                };

                // 轮询任务状态
                const pollTaskStatuses = async () => {
                    if (pollingTasks.value.size === 0) return;
                    
                    try {
                        const taskIds = Array.from(pollingTasks.value);
                        const response = await apiRequest(`./api/v1/task/query?task_ids=${taskIds.join(',')}`);
                        
                        if (response && response.ok) {
                            const tasksData = await response.json();
                            const updatedTasks = tasksData.tasks || [];
                            
                            // 更新任务列表中的任务状态
                            let hasUpdates = false;
                            updatedTasks.forEach(updatedTask => {
                                const existingTaskIndex = tasks.value.findIndex(t => t.task_id === updatedTask.task_id);
                                if (existingTaskIndex !== -1) {
                                    const oldTask = tasks.value[existingTaskIndex];
                                    tasks.value[existingTaskIndex] = updatedTask;
                                    console.log('updatedTask', updatedTask);
                                    console.log('oldTask', oldTask);
                                    
                                    // 如果状态发生变化，记录日志
                                    if (oldTask !== updatedTask) {
                                        hasUpdates = true;
                                        
                                        // 如果当前在查看这个任务的详情，更新selectedTask
                                        if (modalTask.value && modalTask.value.task_id === updatedTask.task_id) {
                                            modalTask.value = updatedTask;
                                        }

                                        // 如果当前在projects页面，更新tasks
                                        if (currentView.value === 'projects') {
                                            refreshTasks(true);
                                        }
                                        
                                        // 如果任务完成或失败，停止轮询并显示提示
                                        if (['SUCCEED', 'FAILED', 'CANCEL'].includes(updatedTask.status)) {
                                            stopPollingTask(updatedTask.task_id);
                                            refreshTaskFiles(updatedTask);
                                            if (currentView.value === 'projects') {
                                                refreshTasks(true);
                                            }
                                            
                                            // 显示任务完成提示
                                            if (updatedTask.status === 'SUCCEED') {
                                                showAlert('视频生成完成！', 'success');
                                            } else if (updatedTask.status === 'FAILED') {
                                                showAlert('视频生成失败，请查看详情', 'danger');
                                            } else if (updatedTask.status === 'CANCEL') {
                                                showAlert('任务已取消', 'warning');
                                            }
                                        }
                                    }
                                }
                            });
                            
                            // 如果有更新，触发界面刷新
                            if (hasUpdates) {
                                await nextTick();
                            }
                        }
                    } catch (error) {
                        console.error('轮询任务状态失败:', error);
                    }
                };

                // 任务状态管理
                const getTaskStatusDisplay = (status) => {
                    const statusMap = {
                        'CREATED': '创建',
                        'PENDING': '等待',
                        'RUNNING': '进行',
                        'SUCCEED': '完成',
                        'FAILED': '失败',
                        'CANCEL': '取消'
                    };
                    return statusMap[status] || status;
                };

                const getTaskStatusColor = (status) => {
                    const colorMap = {
                        'CREATED': 'text-blue-400',
                        'PENDING': 'text-yellow-400',
                        'RUNNING': 'text-amber-400',
                        'SUCCEED': 'text-emerald-400',
                        'FAILED': 'text-red-400',
                        'CANCEL': 'text-gray-400'
                    };
                    return colorMap[status] || 'text-gray-400';
                };

                const getTaskStatusIcon = (status) => {
                    const iconMap = {
                        'CREATED': 'fas fa-clock',
                        'PENDING': 'fas fa-hourglass-half',
                        'RUNNING': 'fas fa-spinner fa-spin',
                        'SUCCEED': 'fas fa-check-circle',
                        'FAILED': 'fas fa-exclamation-triangle',
                        'CANCEL': 'fas fa-ban'
                    };
                    return iconMap[status] || 'fas fa-question-circle';
                };


                // 任务时间格式化
                const getTaskDuration = (startTime, endTime) => {
                    if (!startTime || !endTime) return '未知';
                    const start = new Date(startTime * 1000);
                    const end = new Date(endTime * 1000);
                    const diff = end - start;
                    const minutes = Math.floor(diff / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    return `${minutes}分${seconds}秒`;
                };

                // 相对时间格式化
                const getRelativeTime = (timestamp) => {
                    if (!timestamp) return '未知';
                    const now = new Date();
                    const time = new Date(timestamp * 1000);
                    const diff = now - time;

                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);
                    const months = Math.floor(diff / 2592000000); // 30天
                    const years = Math.floor(diff / 31536000000);

                    if (years > 0) {
                        return years === 1 ? '一年前' : `${years}年前`;
                    } else if (months > 0) {
                        return months === 1 ? '一个月前' : `${months}个月前`;
                    } else if (days > 0) {
                        return days === 1 ? '一天前' : `${days}天前`;
                    } else if (hours > 0) {
                        return hours === 1 ? '一小时前' : `${hours}小时前`;
                    } else if (minutes > 0) {
                        return minutes === 1 ? '一分钟前' : `${minutes}分钟前`;
                    } else {
                        return '刚刚';
                    }
                };

                // 任务历史记录管理
                const getTaskHistory = () => {
                    return tasks.value.filter(task =>
                        ['SUCCEED', 'FAILED', 'CANCEL'].includes(task.status)
                    );
                };

                // 子任务进度相关函数
                const getOverallProgress = (subtasks) => {
                    if (!subtasks || subtasks.length === 0) return 0;
                    
                    let completedCount = 0;
                    subtasks.forEach(subtask => {
                        if (subtask.status === 'SUCCEED') {
                            completedCount++;
                        }
                    });
                    
                    return Math.round((completedCount / subtasks.length) * 100);
                };

                // 获取进度条标题
                const getProgressTitle = (subtasks) => {
                    if (!subtasks || subtasks.length === 0) return '总体进度';
                    
                    const pendingSubtasks = subtasks.filter(subtask => subtask.status === 'PENDING');
                    const runningSubtasks = subtasks.filter(subtask => subtask.status === 'RUNNING');
                    
                    if (pendingSubtasks.length > 0) {
                        return '排队状态';
                    } else if (runningSubtasks.length > 0) {
                        return '正在运行';
                    } else {
                        return '总体进度';
                    }
                };

                // 获取进度信息
                const getProgressInfo = (subtasks) => {
                    if (!subtasks || subtasks.length === 0) return '0%';
                    
                    const pendingSubtasks = subtasks.filter(subtask => subtask.status === 'PENDING');
                    const runningSubtasks = subtasks.filter(subtask => subtask.status === 'RUNNING');
                    
                    if (pendingSubtasks.length > 0) {
                        // 显示排队信息
                        const firstPending = pendingSubtasks[0];
                        const queuePosition = firstPending.estimated_pending_order;
                        const estimatedTime = firstPending.estimated_pending_secs;
                        
                        let info = `排队中`;
                        if (queuePosition !== null && queuePosition !== undefined) {
                            info += ` (位置: ${queuePosition})`;
                        }
                        if (estimatedTime !== null && estimatedTime !== undefined) {
                            info += ` - ${formatDuration(estimatedTime)}`;
                        }
                        return info;
                    } else if (runningSubtasks.length > 0) {
                        // 显示运行信息
                        const firstRunning = runningSubtasks[0];
                        const workerName = firstRunning.worker_name || '未知';
                        const estimatedTime = firstRunning.estimated_running_secs;
                        
                        let info = `子任务 ${workerName}`;
                        if (estimatedTime !== null && estimatedTime !== undefined) {
                            const elapses = firstRunning.elapses || {};
                            const runningTime = elapses['RUNNING-'] || 0;
                            const remaining = Math.max(0, estimatedTime - runningTime);
                            info += ` - 剩余 ${formatDuration(remaining)}`;
                        }
                        return info;
                    } else {
                        // 显示总体进度
                        return getOverallProgress(subtasks) + '%';
                    }
                };

                const getSubtaskProgress = (subtask) => {
                    if (subtask.status === 'SUCCEED') return 100;
                    if (subtask.status === 'FAILED' || subtask.status === 'CANCEL') return 0;
                    
                    // 对于PENDING和RUNNING状态，基于时间估算进度
                    if (subtask.status === 'PENDING') {
                        // 排队中的任务，进度为0
                        return 0;
                    }
                    
                    if (subtask.status === 'RUNNING') {
                        // 运行中的任务，基于已运行时间估算进度
                        const elapses = subtask.elapses || {};
                        const runningTime = elapses['RUNNING-'] || 0;
                        const estimatedTotal = subtask.estimated_running_secs || 0;
                        
                        if (estimatedTotal > 0) {
                            const progress = Math.min((runningTime / estimatedTotal) * 100, 95); // 最多95%，避免显示100%但未完成
                            return Math.round(progress);
                        }
                    }
                    
                    return 0;
                };

                const getSubtaskStatusText = (status) => {
                    const statusMap = {
                        'PENDING': '排队中',
                        'RUNNING': '运行中',
                        'SUCCEED': '已完成',
                        'FAILED': '失败',
                        'CANCEL': '已取消'
                    };
                    return statusMap[status] || status;
                };

                const formatEstimatedTime = (subtask) => {
                    if (subtask.status === 'PENDING') {
                        const pendingSecs = subtask.estimated_pending_secs;
                        const queuePosition = subtask.estimated_pending_order;
                        
                        if (pendingSecs !== null && pendingSecs !== undefined) {
                            let info = formatDuration(pendingSecs);
                            if (queuePosition !== null && queuePosition !== undefined) {
                                info += ` (位置: ${queuePosition})`;
                            }
                            return info;
                        }
                        return '计算中...';
                    }
                    
                    if (subtask.status === 'RUNNING') {
                        const elapses = subtask.elapses || {};
                        const runningTime = elapses['RUNNING-'] || 0;
                        const estimatedTotal = subtask.estimated_running_secs || 0;
                        
                        if (estimatedTotal > 0) {
                            const remaining = Math.max(0, estimatedTotal - runningTime);
                            return `剩余 ${formatDuration(remaining)}`;
                        }
                        return '计算中...';
                    }
                    
                    return '已完成';
                };

                const formatDuration = (seconds) => {
                    if (seconds < 60) {
                        return `${Math.round(seconds)}秒`;
                    } else if (seconds < 3600) {
                        const minutes = Math.round(seconds / 60);
                        return `${minutes}分钟`;
                    } else {
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.round((seconds % 3600) / 60);
                        return `${hours}小时${minutes}分钟`;
                    }
                };

                const getTaskFailureInfo = (task) => {
                    if (!task) return null;
                    
                    // 检查任务级别的失败信息
                    if (task.fail_msg) {
                        return task.fail_msg;
                    }
                    
                    // 检查子任务的失败信息
                    if (task.subtasks && task.subtasks.length > 0) {
                        const failedSubtasks = task.subtasks.filter(subtask => 
                            (subtask.extra_info && subtask.extra_info.fail_msg) || subtask.fail_msg
                        );
                        if (failedSubtasks.length > 0) {
                            const msg = failedSubtasks.map(subtask => 
                                (subtask.extra_info && subtask.extra_info.fail_msg) || subtask.fail_msg
                            ).join('\n');
                            return msg;
                        }
                    }
                    
                    return null;
                };

                const getActiveTasks = () => {
                    return tasks.value.filter(task =>
                        ['CREATED', 'PENDING', 'RUNNING'].includes(task.status)
                    );
                };

                // 任务搜索和过滤增强
                const searchTasks = (query) => {
                    if (!query) return tasks.value;
                    return tasks.value.filter(task => {
                        const searchText = [
                            task.task_id,
                            task.task_type,
                            task.model_cls,
                            task.params?.prompt || '',
                            getTaskStatusDisplay(task.status)
                        ].join(' ').toLowerCase();
                        return searchText.includes(query.toLowerCase());
                    });
                };

                const filterTasksByStatus = (status) => {
                    if (status === 'ALL') return tasks.value;
                    return tasks.value.filter(task => task.status === status);
                };

                const filterTasksByType = (type) => {
                    if (!type) return tasks.value;
                    return tasks.value.filter(task => task.task_type === type);
                };

                // 提示消息样式管理
                const getAlertClass = (type) => {
                    const classMap = {
                        'success': 'animate-slide-down',
                        'warning': 'animate-slide-down',
                        'danger': 'animate-slide-down',
                        'info': 'animate-slide-down'
                    };
                    return classMap[type] || 'animate-slide-down';
                };

                const getAlertBorderClass = (type) => {
                    const borderMap = {
                        'success': 'border-green-500',
                        'warning': 'border-yellow-500',
                        'danger': 'border-red-500',
                        'info': 'border-blue-500'
                    };
                    return borderMap[type] || 'border-gray-500';
                };

                const getAlertTextClass = (type) => {
                    // 统一使用白色文字
                    return 'text-white';
                };

                const getAlertIcon = (type) => {
                    const iconMap = {
                        'success': 'fas fa-check text-white',
                        'warning': 'fas fa-exclamation text-white',
                        'danger': 'fas fa-times text-white',
                        'info': 'fas fa-info text-white'
                    };
                    return iconMap[type] || 'fas fa-info text-white';
                };

                const getAlertIconBgClass = (type) => {
                    const bgMap = {
                        'success': 'bg-green-500/30',
                        'warning': 'bg-yellow-500/30',
                        'danger': 'bg-red-500/30',
                        'info': 'bg-laser-purple/30'
                    };
                    return bgMap[type] || 'bg-laser-purple/30';
                };

                // 监听器 - 监听任务类型变化
                watch(() => selectedTaskId.value, () => {
                    const currentForm = getCurrentForm();

                    // 只有当当前表单没有选择模型时，才自动选择第一个可用的模型
                    if (!currentForm.model_cls) {
                        let availableModels;

                        availableModels = models.value.filter(m => m.task === selectedTaskId.value);

                        if (availableModels.length > 0) {
                            const firstModel = availableModels[0];
                            currentForm.model_cls = firstModel.model_cls;
                            currentForm.stage = firstModel.stage;
                        }
                    }

                    // 注意：这里不需要重置预览，因为我们要保持每个任务的独立性
                    // 预览会在 selectTask 函数中根据文件状态恢复
                });

                watch(() => getCurrentForm().model_cls, () => {
                    const currentForm = getCurrentForm();

                    // 只有当当前表单没有选择阶段时，才自动选择第一个可用的阶段
                    if (!currentForm.stage) {
                        let availableStages;

                        availableStages = models.value
                                .filter(m => m.task === selectedTaskId.value && m.model_cls === currentForm.model_cls)
                                .map(m => m.stage);

                        if (availableStages.length > 0) {
                            currentForm.stage = availableStages[0];
                        }
                    }
                });

                // 生命周期
                onMounted(async () => {
                    // 设置初始化loading状态
                    initLoading.value = true;
                    // 添加全局点击事件监听器
                    document.addEventListener('click', handleClickOutside);

                    try {
                        // 检查是否已登录
                        const savedToken = localStorage.getItem('accessToken');
                        const savedUser = localStorage.getItem('currentUser');

                        if (savedToken && savedUser) {
                            currentUser.value = JSON.parse(savedUser);
                            await init();
                        } else {
                            // 检查是否是GitHub回调
                            const urlParams = new URLSearchParams(window.location.search);
                            const code = urlParams.get('code');
                            if (code) {
                                source = localStorage.getItem('loginSource');
                                await handleLoginCallback(code, source);
                            }
                        }
                    } catch (error) {
                        console.error('初始化失败:', error);
                        showAlert('初始化失败，请刷新页面重试', 'danger');
                    } finally {
                        isLoggedIn.value = true;
                        loginLoading.value = false;
                        initLoading.value = false;
                    }
                });

                // 页面卸载时清理轮询
                onUnmounted(() => {
                    if (pollingInterval.value) {
                        clearInterval(pollingInterval.value);
                        pollingInterval.value = null;
                    }
                    pollingTasks.value.clear();
                });

                // 提示词模板管理
                const promptTemplates = {
                    's2v': [
                        {
                            id: 's2v_1',
                            title: '商务演讲',
                            prompt: '数字人进行商务演讲，表情自然，手势得体，背景为现代化的会议室，整体风格专业商务。'
                        },
                        {
                            id: 's2v_2',
                            title: '产品介绍',
                            prompt: '数字人介绍产品特点，语气亲切，动作自然，背景为产品展示区，突出产品的科技感和实用性。'
                        }
                    ],
                    't2v': [
                        {
                            id: 't2v_1',
                            title: '自然风景',
                            prompt: '一个宁静的山谷，阳光透过云层洒在绿色的草地上，远处有雪山，近处有清澈的溪流，画面温暖自然，充满生机。'
                        },
                        {
                            id: 't2v_2',
                            title: '城市夜景',
                            prompt: '繁华的城市夜景，霓虹灯闪烁，高楼大厦林立，车流如织，天空中有星星点缀，营造出都市的繁华氛围。'
                        },
                        {
                            id: 't2v_3',
                            title: '科技未来',
                            prompt: '未来科技城市，飞行汽车穿梭，全息投影随处可见，建筑具有流线型设计，充满科技感和未来感。'
                        }
                    ],
                    'i2v': [
                        {
                            id: 'i2v_1',
                            title: '人物动作',
                            prompt: '基于参考图片，让角色做出自然的行走动作，保持原有的服装和风格，背景可以适当变化。'
                        },
                        {
                            id: 'i2v_2',
                            title: '场景转换',
                            prompt: '保持参考图片中的人物形象，将背景转换为不同的季节或环境，如从室内到户外，从白天到夜晚。'
                        }
                    ]
                };

                const getPromptTemplates = (taskType) => {
                    return promptTemplates[taskType] || [];
                };


                const selectPromptTemplate = (template) => {
                    getCurrentForm().prompt = template.prompt;
                    showPromptModal.value = false;
                    showAlert(`已应用模板: ${template.title}`, 'success');
                };

                // 提示词历史记录管理 - 现在直接从taskHistory中获取
                const promptHistory = ref([]);

                const getPromptHistory = async () => {
                    try {
                        // 从taskHistory中获取prompt历史，去重并按时间排序
                        const taskHistory = await getLocalTaskHistory();
                        const uniquePrompts = [];
                        const seenPrompts = new Set();
                        
                        // 遍历taskHistory，提取唯一的prompt
                        for (const task of taskHistory) {
                            if (task.prompt && task.prompt.trim() && !seenPrompts.has(task.prompt.trim())) {
                                uniquePrompts.push(task.prompt.trim());
                                seenPrompts.add(task.prompt.trim());
                            }
                        }
                        
                        const result = uniquePrompts.slice(0, 10); // 只显示最近10条
                        promptHistory.value = result; // 更新响应式数据
                        return result;
                    } catch (error) {
                        console.error('获取prompt历史失败:', error);
                        promptHistory.value = []; // 更新响应式数据
                        return [];
                    }
                };

                // addPromptToHistory函数已删除，现在prompt历史直接从taskHistory中获取

                // 保存完整的任务历史（包括提示词、图片、音频）
                const addTaskToHistory = (taskType, formData) => {
                    const historyItem = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        taskType: taskType,
                        prompt: formData.prompt || '',
                        imageFile: null,
                        audioFile: null
                    };

                    // 保存图片文件
                    if (formData.imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            historyItem.imageFile = {
                                name: formData.imageFile.name,
                                type: formData.imageFile.type,
                                size: formData.imageFile.size,
                                data: e.target.result
                            };
                            saveTaskHistoryItem(historyItem);
                        };
                        reader.readAsDataURL(formData.imageFile);
                    } else {
                        // 没有图片文件，直接保存
                        saveTaskHistoryItem(historyItem);
                    }

                    // 保存音频文件
                    if (formData.audioFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            historyItem.audioFile = {
                                name: formData.audioFile.name,
                                type: formData.audioFile.type,
                                size: formData.audioFile.size,
                                data: e.target.result
                            };
                            saveTaskHistoryItem(historyItem);
                        };
                        reader.readAsDataURL(formData.audioFile);
                    }
                };

                // 保存任务历史项到localStorage
                const saveTaskHistoryItem = (historyItem) => {
                    try {
                        const existingHistory = JSON.parse(localStorage.getItem('taskHistory') || '[]');
                        
                        // 避免重复添加（基于提示词和任务类型）
                        const isDuplicate = existingHistory.some(item => 
                            item.prompt === historyItem.prompt && 
                            item.taskType === historyItem.taskType
                        );
                        
                        if (!isDuplicate) {
                            // 按时间戳排序，确保最新的记录在最后
                            existingHistory.push(historyItem);
                            existingHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                            
                            // 限制历史记录数量，删除最旧的记录（最晚的记录）
                            if (existingHistory.length > 20) {
                                // 删除最前面的记录（最旧的）
                                existingHistory.splice(0, existingHistory.length - 20);
                            }
                            
                            localStorage.setItem('taskHistory', JSON.stringify(existingHistory));
                            console.log('任务历史已保存:', historyItem);
                        }
                    } catch (error) {
                        console.error('保存任务历史失败:', error);
                    }
                };

                // 获取本地存储的任务历史
                const getLocalTaskHistory = async () => {
                    try {
                        // 使用Promise模拟异步操作，避免阻塞UI
                        return await new Promise((resolve) => {
                            setTimeout(() => {
                                try {
                                    const history = JSON.parse(localStorage.getItem('taskHistory') || '[]');
                                    // 按时间戳排序，最新的记录在前
                                    const sortedHistory = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                                    resolve(sortedHistory);
                                } catch (error) {
                                    console.error('解析任务历史失败:', error);
                                    resolve([]);
                                }
                            }, 0);
                        });
                    } catch (error) {
                        console.error('获取任务历史失败:', error);
                        return [];
                    }
                };

                const selectPromptHistory = (prompt) => {
                    getCurrentForm().prompt = prompt;
                    showPromptModal.value = false;
                    showAlert('已应用历史提示词', 'success');
                };

                const clearPromptHistory = () => {
                    // 清空taskHistory中的prompt相关数据
                    localStorage.removeItem('taskHistory');
                    showAlert('提示词历史已清空', 'info');
                };

                // 图片历史记录管理
                const getImageHistory = async () => {
                    try {
                        const taskHistory = await getLocalTaskHistory();
                        const uniqueImages = [];
                        const seenImages = new Set();
                        
                        // 遍历taskHistory，提取唯一的图片
                        for (const task of taskHistory) {
                            if (task.imageFile && task.imageFile.name && !seenImages.has(task.imageFile.name)) {
                                uniqueImages.push({
                                    filename: task.imageFile.name,
                                    thumbnail: task.imageFile.data,
                                    data: task.imageFile.data,
                                    timestamp: task.timestamp
                                });
                                seenImages.add(task.imageFile.name);
                            }
                        }
                        
                        const result = uniqueImages.slice(0, 20); // 只显示最近20条
                        imageHistory.value = result;
                        return result;
                    } catch (error) {
                        console.error('获取图片历史失败:', error);
                        imageHistory.value = [];
                        return [];
                    }
                };

                // 音频历史记录管理
                const getAudioHistory = async () => {
                    try {
                        const taskHistory = await getLocalTaskHistory();
                        const uniqueAudios = [];
                        const seenAudios = new Set();
                        
                        // 遍历taskHistory，提取唯一的音频
                        for (const task of taskHistory) {
                            if (task.audioFile && task.audioFile.name && !seenAudios.has(task.audioFile.name)) {
                                uniqueAudios.push({
                                    filename: task.audioFile.name,
                                    data: task.audioFile.data,
                                    timestamp: task.timestamp
                                });
                                seenAudios.add(task.audioFile.name);
                            }
                        }
                        
                        const result = uniqueAudios.slice(0, 20); // 只显示最近20条
                        audioHistory.value = result;
                        return result;
                    } catch (error) {
                        console.error('获取音频历史失败:', error);
                        audioHistory.value = [];
                        return [];
                    }
                };

                // 选择图片历史记录
                const selectImageHistory = (history) => {
                    // 创建File对象
                    const byteCharacters = atob(history.data.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const file = new File([byteArray], history.filename, { type: 'image/jpeg' });
                    
                    // 设置图片预览
                    setCurrentImagePreview(history.data);
                    
                    // 更新表单
                    const currentForm = getCurrentForm();
                    currentForm.imageFile = file;
                    
                    showImageTemplates.value = false;
                    showAlert('已应用历史图片', 'success');
                };

                // 选择音频历史记录
                const selectAudioHistory = (history) => {
                    // 创建File对象
                    const byteCharacters = atob(history.data.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const file = new File([byteArray], history.filename, { type: 'audio/mpeg' });
                    
                    // 设置音频预览
                    setCurrentAudioPreview(history.data);
                    
                    // 更新表单
                    const currentForm = getCurrentForm();
                    currentForm.audioFile = file;
                    
                    showAudioTemplates.value = false;
                    showAlert('已应用历史音频', 'success');
                };

                // 预览音频历史记录
                const previewAudioHistory = (history) => {
                    const audio = new Audio(history.data);
                    audio.play().catch(error => {
                        console.error('音频播放失败:', error);
                        showAlert('音频播放失败', 'danger');
                    });
                };

                // 清空图片历史记录
                const clearImageHistory = () => {
                    imageHistory.value = [];
                    showAlert('图片历史已清空', 'info');
                };

                // 清空音频历史记录
                const clearAudioHistory = () => {
                    audioHistory.value = [];
                    showAlert('音频历史已清空', 'info');
                };

                const getAuthHeaders = () => {
                    const headers = {
                        'Content-Type': 'application/json'
                    };

                    const token = localStorage.getItem('accessToken');
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                        console.log('使用Token进行认证:', token.substring(0, 20) + '...');
                    } else {
                        console.warn('没有找到accessToken');
                    }
                    return headers;
                };

                // 验证token是否有效
                const validateToken = async (token) => {
                    try {
                        const response = await fetch('./api/v1/model/list', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        await new Promise(resolve => setTimeout(resolve, 100));
                        return response.ok;
                    } catch (error) {
                        console.error('Token validation failed:', error);
                        return false;
                    }
                };

                // 增强的API请求函数，自动处理认证错误
                const apiRequest = async (url, options = {}) => {
                    const headers = getAuthHeaders();

                    try {
                        const response = await fetch(url, {
                            ...options,
                            headers: {
                                ...headers,
                                ...options.headers
                            }
                        });
                        await new Promise(resolve => setTimeout(resolve, 100));
                        // 检查是否是认证错误
                        if (response.status === 401 || response.status === 403) {
                            // Token无效，清除本地存储并跳转到登录页
                            logout();
                            showAlert('登录已过期，请重新登录', 'warning');
                            return null;
                        }
                        return response;
                    } catch (error) {
                        console.error('API request failed:', error);
                        showAlert('网络请求失败', 'danger');
                        return null;
                    }
                };

                // 侧边栏拖拽调整功能
                const sidebar = ref(null);
                const sidebarWidth = ref(256); // 默认宽度 256px (w-64)
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;

                // 更新悬浮按钮位置
                const updateFloatingButtonPosition = (width) => {
                    const floatingBtn = document.querySelector('.floating-toggle-btn');
                    if (floatingBtn) {
                        if (sidebarCollapsed.value) {
                            // 收起状态时，按钮位于屏幕左侧
                            floatingBtn.style.left = '0px';
                            floatingBtn.style.right = 'auto';
                        } else {
                            // 展开状态时，按钮位于历史任务栏右侧
                            floatingBtn.style.left = width + 'px';
                            floatingBtn.style.right = 'auto';
                        }
                    }
                };

                const startResize = (e) => {
                    e.preventDefault();
                    console.log('startResize called');

                    isResizing = true;
                    startX = e.clientX;
                    startWidth = sidebar.value.offsetWidth;
                    console.log('Resize started, width:', startWidth);

                    document.body.classList.add('resizing');
                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                };

                const handleResize = (e) => {
                    if (!isResizing) return;

                    const deltaX = e.clientX - startX;
                    const newWidth = startWidth + deltaX;
                    const minWidth = 200;
                    const maxWidth = 500;

                    if (newWidth >= minWidth && newWidth <= maxWidth) {
                        // 立即更新悬浮按钮位置，不等待其他更新
                        const floatingBtn = document.querySelector('.floating-toggle-btn');
                        if (floatingBtn && !sidebarCollapsed.value) {
                            floatingBtn.style.left = newWidth + 'px';
                        }
                        
                        sidebarWidth.value = newWidth; // 更新响应式变量
                        sidebar.value.style.setProperty('width', newWidth + 'px', 'important');
                        
                        // 同时调整主内容区域宽度
                        const mainContent = document.querySelector('.main-container main');
                        if (mainContent) {
                            mainContent.style.setProperty('width', `calc(100% - ${newWidth}px)`, 'important');
                        } else {
                            const altMain = document.querySelector('main');
                            if (altMain) {
                                altMain.style.setProperty('width', `calc(100% - ${newWidth}px)`, 'important');
                            }
                        }
                    } else {
                        console.log('Width out of range:', newWidth);
                    }
                };

                const stopResize = () => {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    document.removeEventListener('mousemove', handleResize);
                    document.removeEventListener('mouseup', stopResize);

                    // 保存当前宽度到localStorage
                    if (sidebar.value) {
                        localStorage.setItem('sidebarWidth', sidebar.value.offsetWidth);
                    }
                };

                // 应用响应式侧边栏宽度
                const applyResponsiveWidth = () => {
                    if (!sidebar.value) return;

                    const windowWidth = window.innerWidth;
                    let sidebarWidthPx;

                    if (windowWidth <= 768) {
                        sidebarWidthPx = 200;
                    } else if (windowWidth <= 1200) {
                        sidebarWidthPx = 250;
                    } else {
                        // 大屏幕时使用保存的宽度或默认宽度
                        const savedWidth = localStorage.getItem('sidebarWidth');
                        if (savedWidth) {
                            const width = parseInt(savedWidth);
                            if (width >= 200 && width <= 500) {
                                sidebarWidthPx = width;
                            } else {
                                sidebarWidthPx = 256; // 默认 w-64
                            }
                        } else {
                            sidebarWidthPx = 256; // 默认 w-64
                        }
                    }

                    sidebarWidth.value = sidebarWidthPx; // 更新响应式变量
                    sidebar.value.style.width = sidebarWidthPx + 'px';
                    
                    // 更新悬浮按钮位置
                    updateFloatingButtonPosition(sidebarWidthPx);
                    
                    const mainContent = document.querySelector('main');
                    if (mainContent) {
                        mainContent.style.width = `calc(100% - ${sidebarWidthPx}px)`;
                    }
                };

                // 新增：视图切换方法
                const switchToCreateView = () => {
                    currentView.value = 'create';
                };

                const switchToProjectsView = () => {
                    currentView.value = 'projects';
                    // 刷新任务列表
                    refreshTasks(true);
                };

                const switchToInspirationView = () => {
                    currentView.value = 'inspiration';
                    // 加载灵感数据
                    loadInspirationData();
                };

                // 日期格式化函数
                const formatDate = (date) => {
                    if (!date) return '';
                    const d = new Date(date);
                    return d.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                };

                // 灵感广场相关方法
                const loadInspirationData = async () => {
                    try {
                        // 加载模板任务数据
                        const response = await apiCall('./api/v1/template/tasks');
                        if (response.ok) {
                            const data = await response.json();
                            const templates = data.templates || [];
                            
                            // 转换模板数据为灵感广场格式
                            const inspirationData = templates.map(template => {
                                const task = template.task;
                                
                                return {
                                    id: task.task_id,
                                    title: task.params.prompt || '未命名模板',
                                    description: `模型: ${task.model_cls} | 类型: ${task.task_type}`,
                                    category: 'person',
                                    thumbnail: task.outputs?.output_video ? 
                                        `./api/v1/template/videos/${task.outputs.output_video}` : '',
                                    videoUrl: task.outputs?.output_video ? 
                                        `./api/v1/template/videos/${task.outputs.output_video}` : '',
                                    imageUrl: task.inputs?.input_image ? 
                                        `./api/v1/template/images/${task.inputs.input_image}` : '',
                                    audioUrl: task.inputs?.input_audio ? 
                                        `./api/v1/template/audios/${task.inputs.input_audio}` : '',
                                    tags: [task.model_cls, task.task_type, task.tag || '模板'],
                                    createdAt: new Date(task.create_t),
                                    templateData: template // 保存完整的模板数据
                                };
                            });
                            
                            inspirationItems.value = inspirationData;
                            console.log('加载模板数据成功:', inspirationData.length, '个模板');
                        } else {
                            console.warn('加载模板数据失败');
                        }
                    } catch (error) {
                        console.warn('加载模板数据失败:', error);
                    }
                };
                // 筛选灵感内容
                const filteredInspirationItems = computed(() => {
                    let filtered = inspirationItems.value;
                    
                    // 按分类筛选
                    if (selectedInspirationCategory.value !== 'all') {
                        filtered = filtered.filter(item => item.category === selectedInspirationCategory.value);
                    }
                    
                    // 按搜索关键词筛选
                    if (inspirationSearchQuery.value.trim()) {
                        const query = inspirationSearchQuery.value.toLowerCase();
                        filtered = filtered.filter(item => 
                            item.title.toLowerCase().includes(query) ||
                            item.description.toLowerCase().includes(query) ||
                            item.tags.some(tag => tag.toLowerCase().includes(query))
                        );
                    }
                    
                    return filtered;
                });

                // 选择分类
                const selectInspirationCategory = (categoryId) => {
                    selectedInspirationCategory.value = categoryId;
                };

                // 视频播放控制
                const playVideo = (event) => {
                    const video = event.target;
                    if (video.readyState >= 2) { // HAVE_CURRENT_DATA
                        video.currentTime = 0; // 从头开始播放
                        video.play().catch(e => {
                            console.log('视频播放失败:', e);
                            // 如果自动播放失败，可以尝试用户交互后播放
                        });
                    } else {
                        // 如果视频还没加载完成，等待加载完成后再播放
                        video.addEventListener('loadeddata', () => {
                            video.currentTime = 0;
                            video.play().catch(e => console.log('视频播放失败:', e));
                        }, { once: true });
                    }
                };

                const pauseVideo = (event) => {
                    const video = event.target;
                    video.pause();
                    video.currentTime = 0; // 重置到开头
                };

                const onVideoLoaded = (event) => {
                    const video = event.target;
                    // 视频加载完成，准备播放
                    console.log('视频加载完成:', video.src);
                };

                const onVideoError = (event) => {
                    const video = event.target;
                    console.error('视频加载失败:', video.src, event);
                    // 可以在这里显示错误状态或回退到图片
                };

                // 预览模板详情
                const previewTemplateDetail = (item) => {
                    selectedTemplate.value = item;
                    showTemplateDetailModal.value = true;
                };

                // 关闭模板详情弹窗
                const closeTemplateDetailModal = () => {
                    showTemplateDetailModal.value = false;
                    selectedTemplate.value = null;
                };

                // 使用模板
                const useTemplate = async (item) => {
                    if (!item || !item.templateData) {
                        showAlert('模板数据不完整', 'danger');
                        return;
                    }

                    try {
                        const template = item.templateData;
                        const task = template.task;

                        // 先设置任务类型
                        selectedTaskId.value = task.task_type;

                        // 获取当前表单
                        const currentForm = getCurrentForm();

                        // 设置表单数据
                        currentForm.prompt = task.params?.prompt || '';
                        currentForm.negative_prompt = task.params?.negative_prompt || '';
                        currentForm.seed = task.params?.seed || 42;
                        currentForm.model_cls = task.model_cls || '';
                        currentForm.stage = task.stage || 'single_stage';

                        // 如果有输入图片，先设置URL，延迟加载文件
                        if (task.inputs && task.inputs.input_image) {
                            const imageUrl = `./api/v1/template/images/${task.inputs.input_image}`;
                            currentForm.imageUrl = imageUrl;
                            setCurrentImagePreview(imageUrl); // 直接使用URL作为预览
                            console.log('模板输入图片:', imageUrl);
                            
                            // 异步加载图片文件（不阻塞UI）
                            setTimeout(async () => {
                                try {
                                    const imageResponse = await fetch(imageUrl);
                                    if (imageResponse.ok) {
                                        const blob = await imageResponse.blob();
                                        const filename = task.inputs.input_image;
                                        const file = new File([blob], filename, { type: blob.type });
                                        currentForm.imageFile = file;
                                        console.log('模板图片文件已加载');
                                    }
                                } catch (error) {
                                    console.warn('Failed to load template image file:', error);
                                }
                            }, 100);
                        }

                        // 如果有输入音频，先设置URL，延迟加载文件
                        if (task.inputs && task.inputs.input_audio) {
                            const audioUrl = `./api/v1/template/audios/${task.inputs.input_audio}`;
                            currentForm.audioUrl = audioUrl;
                            setCurrentAudioPreview(audioUrl); // 直接使用URL作为预览
                            console.log('模板输入音频:', audioUrl);
                            
                            // 异步加载音频文件（不阻塞UI）
                            setTimeout(async () => {
                                try {
                                    const audioResponse = await fetch(audioUrl);
                                    if (audioResponse.ok) {
                                        const blob = await audioResponse.blob();
                                        const filename = task.inputs.input_audio;
                                        
                                        // 根据文件扩展名确定正确的MIME类型
                                        let mimeType = blob.type;
                                        if (!mimeType || mimeType === 'application/octet-stream') {
                                            const ext = filename.toLowerCase().split('.').pop();
                                            const mimeTypes = {
                                                'mp3': 'audio/mpeg',
                                                'wav': 'audio/wav',
                                                'mp4': 'audio/mp4',
                                                'aac': 'audio/aac',
                                                'ogg': 'audio/ogg',
                                                'm4a': 'audio/mp4'
                                            };
                                            mimeType = mimeTypes[ext] || 'audio/mpeg';
                                        }
                                        
                                        const file = new File([blob], filename, { type: mimeType });
                                        currentForm.audioFile = file;
                                        console.log('模板音频文件已加载');
                                        // 使用FileReader生成data URL，与正常上传保持一致
                                        const reader = new FileReader();
                                        reader.onload = (e) => {
                                            setCurrentAudioPreview(e.target.result);
                                            console.log('模板音频预览已设置:', e.target.result.substring(0, 50) + '...');
                                        };
                                        reader.readAsDataURL(file);
                                    }
                                } catch (error) {
                                    console.warn('Failed to load template audio file:', error);
                                }
                            }, 100);
                        }

                        // 关闭模板详情弹窗
                        closeTemplateDetailModal();

                        // 切换到创建视图
                        currentView.value = 'create';

                        showAlert(`已应用模板: ${item.title}`, 'success');
                    } catch (error) {
                        console.error('应用模板失败:', error);
                        showAlert(`应用模板失败: ${error.message}`, 'danger');
                    }
                };

                // 加载更多灵感
                const loadMoreInspiration = () => {
                    showAlert('加载更多灵感功能开发中...', 'info');
                };

                // 新增：任务详情弹窗方法
                const openTaskDetailModal = (task) => {
                    modalTask.value = task;
                    showTaskDetailModal.value = true;
                    // 加载任务详情
                    viewTaskDetail(task);
                };

                const closeTaskDetailModal = () => {
                    showTaskDetailModal.value = false;
                    modalTask.value = null;
                    selectedTask.value = null;
                };

                // 恢复保存的侧边栏宽度
                onMounted(() => {
                    applyResponsiveWidth();

                    // 监听窗口大小变化
                    window.addEventListener('resize', applyResponsiveWidth);
                    
                    // 确保悬浮按钮初始位置正确
                    setTimeout(() => {
                        updateFloatingButtonPosition(sidebarWidth.value);
                    }, 100);
                });

                return {
                    isLoggedIn,
                    loading,
                    loginLoading,
                    initLoading,
                    downloadLoading,
                    loginWithGitHub,
                    loginWithGoogle,
                    // 短信登录相关
                    phoneNumber,
                    verifyCode,
                    smsCountdown,
                    showSmsForm,
                    sendSmsCode,
                    loginWithSms,
                    toggleSmsLogin,
                    submitting,
                    searchQuery,
                    currentUser,
                    models,
                    tasks,
                    alert,
                    showErrorDetails,
                    showFailureDetails,
                    confirmDialog,
                    showConfirmDialog,
                    // 新增：视图切换相关状态
                    currentView,
                    showTaskDetailModal,
                    modalTask,
                    t2vForm,
                    i2vForm,
                    s2vForm,
                    getCurrentForm,
                    i2vImagePreview,
                    s2vImagePreview,
                    s2vAudioPreview,
                    getCurrentImagePreview,
                    getCurrentAudioPreview,
                    availableTaskTypes,
                    availableModelClasses,
                    filteredTasks,
                    selectedTaskId,
                    selectedTask,
                    selectedTaskFiles,
                    loadingTaskFiles,
                    statusFilter,
                    pagination,
                    paginationInfo,
                    currentPage,
                    pageSize,
                    pageInput,
                    paginationKey,
                    taskMenuVisible,
                    toggleTaskMenu,
                    closeAllTaskMenus,
                    handleClickOutside,
                    showAlert,
                    setLoading,
                    apiCall,
                    logout,
                    loadModels,
                    sidebarCollapsed,
                    sidebarWidth,
                    showExpandHint,
                    showGlow,
                    taskFileCache,
                    taskFileCacheLoaded,
                    loadTaskFiles,
                    downloadFile,
                    viewFile,
                    handleImageUpload,
                    selectTask,
                    selectModel,
                    resetForm,
                    triggerImageUpload,
                    triggerAudioUpload,
                    removeImage,
                    removeAudio,
                    handleAudioUpload,
                    loadTemplates,
                    checkTemplateUpdates,
                    checkTemplateChanges,
                    selectImageTemplate,
                    selectAudioTemplate,
                    previewAudioTemplate,
                    getTemplateFile,
                    imageTemplates,
                    audioTemplates,
                    showImageTemplates,
                    showAudioTemplates,
                    mediaModalTab,
                    imageHistory,
                    audioHistory,
                    templateFileCache,
                    showTemplates,
                    showHistory,
                    showPromptModal,
                    promptModalTab,
                    submitTask,
                    fileToBase64,
                    formatTime,
                    refreshTasks,
                    goToPage,
                    jumpToPage,
                    getVisiblePages,
                    preloadTaskFiles,
                    loadTaskFilesFromCache,
                    saveTaskFilesToCache,
                    getTaskFileFromCache,
                    setTaskFileToCache,
                    getTaskFileUrlFromApi,
                    getTaskFileUrl,
                    getTaskFileUrlSync,
                    getFirstImageKey,
                    loadFromCache,
                    saveToCache,
                    clearAllCache,
                    getStatusBadgeClass,
                    downloadSingleResult,
                    viewSingleResult,
                    cancelTask,
                    resumeTask,
                    deleteTask,
                    startPollingTask,
                    stopPollingTask,
                    viewTaskDetail,
                    reuseTask,
                    showTaskCreator,
                    toggleSidebar,
                    clearPrompt,
                    getTaskItemClass,
                    getStatusIndicatorClass,
                    getTaskTypeBtnClass,
                    getModelBtnClass,
                    getTaskTypeIcon,
                    getTaskTypeName,
                    getPromptPlaceholder,
                    getStatusTextClass,
                    getImagePreview,
                    getTaskInputUrl,
                    getTaskInputImage,
                    getTaskInputAudio,
                    handleThumbnailError,
                    handleImageError,
                    handleImageLoad,
                    handleAudioError,
                    handleAudioLoad,
                    downloadTaskInput,
                    getVideoUrl,
                    getTaskStatusDisplay,
                    getTaskStatusColor,
                    getTaskStatusIcon,
                    getTaskDuration,
                    getRelativeTime,
                    getTaskHistory,
                    getActiveTasks,
                    getOverallProgress,
                    getProgressTitle,
                    getProgressInfo,
                    getSubtaskProgress,
                    getSubtaskStatusText,
                    formatEstimatedTime,
                    formatDuration,
                    getTaskFailureInfo,
                    searchTasks,
                    filterTasksByStatus,
                    filterTasksByType,
                    getAlertClass,
                    getAlertBorderClass,
                    getAlertTextClass,
                    getAlertIcon,
                    getAlertIconBgClass,
                    getPromptTemplates,
                    selectPromptTemplate,
                    promptHistory,
                    getPromptHistory,
                    addTaskToHistory,
                    getLocalTaskHistory,
                    selectPromptHistory,
                    clearPromptHistory,
                    getImageHistory,
                    getAudioHistory,
                    selectImageHistory,
                    selectAudioHistory,
                    previewAudioHistory,
                    clearImageHistory,
                    clearAudioHistory,
                    getAudioMimeType,
                    getAuthHeaders,
                    startResize,
                    sidebar,
                    switchToCreateView,
                    switchToProjectsView,
                    switchToInspirationView,
                    openTaskDetailModal,
                    closeTaskDetailModal,
                    // 灵感广场相关
                    inspirationSearchQuery,
                    selectedInspirationCategory,
                    inspirationItems,
                    inspirationCategories,
                    filteredInspirationItems,
                    loadInspirationData,
                    selectInspirationCategory,
                    loadMoreInspiration,
                    // 工具函数
                    formatDate,
                    // 模板详情弹窗相关
                    showTemplateDetailModal,
                    selectedTemplate,
                    previewTemplateDetail,
                    closeTemplateDetailModal,
                    useTemplate,
                    // 视频播放控制
                    playVideo,
                    pauseVideo,
                    onVideoLoaded,
                    onVideoError
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

