<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightX2V 文生视频服务</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#9a72ff', // 主紫色
                        secondary: '#1b1240', // 深紫色背景
                        accent: '#b78bff', // 亮紫色强调
                        dark: '#0b0a20', // 深色背景
                        'dark-light': '#0f0e22', // 稍亮的深色
                        'laser-purple': '#9a72ff', // 激光紫色
                        'neon-purple': '#b78bff', // 霓虹紫色
                        'electric-purple': '#7c6aff', // 电光紫色
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(154, 114, 255, 0.5), 0 0 20px rgba(154, 114, 255, 0.3)',
                        'neon-lg': '0 0 15px rgba(154, 114, 255, 0.7), 0 0 30px rgba(154, 114, 255, 0.5)',
                        'laser': '0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2)',
                        'laser-intense': '0 0 25px rgba(154, 114, 255, 0.9), 0 0 50px rgba(154, 114, 255, 0.7), 0 0 75px rgba(154, 114, 255, 0.5), 0 0 100px rgba(154, 114, 255, 0.3), 0 0 125px rgba(154, 114, 255, 0.1)',
                        'electric': '0 0 15px rgba(124, 106, 255, 0.8), 0 0 30px rgba(124, 106, 255, 0.6), 0 0 45px rgba(124, 106, 255, 0.4)'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            .bg-grid {
                background-size: 40px 40px;
                background-image:
                    linear-gradient(to right, rgba(154, 114, 255, 0.15) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(154, 114, 255, 0.15) 1px, transparent 1px);
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 4px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: rgba(154, 114, 255, 0.6);
                border-radius: 2px;
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 0.5) infinite;
            }
            .animate-float {
                animation: float 6s ease-in-out infinite;
            }
            .animate-laser-glow {
                animation: laserGlow 2s ease-in-out infinite alternate;
            }
            .animate-electric-pulse {
                animation: electricPulse 1.5s ease-in-out infinite;
            }
            .animate-neon-flicker {
                animation: neonFlicker 3s ease-in-out infinite;
            }
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
            }
            @keyframes laserGlow {
                0% { 
                    box-shadow: 0 0 10px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4);
                    filter: brightness(0.8) saturate(0.7);
                }
                100% { 
                    box-shadow: 0 0 20px rgba(154, 114, 255, 1), 0 0 60px rgba(154, 114, 255, 0.8), 0 0 90px rgba(154, 114, 255, 0.6);
                    filter: brightness(1) saturate(1);
                }
            }
            @keyframes electricPulse {
                0%, 100% { 
                    box-shadow: 0 0 15px rgba(124, 106, 255, 0.8), 0 0 30px rgba(124, 106, 255, 0.6);
                    transform: scale(1);
                }
                50% { 
                    box-shadow: 0 0 25px rgba(124, 106, 255, 1), 0 0 50px rgba(124, 106, 255, 0.8), 0 0 75px rgba(124, 106, 255, 0.4);
                    transform: scale(1.02);
                }
            }
            @keyframes neonFlicker {
                0%, 100% { 
                    box-shadow: 0 0 20px rgba(183, 139, 255, 0.8), 0 0 40px rgba(183, 139, 255, 0.6);
                    opacity: 1;
                }
                25% { 
                    box-shadow: 0 0 15px rgba(183, 139, 255, 0.6), 0 0 30px rgba(183, 139, 255, 0.4);
                    opacity: 0.8;
                }
                75% { 
                    box-shadow: 0 0 25px rgba(183, 139, 255, 1), 0 0 50px rgba(183, 139, 255, 0.8);
                    opacity: 1.1;
                }
            }
            .bg-laser-gradient {
                background: linear-gradient(135deg, #9a72ff 0%, #b78bff 25%, #7c6aff 50%, #9a72ff 75%, #b78bff 100%);
                background-size: 200% 200%;
                animation: gradientShift 3s ease-in-out infinite;
            }
            @keyframes gradientShift {
                0%, 100% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
            }
            .text-laser-glow {
                text-shadow: 0 0 10px rgba(154, 114, 255, 0.8), 0 0 20px rgba(154, 114, 255, 0.6), 0 0 30px rgba(154, 114, 255, 0.4);
            }
            .border-laser {
                border-color: #9a72ff;
                box-shadow: 0 0 15px rgba(154, 114, 255, 0.6), inset 0 0 15px rgba(154, 114, 255, 0.1);
            }
            .btn-primary{ 
                padding: 12px 22px; 
                border-radius: 14px; 
                font-weight: 700; 
                letter-spacing: 0.2px; 
                color: #0c0920;
                background: linear-gradient(135deg, #d2c1ff, #a88bff, #8e88ff); 
                border: 0; 
                text-decoration: none;
                box-shadow: 0 10px 30px rgba(140, 110, 255, 0.4); 
                transition: transform 0.15s ease, box-shadow 0.15s ease; 
            }
            .btn-primary:hover{ 
                transform: translateY(-1px); 
                box-shadow: 0 14px 40px rgba(140, 110, 255, 0.55); 
            }
            
            /* 修复布局问题 */
            .task-type-btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                font-weight: 500;
                transition-property: color, background-color;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
            
            .task-type-btn:hover {
                background-color: rgba(154, 114, 255, 0.1);
            }
            
            .model-selection {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .upload-section {
                display: grid;
                grid-template-columns: repeat(1, minmax(0, 1fr));
                gap: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            @media (min-width: 768px) {
                .upload-section {
                    grid-template-columns: repeat(2, minmax(0, 1fr));
                }
            }
            
            .upload-area {
                border: 2px dashed rgba(154, 114, 255, 0.4);
                border-radius: 0.75rem;
                padding: 1.5rem;
                text-align: center;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
                cursor: pointer;
                background-color: rgba(27, 18, 64, 0.1);
            }
            
            .upload-area:hover {
                border-color: rgba(154, 114, 255, 0.7);
                box-shadow: 0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2);
            }
            
            .upload-icon {
                margin: 0 auto;
                width: 4rem;
                height: 4rem;
                background-color: rgba(154, 114, 255, 0.2);
                border-radius: 9999px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 1rem;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
            
            .upload-area:hover .upload-icon {
                background-color: rgba(154, 114, 255, 0.3);
            }
            
            .image-preview, .audio-preview {
                position: relative;
            }
            
            .btn-close {
                position: absolute;
                top: -0.5rem;
                right: -0.5rem;
                background-color: #ef4444;
                color: white;
                border-radius: 9999px;
                width: 1.5rem;
                height: 1.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.75rem;
                cursor: pointer;
            }
            
            /* 确保flexbox布局正确 */
            #app {
                display: flex;
                height: 100vh;
                width: 100vw;
            }
            
            aside {
                flex-shrink: 0;
                width: 280px; /* 减小侧边栏宽度 */
                background-color: #1b1240;
                border-right: 1px solid rgba(154, 114, 255, 0.4);
                display: flex;
                flex-direction: column;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 300ms;
                z-index: 10;
            }
            
            main {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 0;
                width: calc(100vw - 280px); /* 主内容区域占据剩余宽度 */
            }
            
            /* 内容区域全屏显示 */
            .content-area {
                flex: 1;
                overflow-y: auto;
                background-color: #0b0a20;
                padding: 2rem;
                width: 100%;
            }
            
            /* 任务创建面板全屏 */
            #task-creator {
                max-width: none;
                width: 100%;
                padding: 0 1rem;
            }
            
            /* 任务详情面板全屏 */
            .task-detail-panel {
                max-width: none;
                width: 100%;
                padding: 0 1rem;
            }
            
            /* 上传区域全屏布局 */
            .upload-section {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
                margin-bottom: 2rem;
                width: 100%;
            }
            
            /* 任务类型选择全屏 */
            .task-type-selection {
                width: 100%;
                margin-bottom: 2rem;
            }
            
            .task-type-buttons {
                display: flex;
                width: 100%;
                border-bottom: 1px solid rgba(154, 114, 255, 0.3);
            }
            
            .task-type-btn {
                flex: 1;
                padding: 1rem 1.5rem;
                font-size: 1rem;
                font-weight: 500;
                transition-property: color, background-color;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
                text-align: center;
            }
            
            /* 模型选择全屏 */
            .model-selection {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                width: 100%;
                justify-content: flex-start;
            }
            
            /* 提示词输入全屏 */
            .prompt-input-section {
                width: 100%;
                margin-bottom: 2rem;
            }
            
            .prompt-textarea {
                width: 100%;
                min-height: 150px;
                resize: vertical;
            }
            
            /* 修复侧边栏切换 */
            aside.w-0 {
                width: 0;
                overflow: hidden;
            }
            
            aside.hidden {
                display: none;
            }
            
            /* 当侧边栏隐藏时，主内容区域全屏 */
            aside.w-0 + main,
            aside.hidden + main {
                width: 100vw;
            }
            
            /* 响应式设计 */
            @media (max-width: 1200px) {
                aside {
                    width: 250px;
                }
                
                main {
                    width: calc(100vw - 250px);
                }
            }
            
            @media (max-width: 768px) {
                aside {
                    width: 200px;
                }
                
                main {
                    width: calc(100vw - 200px);
                }
                
                .upload-section {
                    grid-template-columns: 1fr;
                }
            }
            
            /* 修复任务项样式 */
            .task-item {
                padding: 0.75rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 200ms;
            }
            
            .task-item:hover {
                background-color: rgba(154, 114, 255, 0.15);
                box-shadow: 0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2);
            }
            
            /* 修复状态指示器 */
            .status-indicator {
                width: 0.75rem;
                height: 0.75rem;
                border-radius: 9999px;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            
            /* 修复按钮样式 */
            .btn-primary {
                padding: 12px 22px;
                border-radius: 14px;
                font-weight: 700;
                letter-spacing: 0.2px;
                color: #0c0920;
                background: linear-gradient(135deg, #d2c1ff, #a88bff, #8e88ff);
                border: 0;
                text-decoration: none;
                box-shadow: 0 10px 30px rgba(140, 110, 255, 0.4);
                transition: transform 0.15s ease, box-shadow 0.15s ease;
                cursor: pointer;
                display: inline-block;
            }
            
            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: 0 14px 40px rgba(140, 110, 255, 0.55);
            }
            
            /* 修复模型按钮样式 */
            .model-btn {
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
                cursor: pointer;
                border: 1px solid;
            }
            
            .model-btn.active {
                background-color: rgba(154, 114, 255, 0.2);
                border-color: rgba(154, 114, 255, 0.4);
                box-shadow: 0 0 20px rgba(154, 114, 255, 0.8), 0 0 40px rgba(154, 114, 255, 0.6), 0 0 60px rgba(154, 114, 255, 0.4), 0 0 80px rgba(154, 114, 255, 0.2);
                animation: electricPulse 1.5s ease-in-out infinite;
            }
            
            /* 确保内容区域正确滚动 */
            .content-scroll {
                flex: 1;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="bg-dark text-gray-100 font-inter min-h-screen flex overflow-hidden">
    <div id="app">
        <!-- 侧边栏 - 历史任务 -->
        <aside class="w-64 bg-secondary border-r border-laser-purple/40 flex flex-col transition-all duration-300 ease-in-out z-10">
            <div class="p-4 border-b border-laser-purple/40">
                <h1 class="text-xl font-bold flex items-center">
                    <i class="fas fa-video text-laser-purple mr-2"></i>
                    <span>LightX2V</span>
                </h1>
            </div>
            <div class="p-4 border-b border-laser-purple/40">
                <button 
                    @click="showTaskCreator" 
                    class="w-full btn-primary py-2 rounded-lg flex items-center justify-center transition-all duration-200 font-medium text-sm">
                    <i class="fas fa-plus mr-2"></i>
                    新建任务
                </button>
                <div class="relative mt-3">
                    <input
                        v-model="searchQuery"
                        class="w-full bg-dark-light border border-laser-purple/30 rounded-lg py-2 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-laser-purple/50 transition-all focus:border-laser focus:shadow-laser"
                        placeholder="搜索历史任务..."
                        type="text"
                    />
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-thin p-2">
                <div class="text-xs uppercase text-gray-400 font-semibold mb-2 px-3">
                    历史任务
                </div>
                <!-- 历史任务列表 -->
                <div class="space-y-1" id="history-tasks">
                    <div v-if="filteredTasks.length === 0" class="flex-col items-center justify-center py-12 text-center">
                        <div class="w-20 h-20 bg-laser-purple/20 rounded-full flex items-center justify-center mb-4 animate-float border border-laser-purple/30">
                            <i class="fas fa-clock text-laser-purple text-2xl"></i>
                        </div>
                        <p class="text-gray-400 text-sm">暂无历史任务</p>
                        <p class="text-gray-500 text-xs mt-1">开始创建你的第一个AI视频吧</p>
                    </div>
                    <!-- 任务项 -->
                    <div 
                        v-for="task in filteredTasks" 
                        :key="task.task_id" 
                        class="task-item p-3 rounded-lg cursor-pointer hover:bg-laser-purple/15 hover:shadow-laser transition-all duration-200"
                        :class="getTaskItemClass(task.status)"
                        @click="viewTaskDetail(task.task_id)"
                    >
                        <div class="flex items-start gap-3 mb-2">
                            <div class="w-16 h-12 bg-dark-light rounded overflow-hidden flex-shrink-0">
                                <img
                                    v-if="task.outputs && task.outputs.video"
                                    :src="getVideoThumbnail(task.outputs.video)"
                                    alt="视频预览"
                                    class="w-full h-full object-cover"
                                />
                                <div v-else class="w-full h-full bg-laser-purple/20 flex items-center justify-center">
                                    <i class="fas fa-video text-laser-purple"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="font-medium text-sm truncate">{{ task.params.prompt || '无标题任务' }}</h3>
                                    <div 
                                        :class="getStatusIndicatorClass(task.status)"
                                        :title="task.status"
                                    ></div>
                                </div>
                                <p class="text-xs text-gray-400 mb-2 line-clamp-1">
                                    {{ task.task_type }} | {{ formatTime(task.create_t) }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航 -->
            <header class="h-16 bg-secondary/50 backdrop-blur-sm border-b border-laser-purple/30 flex items-center justify-between px-6">
                <div class="flex items-center">
                    <button 
                        @click="toggleSidebar" 
                        class="mr-4 text-gray-400 hover:text-laser-purple transition-colors hover:animate-laser-glow">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <img
                            :src="currentUser.avatar_url"
                            alt="用户头像"
                            class="w-8 h-8 rounded-full object-cover border border-laser-purple/40"
                        />
                        <span class="ml-2 text-sm hidden md:inline">{{ currentUser.username }}</span>
                        <button @click="logout" class="ml-4 text-gray-400 hover:text-laser-purple transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- 内容区域 -->
            <div class="flex-1 overflow-y-auto bg-dark p-6 content-area">
                <!-- 任务创建面板 -->
                <div v-if="showCreator" class="max-w-4xl mx-auto" id="task-creator">
                    <!-- 任务类型选择 -->
                    <div class="mb-8 task-type-selection">
                        <div class="flex border-b border-laser-purple/30 task-type-buttons">
                            <button
                                v-for="taskType in availableTaskTypes"
                                :key="taskType"
                                @click="selectTask(taskType)"
                                class="task-type-btn"
                                :class="getTaskTypeBtnClass(taskType)"
                            >
                                <i :class="getTaskTypeIcon(taskType)" class="mr-2"></i>
                                {{ getTaskTypeName(taskType) }}
                            </button>
                        </div>
                    </div>

                    <!-- 模型选择 -->
                    <div v-if="selectedTaskId" class="mb-6">
                        <label class="block text-sm text-gray-400 mb-2">选择模型</label>
                        <div class="model-selection">
                            <button
                                v-for="model in availableModelClasses"
                                :key="model"
                                @click="selectModel(model)"
                                class="model-btn px-4 py-2 rounded-lg text-sm transition-all"
                                :class="getModelBtnClass(model)"
                            >
                                <i v-if="model === taskForm.model_cls" class="fas fa-star text-yellow-400 mr-1"></i>
                                {{ model }}
                            </button>
                        </div>
                    </div>

                    <!-- 上传区域 -->
                    <div v-if="selectedTaskId === 'i2v' || selectedTaskId === 'digital_human'" class="upload-section">
                        <!-- 上传图片 -->
                        <div v-if="selectedTaskId === 'i2v' || selectedTaskId === 'digital_human'" class="upload-area" @click="triggerImageUpload">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt text-laser-purple text-xl"></i>
                            </div>
                            <h3 class="font-medium mb-1">上传参考图片</h3>
                            <p class="text-xs text-gray-400 mb-4">支持JPG、PNG格式，大小不超过10MB</p>
                            <button class="text-xs btn-primary px-4 py-1.5 rounded-lg transition-all">选择图片</button>
                            <input 
                                type="file" 
                                ref="imageInput" 
                                @change="handleImageUpload" 
                                accept="image/*" 
                                style="display: none;">
                        </div>
                        
                        <!-- 上传音频 -->
                        <div v-if="selectedTaskId === 'digital_human'" class="upload-area" @click="triggerAudioUpload">
                            <div class="upload-icon">
                                <i class="fas fa-microphone text-laser-purple text-xl"></i>
                            </div>
                            <h3 class="font-medium mb-1">上传音频</h3>
                            <p class="text-xs text-gray-400 mb-4">支持MP3、WAV格式，最长支持120s</p>
                            <button class="text-xs btn-primary px-4 py-1.5 rounded-lg transition-all">上传音频</button>
                            <input 
                                type="file" 
                                ref="audioInput" 
                                @change="handleAudioUpload" 
                                accept="audio/*" 
                                style="display: none;">
                        </div>

                        <!-- 图片预览 -->
                        <div v-if="imagePreview" class="image-preview">
                            <img :src="imagePreview" alt="预览图片" class="w-full h-32 object-cover rounded-lg">
                            <button type="button" class="btn-close" @click="removeImage">×</button>
                        </div>

                        <!-- 音频预览 -->
                        <div v-if="audioPreview" class="audio-preview">
                            <audio controls class="w-full">
                                <source :src="audioPreview" type="audio/mpeg">
                            </audio>
                            <button type="button" class="btn-close" @click="removeAudio">×</button>
                        </div>
                    </div>

                    <!-- 提示词输入 -->
                    <div class="mb-6 prompt-input-section">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm text-gray-400">提示词</label>
                            <div class="flex space-x-2">
                                <button class="text-xs text-gray-400 hover:text-laser-purple transition-colors hover:animate-laser-glow" title="提示词模板">
                                    <i class="fas fa-magic"></i>
                                </button>
                                <button class="text-xs text-gray-400 hover:text-laser-purple transition-colors hover:animate-laser-glow" title="历史记录">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                        </div>
                        <div class="relative">
                            <textarea
                                v-model="taskForm.prompt"
                                class="w-full bg-dark-light border border-laser-purple/40 rounded-lg p-4 pr-16 text-sm min-h-[120px] focus:outline-none focus:ring-2 focus:ring-laser-purple/60 transition-all resize-none scrollbar-thin focus:border-laser focus:shadow-laser prompt-textarea"
                                :placeholder="getPromptPlaceholder()"
                                rows="3"
                                required
                            ></textarea>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">最多支持500个字符</p>
                            <div class="flex space-x-2">
                                <button @click="clearPrompt" class="text-xs btn-primary px-3 py-1 rounded transition-all">
                                    <i class="fas fa-sync-alt mr-1"></i>
                                    清空
                                </button>
                                <button @click="submitTask" :disabled="submitting" class="text-xs btn-primary px-4 py-1 rounded transition-all">
                                    <i class="fas fa-play mr-1"></i>
                                    {{ submitting ? '生成中...' : '生成视频' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 任务详情显示面板 -->
                <div v-if="selectedTask && !showCreator" class="max-w-4xl mx-auto task-detail-panel">
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium">{{ selectedTask.params.prompt || '任务详情' }}</h3>
                            <div class="flex space-x-3">
                                <button @click="showTaskCreator" class="text-sm btn-primary px-3 py-1.5 rounded-lg transition-all">
                                    <i class="fas fa-plus mr-1"></i>
                                    新建任务
                                </button>
                            </div>
                        </div>

                        <!-- 任务状态显示 -->
                        <div class="bg-secondary/30 rounded-xl p-6 mb-6">
                            <h4 class="text-sm font-medium mb-3 flex items-center">
                                <i class="fas fa-info-circle text-laser-purple mr-2"></i>
                                任务信息
                            </h4>
                            <ul class="space-y-2 text-sm">
                                <li class="flex justify-between">
                                    <span class="text-gray-400">任务ID</span>
                                    <span>{{ selectedTask.task_id }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span class="text-gray-400">任务类型</span>
                                    <span>{{ selectedTask.task_type }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span class="text-gray-400">模型名称</span>
                                    <span class="text-laser-purple">{{ selectedTask.model_cls }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span class="text-gray-400">创建时间</span>
                                    <span>{{ formatTime(selectedTask.create_t) }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span class="text-gray-400">状态</span>
                                    <span :class="getStatusTextClass(selectedTask.status)">{{ selectedTask.status }}</span>
                                </li>
                            </ul>
                        </div>

                        <!-- 提示词 -->
                        <div class="bg-secondary/30 rounded-xl p-4 mb-6">
                            <h4 class="text-sm font-medium mb-3 flex items-center">
                                <i class="fas fa-file-alt text-laser-purple mr-2"></i>
                                提示词
                            </h4>
                            <div class="bg-dark-light rounded-lg p-4 text-sm text-gray-300">
                                <p>{{ selectedTask.params.prompt || '无提示词' }}</p>
                            </div>
                        </div>

                        <!-- 输出结果 -->
                        <div v-if="selectedTask.outputs && Object.keys(selectedTask.outputs).length > 0" class="bg-secondary/30 rounded-xl p-4 mb-6">
                            <h4 class="text-sm font-medium mb-3 flex items-center">
                                <i class="fas fa-video text-laser-purple mr-2"></i>
                                输出结果
                            </h4>
                            <div class="space-y-3">
                                <div v-for="(output, key) in selectedTask.outputs" :key="key" class="flex items-center justify-between bg-dark-light rounded-lg p-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-video text-laser-purple mr-2"></i>
                                        <span class="text-sm">{{ key }}: {{ output }}</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="viewSingleResult(selectedTask.task_id, key, output)" class="text-xs btn-primary px-2 py-1 rounded">
                                            <i class="fas fa-eye mr-1"></i>查看
                                        </button>
                                        <button @click="downloadSingleResult(selectedTask.task_id, key, output)" class="text-xs btn-primary px-2 py-1 rounded">
                                            <i class="fas fa-download mr-1"></i>下载
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 任务操作 -->
                        <div class="flex justify-center space-x-3">
                            <button v-if="['CREATED', 'PENDING', 'RUNNING'].includes(selectedTask.status)" 
                                    @click="cancelTask(selectedTask.task_id)" 
                                    class="px-4 py-2 btn-primary rounded-lg text-sm transition-all">
                                <i class="fas fa-times mr-2"></i>
                                取消任务
                            </button>
                            <button v-if="['SUCCEED', 'FAILED', 'CANCEL'].includes(selectedTask.status)" 
                                    @click="resumeTask(selectedTask.task_id)" 
                                    class="px-4 py-2 btn-primary rounded-lg text-sm transition-all">
                                <i class="fas fa-redo mr-2"></i>
                                重新生成
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 加载指示器 -->
        <div v-if="loading" class="loading position-fixed top-50 start-50 translate-middle show">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>

        <!-- 提示消息 -->
        <div v-if="alert.show" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999;">
            <div :class="`alert alert-${alert.type} alert-dismissible fade show`" role="alert">
                {{ alert.message }}
                <button type="button" class="btn-close" @click="alert.show = false"></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // 响应式数据
                const isLoggedIn = ref(true);
                const loading = ref(false);
                const submitting = ref(false);
                const showCreator = ref(true);
                const searchQuery = ref('');
                const currentUser = ref({
                    username: "测试用户",
                    avatar_url: "https://via.placeholder.com/32x32",
                    user_id: "test_user_001"
                });
                const models = ref([
                    {
                        task: "t2v",
                        model_cls: "Wan2.1",
                        stage: "step_distill"
                    },
                    {
                        task: "i2v",
                        model_cls: "Wan2.1",
                        stage: "step_distill"
                    },
                    {
                        task: "t2v",
                        model_cls: "Wan2.2",
                        stage: "original"
                    },
                    {
                        task: "digital_human",
                        model_cls: "Wan2.1-DigitalHuman",
                        stage: "step_distill"
                    }
                ]);
                const tasks = ref([
                    {
                        task_id: "test-001",
                        task_type: "t2v",
                        model_cls: "Wan2.1",
                        stage: "step_distill",
                        status: "SUCCEED",
                        params: {
                            prompt: "一只可爱的小猫在花园里玩耍",
                            seed: 42
                        },
                        create_t: "1704067200",
                        outputs: {
                            video: "test_video.mp4"
                        }
                    },
                    {
                        task_id: "test-002",
                        task_type: "i2v",
                        model_cls: "Wan2.1",
                        stage: "step_distill",
                        status: "RUNNING",
                        params: {
                            prompt: "城市夜景",
                            seed: 123
                        },
                        create_t: "1704070800",
                        outputs: {}
                    }
                ]);
                const alert = ref({ show: false, message: '', type: 'info' });
                const selectedTaskId = ref(null);
                const selectedTask = ref(null);
                const statusFilter = ref('ALL');
                const pagination = ref(null);
                const currentPage = ref(1);
                const pageSize = ref(10);

                const taskForm = ref({
                    task: '',
                    model_cls: '',
                    stage: 'step_distill',
                    imageFile: null,
                    audioFile: null,
                    prompt: '',
                    seed: 42
                });

                const imagePreview = ref(null);
                const audioPreview = ref(null);

                // 计算属性
                const availableTaskTypes = computed(() => {
                    return [...new Set(models.value.map(m => m.task))];
                });

                const availableModelClasses = computed(() => {
                    if (!taskForm.value.task) return [];
                    return [...new Set(models.value
                        .filter(m => m.task === taskForm.value.task)
                        .map(m => m.model_cls))];
                });

                const filteredTasks = computed(() => {
                    if (!searchQuery.value) return tasks.value;
                    return tasks.value.filter(task => 
                        task.params.prompt?.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                        task.task_id.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                        task.task_type.toLowerCase().includes(searchQuery.value.toLowerCase())
                    );
                });

                // 方法
                const showAlert = (message, type = 'info') => {
                    alert.value = { show: true, message, type };
                    setTimeout(() => {
                        alert.value.show = false;
                    }, 5000);
                };

                const setLoading = (value) => {
                    loading.value = value;
                };

                const apiCall = async (endpoint, options = {}) => {
                    const url = `${endpoint}`;
                    const headers = {
                        'Content-Type': 'application/json',
                        ...options.headers
                    };

                    if (localStorage.getItem('accessToken')) {
                        headers['Authorization'] = `Bearer ${localStorage.getItem('accessToken')}`;
                    }

                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (response.status === 401) {
                        logout();
                        throw new Error('认证失败，请重新登录');
                    }
                    if (response.status === 400) {
                        const error = await response.json();
                        showAlert(error.message, 'danger');
                        throw new Error(error.message);
                    }

                    await new Promise(resolve => setTimeout(resolve, 50));
                    return response;
                };

                const logout = () => {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('currentUser');
                    currentUser.value = {};
                    isLoggedIn.value = false;
                    models.value = [];
                    tasks.value = [];
                };

                const loadModels = async () => {
                    try {
                        const response = await apiCall('./api/v1/model/list');
                        if (response.ok) {
                            const data = await response.json();
                            models.value = data.models || [];
                        } else {
                            showAlert('加载模型列表失败', 'danger');
                        }
                    } catch (error) {
                        showAlert(`加载模型失败: ${error.message}`, 'danger');
                    }
                };

                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    taskForm.value.imageFile = file;
                    
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.value = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.value = null;
                    }
                };

                const selectTask = (taskType) => {
                    selectedTaskId.value = taskType;
                    taskForm.value.task = taskType;
                    taskForm.value.model_cls = '';
                    taskForm.value.prompt = '';
                    imagePreview.value = null;
                    audioPreview.value = null;
                    taskForm.value.imageFile = null;
                    taskForm.value.audioFile = null;
                };

                const selectModel = (model) => {
                    taskForm.value.model_cls = model;
                };

                const triggerImageUpload = () => {
                    document.querySelector('input[type="file"][accept="image/*"]').click();
                };

                const triggerAudioUpload = () => {
                    document.querySelector('input[type="file"][accept="audio/*"]').click();
                };

                const removeImage = () => {
                    imagePreview.value = null;
                    taskForm.value.imageFile = null;
                };

                const removeAudio = () => {
                    audioPreview.value = null;
                    taskForm.value.audioFile = null;
                };

                const handleAudioUpload = (event) => {
                    const file = event.target.files[0];
                    taskForm.value.audioFile = file;
                    
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            audioPreview.value = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        audioPreview.value = null;
                    }
                };

                const submitTask = async () => {
                    try {
                        setLoading(true);
                        submitting.value = true;
                        
                        var formData = {
                            task: taskForm.value.task,
                            model_cls: taskForm.value.model_cls,
                            stage: taskForm.value.stage,
                            prompt: taskForm.value.prompt,
                            seed: taskForm.value.seed
                        };
                        if (taskForm.value.model_cls.startsWith('wan2.1')) {
                            formData.negative_prompt = "镜头晃动，色调艳丽，过曝，静态，细节模糊不清，字幕，风格，作品，画作，画面，静止，整体发灰，最差质量，低质量，JPEG压缩残留，丑陋的，残缺的，多余的手指，画得不好的手部，画得不好的脸部，畸形的，毁容的，形态畸形的肢体，手指融合，静止不动的画面，杂乱的背景，三条腿，背景人很多，倒着走"
                        }

                        if (taskForm.value.task === 'i2v' && taskForm.value.imageFile) {
                            const base64 = await fileToBase64(taskForm.value.imageFile);
                            formData.input_image = {
                                type: 'base64',
                                data: base64
                            };
                        }

                        if (taskForm.value.task === 'digital_human') {
                            if (taskForm.value.imageFile) {
                                const base64 = await fileToBase64(taskForm.value.imageFile);
                                formData.input_image = {
                                    type: 'base64',
                                    data: base64
                                };
                            }
                            if (taskForm.value.audioFile) {
                                const base64 = await fileToBase64(taskForm.value.audioFile);
                                formData.input_audio = {
                                    type: 'base64',
                                    data: base64
                                };
                            }
                        }

                        const response = await apiCall('./api/v1/task/submit', {
                            method: 'POST',
                            body: JSON.stringify(formData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showAlert(`任务提交成功！任务ID: ${result.task_id}`, 'success');
                            await refreshTasks();
                            selectedTaskId.value = null;
                            showCreator.value = true;
                        } else {
                            const error = await response.json();
                            showAlert(`任务提交失败: ${error.message}`, 'danger');
                        }
                    } catch (error) {
                        showAlert(`提交任务失败: ${error.message}`, 'danger');
                    } finally {
                        submitting.value = false;
                        setLoading(false);
                    }
                };

                const fileToBase64 = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = error => reject(error);
                    });
                };

                const formatTime = (timestamp) => {
                    if (!timestamp) return '';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString('zh-CN');
                };

                const refreshTasks = async () => {
                    try {
                        const params = new URLSearchParams({
                            page: currentPage.value.toString(),
                            page_size: pageSize.value.toString()
                        });

                        if (statusFilter.value !== 'ALL') {
                            params.append('status', statusFilter.value);
                        }

                        const response = await apiCall(`./api/v1/task/list?${params.toString()}`);
                        if (response.ok) {
                            const data = await response.json();
                            tasks.value = data.tasks || [];
                            pagination.value = data.pagination || null;
                        } else {
                            showAlert('刷新任务列表失败', 'danger');
                        }
                    } catch (error) {
                        showAlert(`刷新任务列表失败: ${error.message}`, 'danger');
                    }
                };

                const getStatusBadgeClass = (status) => {
                    const statusMap = {
                        'SUCCEED': 'bg-success',
                        'FAILED': 'bg-danger',
                        'RUNNING': 'bg-warning',
                        'PENDING': 'bg-secondary',
                        'CREATED': 'bg-secondary'
                    };
                    return statusMap[status] || 'bg-secondary';
                };

                const downloadSingleResult = async (taskId, key, outputPath) => {
                    try {
                        setLoading(true);
                        const response = await apiCall(`./api/v1/task/result?task_id=${taskId}&name=${key}`);
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${outputPath}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            showAlert('获取结果失败', 'danger');
                        }
                    } catch (error) {
                        showAlert(`下载结果失败: ${error.message}`, 'danger');
                    } finally {
                        setLoading(false);
                    }
                };

                const viewSingleResult = async (taskId, key, outputPath) => {
                    try {
                        setLoading(true);
                        const response = await apiCall(`./api/v1/task/result?task_id=${taskId}&name=${key}`);
                        if (response.ok) {
                            const blob = await response.blob();
                            const videoBlob = new Blob([blob], { type: 'video/mp4' });
                            const url = window.URL.createObjectURL(videoBlob);
                            window.open(url, '_blank');
                        } else {
                            showAlert('获取结果失败', 'danger');
                        }
                    } catch (error) {
                        showAlert(`查看结果失败: ${error.message}`, 'danger');
                    } finally {
                        setLoading(false);
                    }
                };

                const cancelTask = async (taskId) => {
                    try {
                        const response = await apiCall(`./api/v1/task/cancel?task_id=${taskId}`);
                        if (response.ok) {
                            showAlert('任务取消成功', 'success');
                            await refreshTasks();
                        } else {
                            const error = await response.json();
                            showAlert(`取消任务失败: ${error.message}`, 'danger');
                        }
                    } catch (error) {
                        showAlert(`取消任务失败: ${error.message}`, 'danger');
                    }
                };

                const resumeTask = async (taskId) => {
                    try {
                        const response = await apiCall(`./api/v1/task/resume?task_id=${taskId}`);
                        if (response.ok) {
                            showAlert('任务重试成功', 'success');
                            await refreshTasks();
                        } else {
                            const error = await response.json();
                            showAlert(`重试任务失败: ${error.message}`, 'danger');
                        }
                    } catch (error) {
                        showAlert(`重试任务失败: ${error.message}`, 'danger');
                    }
                };

                const viewTaskDetail = async (taskId) => {
                    try {
                        setLoading(true);
                        const response = await apiCall(`./api/v1/task/detail?task_id=${taskId}`);
                        if (response.ok) {
                            const data = await response.json();
                            selectedTask.value = data;
                            selectedTaskId.value = data.task_type;
                            showCreator.value = false;
                        } else {
                            showAlert('获取任务详情失败', 'danger');
                        }
                    } catch (error) {
                        showAlert(`查看任务详情失败: ${error.message}`, 'danger');
                    } finally {
                        setLoading(false);
                    }
                };

                const showTaskCreator = () => {
                    showCreator.value = true;
                    selectedTask.value = null;
                    selectedTaskId.value = null;
                };

                const toggleSidebar = () => {
                    const sidebar = document.querySelector('aside');
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-0');
                    sidebar.classList.toggle('hidden');
                };

                const clearPrompt = () => {
                    taskForm.value.prompt = '';
                };

                const getTaskItemClass = (status) => {
                    if (status === 'SUCCEED') return 'bg-laser-purple/15 border border-laser-purple/30';
                    if (status === 'RUNNING') return 'bg-laser-purple/15 border border-laser-purple/30';
                    if (status === 'FAILED') return 'bg-red-500/15 border border-red-500/30';
                    return 'bg-dark-light border border-gray-700';
                };

                const getStatusIndicatorClass = (status) => {
                    if (status === 'SUCCEED') return 'w-3 h-3 bg-gradient-to-r from-emerald-400 to-green-500 rounded-full shadow-lg shadow-emerald-400/50';
                    if (status === 'RUNNING') return 'w-3 h-3 bg-gradient-to-r from-amber-400 to-yellow-500 rounded-full shadow-lg shadow-amber-400/50 animate-pulse';
                    if (status === 'FAILED') return 'w-3 h-3 bg-gradient-to-r from-red-400 to-pink-500 rounded-full shadow-lg shadow-red-400/50';
                    return 'w-3 h-3 bg-gradient-to-r from-gray-400 to-gray-500 rounded-full shadow-lg shadow-gray-400/50';
                };

                const getTaskTypeBtnClass = (taskType) => {
                    if (selectedTaskId.value === taskType) {
                        return 'text-laser-purple border-b-2 border-laser-purple';
                    }
                    return 'text-gray-400 hover:text-laser-purple';
                };

                const getModelBtnClass = (model) => {
                    if (taskForm.value.model_cls === model) {
                        return 'bg-laser-purple/20 border border-laser-purple/40 active shadow-laser animate-electric-pulse';
                    }
                    return 'bg-dark-light border border-gray-700 hover:bg-laser-purple/15 hover:border-laser-purple/40 transition-all hover:shadow-laser';
                };

                const getTaskTypeIcon = (taskType) => {
                    const iconMap = {
                        't2v': 'fas fa-font',
                        'i2v': 'fas fa-image',
                        'digital_human': 'fas fa-user'
                    };
                    return iconMap[taskType] || 'fas fa-video';
                };

                const getTaskTypeName = (taskType) => {
                    const nameMap = {
                        't2v': '文生视频',
                        'i2v': '图生视频',
                        'digital_human': '数字人'
                    };
                    return nameMap[taskType] || taskType;
                };

                const getPromptPlaceholder = () => {
                    if (selectedTaskId.value === 't2v') {
                        return '请输入视频生成提示词，描述视频内容、风格、场景等...';
                    } else if (selectedTaskId.value === 'i2v') {
                        return '请输入视频生成提示词，描述基于图片的视频内容、动作要求等...';
                    } else if (selectedTaskId.value === 'digital_human') {
                        return '请输入视频生成提示词，描述数字人形象、背景风格、动作要求等...';
                    }
                    return '请输入视频生成提示词...';
                };

                const getStatusTextClass = (status) => {
                    if (status === 'SUCCEED') return 'text-emerald-400';
                    if (status === 'RUNNING') return 'text-amber-400';
                    if (status === 'FAILED') return 'text-red-400';
                    return 'text-gray-400';
                };

                const getVideoThumbnail = (videoPath) => {
                    // 这里可以根据视频路径生成缩略图
                    // 暂时返回一个占位符
                    return 'https://via.placeholder.com/64x48/9a72ff/ffffff?text=Video';
                };

                const initModelAndTasks = async () => {
                    await loadModels();
                    await refreshTasks();
                };

                // 监听器
                watch(() => taskForm.value.task, () => {
                    taskForm.value.model_cls = '';
                    taskForm.value.stage = '';
                    
                    const availableModels = models.value.filter(m => m.task === taskForm.value.task);
                    if (availableModels.length > 0) {
                        const firstModel = availableModels[0];
                        taskForm.value.model_cls = firstModel.model_cls;
                        taskForm.value.stage = firstModel.stage;
                    }
                    
                    imagePreview.value = null;
                    taskForm.value.imageFile = null;
                });

                watch(() => taskForm.value.model_cls, () => {
                    taskForm.value.stage = '';
                    
                    const availableStages = models.value
                        .filter(m => m.task === taskForm.value.task && m.model_cls === taskForm.value.model_cls)
                        .map(m => m.stage);
                    if (availableStages.length > 0) {
                        taskForm.value.stage = availableStages[0];
                    }
                });

                // 生命周期
                onMounted(() => {
                    console.log('页面加载完成，显示测试数据');
                    console.log('当前用户:', currentUser.value);
                    console.log('可用模型:', models.value);
                    console.log('任务列表:', tasks.value);
                });

                return {
                    isLoggedIn,
                    loading,
                    submitting,
                    showCreator,
                    searchQuery,
                    currentUser,
                    models,
                    tasks,
                    alert,
                    taskForm,
                    imagePreview,
                    audioPreview,
                    availableTaskTypes,
                    availableModelClasses,
                    filteredTasks,
                    selectedTaskId,
                    selectedTask,
                    statusFilter,
                    pagination,
                    currentPage,
                    pageSize,
                    showAlert,
                    setLoading,
                    apiCall,
                    logout,
                    loadModels,
                    handleImageUpload,
                    selectTask,
                    selectModel,
                    triggerImageUpload,
                    triggerAudioUpload,
                    removeImage,
                    removeAudio,
                    handleAudioUpload,
                    submitTask,
                    fileToBase64,
                    formatTime,
                    refreshTasks,
                    getStatusBadgeClass,
                    downloadSingleResult,
                    viewSingleResult,
                    cancelTask,
                    resumeTask,
                    viewTaskDetail,
                    showTaskCreator,
                    toggleSidebar,
                    clearPrompt,
                    getTaskItemClass,
                    getStatusIndicatorClass,
                    getTaskTypeBtnClass,
                    getModelBtnClass,
                    getTaskTypeIcon,
                    getTaskTypeName,
                    getPromptPlaceholder,
                    getStatusTextClass,
                    getVideoThumbnail
                };
            }
        }).mount('#app');
    </script>
</body>
</html>